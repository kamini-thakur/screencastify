"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(o,i){try{var a=t[o](i),c=a.value}catch(u){return void r(u)}return a.done?void e(c):Promise.resolve(c).then(function(e){n("next",e)},function(e){n("throw",e)})}return n("next")})}}var _get=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_slicedToArray=function(){function e(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var a,c=e[Symbol.iterator]();!(n=(a=c.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(u){o=!0,i=u}finally{try{!n&&c["return"]&&c["return"]()}finally{if(o)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e};!function(){function e(){var e=document.createElement("div");document.body.appendChild(e),angular.bootstrap(e,["castifyExt.bgApp"],{strictDi:!1})}var t={scope:{},getGlobal:function(e){return"undefined"!=typeof window&&window===e?e:"undefined"!=typeof global?global:e}};t.global=t.getGlobal(this),t.initSymbol=function(){t.global.Symbol||(t.global.Symbol=t.Symbol),t.initSymbol=function(){}},t.symbolCounter_=0,t.Symbol=function(e){return"jscomp_symbol_"+e+t.symbolCounter_++},t.initSymbolIterator=function(){t.initSymbol(),t.global.Symbol.iterator||(t.global.Symbol.iterator=t.global.Symbol("iterator")),t.initSymbolIterator=function(){}},t.makeIterator=function(e){if(t.initSymbolIterator(),e[t.global.Symbol.iterator])return e[t.global.Symbol.iterator]();if(!(e instanceof Array||"string"==typeof e||e instanceof String))throw new TypeError(e+" is not iterable");var r=0;return{next:function(){return r==e.length?{done:!0}:{done:!1,value:e[r++]}}}},t.arrayFromIterator=function(e){for(var t,r=[];!(t=e.next()).done;)r.push(t.value);return r},t.arrayFromIterable=function(e){return e instanceof Array?e:t.arrayFromIterator(t.makeIterator(e))},t.arrayFromArguments=function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r]);return t},t.inherits=function(e,r){function n(){}n.prototype=r.prototype,e.prototype=new n,e.prototype.constructor=e;for(var o in r)if(t.global.Object.defineProperties){var i=t.global.Object.getOwnPropertyDescriptor(r,o);t.global.Object.defineProperty(e,o,i)}else e[o]=r[o]},t.array=t.array||{},t.array.done_=function(){return{done:!0,value:void 0}},t.array.arrayIterator_=function(e,r){e instanceof String&&(e=String(e));var n=0;t.initSymbol(),t.initSymbolIterator();var o={},i=(o.next=function(){if(n<e.length){var o=n++;return{value:r(o,e[o]),done:!1}}return i.next=t.array.done_,t.array.done_()},o[Symbol.iterator]=function(){return i},o);return i},t.array.findInternal_=function(e,t,r){e instanceof String&&(e=String(e));for(var n=e.length,o=0;o<n;o++){var i=e[o];if(t.call(r,i,o,e))return{i:o,v:i}}return{i:-1,v:void 0}},t.array.from=function(e,r,n){r=void 0===r?function(e){return e}:r;var o=[];if(t.initSymbol(),t.initSymbolIterator(),e[Symbol.iterator]){t.initSymbol(),t.initSymbolIterator(),e=e[Symbol.iterator]();for(var i;!(i=e.next()).done;)o.push(r.call(n,i.value))}else{i=e.length;for(var a=0;a<i;a++)o.push(r.call(n,e[a]))}return o},t.array.of=function(e){for(var r=[],n=0;n<arguments.length;++n)r[n-0]=arguments[n];return t.array.from(r)},t.array.entries=function(){return t.array.arrayIterator_(this,function(e,t){return[e,t]})},t.array.entries$install=function(){Array.prototype.entries||(Array.prototype.entries=t.array.entries)},t.array.keys=function(){return t.array.arrayIterator_(this,function(e){return e})},t.array.keys$install=function(){Array.prototype.keys||(Array.prototype.keys=t.array.keys)},t.array.values=function(){return t.array.arrayIterator_(this,function(e,t){return t})},t.array.values$install=function(){Array.prototype.values||(Array.prototype.values=t.array.values)},t.array.copyWithin=function(e,t,r){var n=this.length;if(e=Number(e),t=Number(t),r=Number(null!=r?r:n),e<t)for(r=Math.min(r,n);t<r;)t in this?this[e++]=this[t++]:(delete this[e++],t++);else for(r=Math.min(r,n+t-e),e+=r-t;r>t;)--r in this?this[--e]=this[r]:delete this[e];return this},t.array.copyWithin$install=function(){Array.prototype.copyWithin||(Array.prototype.copyWithin=t.array.copyWithin)},t.array.fill=function(e,t,r){for(null!=r&&e.length||(r=this.length||0),r=Number(r),t=Number((void 0===t?0:t)||0);t<r;t++)this[t]=e;return this},t.array.fill$install=function(){Array.prototype.fill||(Array.prototype.fill=t.array.fill)},t.array.find=function(e,r){return t.array.findInternal_(this,e,r).v},t.array.find$install=function(){Array.prototype.find||(Array.prototype.find=t.array.find)},t.array.findIndex=function(e,r){return t.array.findInternal_(this,e,r).i},t.array.findIndex$install=function(){Array.prototype.findIndex||(Array.prototype.findIndex=t.array.findIndex)},t.Map=function(e){if(e=void 0===e?[]:e,this.data_={},this.head_=t.Map.createHead_(),this.size=0,e){e=t.makeIterator(e);for(var r=e.next();!r.done;r=e.next())r=r.value,this.set(r[0],r[1])}},t.Map.checkBrowserConformance_=function(){var e=t.global.Map;if(!e||!e.prototype.entries||!Object.seal)return!1;try{var r=Object.seal({x:4}),n=new e(t.makeIterator([[r,"s"]]));if("s"!=n.get(r)||1!=n.size||n.get({x:4})||n.set({x:4},"t")!=n||2!=n.size)return!1;var o=n.entries(),i=o.next();return!i.done&&i.value[0]==r&&"s"==i.value[1]&&(i=o.next(),!(i.done||4!=i.value[0].x||"t"!=i.value[1]||!o.next().done))}catch(a){return!1}},t.Map.createHead_=function(){var e={};return e.previous=e.next=e.head=e},t.Map.getId_=function(e){return e instanceof Object?(t.Map.key_ in e||e instanceof Object&&Object.isExtensible&&Object.isExtensible(e)&&t.Map.defineProperty_(e,t.Map.key_,++t.Map.index_),t.Map.key_ in e?e[t.Map.key_]:" "+e):String(e)},t.Map.prototype.set=function(e,t){var r=this.maybeGetEntry_(e),n=r.id,o=r.list,r=r.entry;return o||(o=this.data_[n]=[]),r?r.value=t:(r={next:this.head_,previous:this.head_.previous,head:this.head_,key:e,value:t},o.push(r),this.head_.previous.next=r,this.head_.previous=r,this.size++),this},t.Map.prototype["delete"]=function(e){var t=this.maybeGetEntry_(e);e=t.id;var r=t.list,n=t.index;return!(!(t=t.entry)||!r)&&(r.splice(n,1),r.length||delete this.data_[e],t.previous.next=t.next,t.next.previous=t.previous,t.head=null,this.size--,!0)},t.Map.prototype.clear=function(){this.data_={},this.head_=this.head_.previous=t.Map.createHead_(),this.size=0},t.Map.prototype.has=function(e){return!!this.maybeGetEntry_(e).entry},t.Map.prototype.get=function(e){return(e=this.maybeGetEntry_(e).entry)&&e.value},t.Map.prototype.maybeGetEntry_=function(e){var r=t.Map.getId_(e),n=this.data_[r];if(n)for(var o=0;o<n.length;o++){var i=n[o];if(e!==e&&i.key!==i.key||e===i.key)return{id:r,list:n,index:o,entry:i}}return{id:r,list:n,index:-1,entry:void 0}},t.Map.prototype.entries=function(){return this.iter_(function(e){return[e.key,e.value]})},t.Map.prototype.keys=function(){return this.iter_(function(e){return e.key})},t.Map.prototype.values=function(){return this.iter_(function(e){return e.value})},t.Map.prototype.forEach=function(e,r){for(var n=t.makeIterator(this.entries()),o=n.next();!o.done;o=n.next())o=o.value,e.call(r,o[1],o[0],this)},t.Map.prototype.iter_=function(e){var r=this,n=this.head_;t.initSymbol(),t.initSymbolIterator();var o={};return o.next=function(){if(n){for(;n.head!=r.head_;)n=n.previous;for(;n.next!=n.head;)return n=n.next,{done:!1,value:e(n)};n=null}return{done:!0,value:void 0}},o[Symbol.iterator]=function(){return this},o},t.Map.index_=0,t.Map.defineProperty_=Object.defineProperty?function(e,t,r){Object.defineProperty(e,t,{value:String(r)})}:function(e,t,r){e[t]=String(r)},t.Map.Entry_=function(){},t.Map.ASSUME_NO_NATIVE=!1,t.Map$install=function(){t.initSymbol(),t.initSymbolIterator(),!t.Map.ASSUME_NO_NATIVE&&t.Map.checkBrowserConformance_()?t.Map=t.global.Map:(t.initSymbol(),t.initSymbolIterator(),t.Map.prototype[Symbol.iterator]=t.Map.prototype.entries,t.initSymbol(),t.Map.key_=Symbol("map-id-key")),t.Map$install=function(){}},t.math=t.math||{},t.math.clz32=function(e){if(e=Number(e)>>>0,0===e)return 32;var t=0;return 0===(4294901760&e)&&(e<<=16,t+=16),0===(4278190080&e)&&(e<<=8,t+=8),0===(4026531840&e)&&(e<<=4,t+=4),0===(3221225472&e)&&(e<<=2,t+=2),0===(2147483648&e)&&t++,t},t.math.imul=function(e,t){e=Number(e),t=Number(t);var r=65535&e,n=65535&t;return r*n+((e>>>16&65535)*n+r*(t>>>16&65535)<<16>>>0)|0},t.math.sign=function(e){return e=Number(e),0===e||isNaN(e)?e:0<e?1:-1},t.math.log10=function(e){return Math.log(e)/Math.LN10},t.math.log2=function(e){return Math.log(e)/Math.LN2},t.math.log1p=function(e){if(e=Number(e),.25>e&&-.25<e){for(var t=e,r=1,n=e,o=0,i=1;o!=n;)t*=e,i*=-1,n=(o=n)+i*t/++r;return n}return Math.log(1+e)},t.math.expm1=function(e){if(e=Number(e),.25>e&&-.25<e){for(var t=e,r=1,n=e,o=0;o!=n;)t*=e/++r,n=(o=n)+t;return n}return Math.exp(e)-1},t.math.cosh=function(e){return e=Number(e),(Math.exp(e)+Math.exp(-e))/2},t.math.sinh=function(e){return e=Number(e),0===e?e:(Math.exp(e)-Math.exp(-e))/2},t.math.tanh=function(e){if(e=Number(e),0===e)return e;var t=Math.exp(2*-Math.abs(e)),t=(1-t)/(1+t);return 0>e?-t:t},t.math.acosh=function(e){return e=Number(e),Math.log(e+Math.sqrt(e*e-1))},t.math.asinh=function(e){if(e=Number(e),0===e)return e;var t=Math.log(Math.abs(e)+Math.sqrt(e*e+1));return 0>e?-t:t},t.math.atanh=function(e){return e=Number(e),(t.math.log1p(e)-t.math.log1p(-e))/2},t.math.hypot=function(e,r,n){for(var o=[],i=2;i<arguments.length;++i)o[i-2]=arguments[i];e=Number(e),r=Number(r);for(var a=Math.max(Math.abs(e),Math.abs(r)),c=t.makeIterator(o),i=c.next();!i.done;i=c.next())a=Math.max(a,Math.abs(i.value));if(1e100<a||1e-100>a){for(e/=a,r/=a,c=e*e+r*r,o=t.makeIterator(o),i=o.next();!i.done;i=o.next())i=i.value,i=Number(i)/a,c+=i*i;return Math.sqrt(c)*a}for(a=e*e+r*r,o=t.makeIterator(o),i=o.next();!i.done;i=o.next())i=i.value,a+=i*i;return Math.sqrt(a)},t.math.trunc=function(e){if(e=Number(e),isNaN(e)||1/0===e||-(1/0)===e||0===e)return e;var t=Math.floor(Math.abs(e));return 0>e?-t:t},t.math.cbrt=function(e){if(0===e)return e;e=Number(e);var t=Math.pow(Math.abs(e),1/3);return 0>e?-t:t},t.number=t.number||{},t.number.isFinite=function(e){return"number"==typeof e&&(!isNaN(e)&&1/0!==e&&-(1/0)!==e)},t.number.isInteger=function(e){return!!t.number.isFinite(e)&&e===Math.floor(e)},t.number.isNaN=function(e){return"number"==typeof e&&isNaN(e)},t.number.isSafeInteger=function(e){return t.number.isInteger(e)&&Math.abs(e)<=t.number.MAX_SAFE_INTEGER},t.number.EPSILON=Math.pow(2,-52),t.number.MAX_SAFE_INTEGER=9007199254740991,t.number.MIN_SAFE_INTEGER=-9007199254740991,t.object=t.object||{},t.object.assign=function(e,r){for(var n=[],o=1;o<arguments.length;++o)n[o-1]=arguments[o];for(n=t.makeIterator(n),o=n.next();!o.done;o=n.next()){var i,o=o.value;for(i in o)Object.prototype.hasOwnProperty.call(o,i)&&(e[i]=o[i])}return e},t.object.is=function(e,t){return e===t?0!==e||1/e===1/t:e!==e&&t!==t},t.Set=function(e){if(e=void 0===e?[]:e,this.map_=new t.Map,e){e=t.makeIterator(e);for(var r=e.next();!r.done;r=e.next())this.add(r.value)}this.size=this.map_.size},t.Set.checkBrowserConformance_=function(){var e=t.global.Set;if(!e||!e.prototype.entries||!Object.seal)return!1;var r=Object.seal({x:4}),e=new e(t.makeIterator([r]));if(e.has(r)||1!=e.size||e.add(r)!=e||1!=e.size||e.add({x:4})!=e||2!=e.size)return!1;var e=e.entries(),n=e.next();return!n.done&&n.value[0]==r&&n.value[1]==r&&(n=e.next(),!n.done&&n.value[0]!=r&&4==n.value[0].x&&n.value[1]==n.value[0]&&e.next().done)},t.Set.prototype.add=function(e){return this.map_.set(e,e),this.size=this.map_.size,this},t.Set.prototype["delete"]=function(e){return e=this.map_["delete"](e),this.size=this.map_.size,e},t.Set.prototype.clear=function(){this.map_.clear(),this.size=0},t.Set.prototype.has=function(e){return this.map_.has(e)},t.Set.prototype.entries=function(){return this.map_.entries()},t.Set.prototype.values=function(){return this.map_.values()},t.Set.prototype.forEach=function(e,t){var r=this;this.map_.forEach(function(n){return e.call(t,n,n,r)})},t.Set.ASSUME_NO_NATIVE=!1,t.Set$install=function(){!t.Set.ASSUME_NO_NATIVE&&t.Set.checkBrowserConformance_()?t.Set=t.global.Set:(t.Map$install(),t.initSymbol(),t.initSymbolIterator(),t.Set.prototype[Symbol.iterator]=t.Set.prototype.values),t.Set$install=function(){}},t.string=t.string||{},t.string.noRegExp_=function(e,t){if(e instanceof RegExp)throw new TypeError("First argument to String.prototype."+t+" must not be a regular expression")},t.string.fromCodePoint=function(e){for(var r=[],n=0;n<arguments.length;++n)r[n-0]=arguments[n];for(var n="",r=t.makeIterator(r),o=r.next();!o.done;o=r.next()){if(o=o.value,o=+o,0>o||1114111<o||o!==Math.floor(o))throw new RangeError("invalid_code_point "+o);65535>=o?n+=String.fromCharCode(o):(o-=65536,n+=String.fromCharCode(o>>>10&1023|55296),n+=String.fromCharCode(1023&o|56320))}return n},t.string.repeat=function(e){var t=this.toString();if(0>e||1342177279<e)throw new RangeError("Invalid count value");e|=0;for(var r="";e;)1&e&&(r+=t),(e>>>=1)&&(t+=t);return r},t.string.repeat$install=function(){String.prototype.repeat||(String.prototype.repeat=t.string.repeat)},t.string.codePointAt=function(e){var t=this.toString(),r=t.length;if(e=Number(e)||0,0<=e&&e<r){e|=0;var n=t.charCodeAt(e);return 55296>n||56319<n||e+1===r?n:(e=t.charCodeAt(e+1),56320>e||57343<e?n:1024*(n-55296)+e+9216)}},t.string.codePointAt$install=function(){String.prototype.codePointAt||(String.prototype.codePointAt=t.string.codePointAt)},t.string.includes=function(e,r){return r=void 0===r?0:r,t.string.noRegExp_(e,"includes"),-1!==this.toString().indexOf(e,r)},t.string.includes$install=function(){String.prototype.includes||(String.prototype.includes=t.string.includes)},t.string.startsWith=function(e,r){r=void 0===r?0:r,t.string.noRegExp_(e,"startsWith");var n=this.toString();e+="";for(var o=n.length,i=e.length,a=Math.max(0,Math.min(0|r,n.length)),c=0;c<i&&a<o;)if(n[a++]!=e[c++])return!1;return c>=i},t.string.startsWith$install=function(){String.prototype.startsWith||(String.prototype.startsWith=t.string.startsWith)},t.string.endsWith=function(e,r){t.string.noRegExp_(e,"endsWith");var n=this.toString();e+="",void 0===r&&(r=n.length);for(var o=Math.max(0,Math.min(0|r,n.length)),i=e.length;0<i&&0<o;)if(n[--o]!=e[--i])return!1;return 0>=i},t.string.endsWith$install=function(){String.prototype.endsWith||(String.prototype.endsWith=t.string.endsWith)},function(e){function t(e,t,r,n){if("string"!=typeof e)throw"System.register provided no module name";t="boolean"==typeof r?{declarative:!1,deps:t,execute:n,executingRequire:r}:{declarative:!0,deps:t,declare:r},t.name=e,e in u||(u[e]=t),e=t.deps,r=[],n=0;for(var o=e.length;n<o;n++)-1==s.call(r,e[n])&&r.push(e[n]);t.deps=r,t.normalizedDeps=t.deps}function r(e,t){if(t[e.groupIndex]=t[e.groupIndex]||[],-1==s.call(t[e.groupIndex],e)){t[e.groupIndex].push(e);for(var n=0,o=e.normalizedDeps.length;n<o;n++){var i=u[e.normalizedDeps[n]];if(i&&!i.evaluated){var a=e.groupIndex+(i.declarative!=e.declarative);if(void 0===i.groupIndex||i.groupIndex<a){if(void 0!==i.groupIndex&&(t[i.groupIndex].splice(s.call(t[i.groupIndex],i),1),0==t[i.groupIndex].length))throw new TypeError("Mixed dependency cycle detected");i.groupIndex=a}r(i,t)}}}}function n(e){return l[e]||(l[e]={name:e,dependencies:[],exports:{},importers:[]})}function o(t){if(!t.module){var r=t.module=n(t.name),i=t.module.exports,a=t.declare.call(e,function(e,t){r.locked=!0,i[e]=t;for(var n=0,o=r.importers.length;n<o;n++){var a=r.importers[n];if(!a.locked){var c=s.call(a.dependencies,r);a.setters[c](i)}}return r.locked=!1,t});if(r.setters=a.setters,r.execute=a.execute,!r.setters||!r.execute)throw new TypeError("Invalid System.register form for "+t.name);for(var a=0,d=t.normalizedDeps.length;a<d;a++){var f=t.normalizedDeps[a],p=u[f],h=l[f];h?f=h.exports:p&&!p.declarative?f=p.module.exports&&p.module.exports.__esModule?p.module.exports:{"default":p.module.exports,__useDefault:!0}:p?(o(p),h=p.module,f=h.exports):f=c(f),h&&h.importers?(h.importers.push(r),r.dependencies.push(h)):r.dependencies.push(null),r.setters[a]&&r.setters[a](f)}}}function i(t){if(!t.module){var r={},n=t.module={exports:r,id:t.name};if(!t.executingRequire)for(var o=0,s=t.normalizedDeps.length;o<s;o++){var l=u[t.normalizedDeps[o]];l&&i(l)}t.evaluated=!0,(r=t.execute.call(e,function(e){for(var r=0,n=t.deps.length;r<n;r++)if(t.deps[r]==e){if(e=t.normalizedDeps[r],r=void 0,n=u[e])n.declarative?a(e,[]):n.evaluated||i(n),r=n.module.exports;else if(r=c(e),!r)throw Error("Unable to load dependency "+e+".");return e=(!n||n.declarative)&&r&&r.__useDefault?r["default"]:r}throw new TypeError("Module "+e+" not declared as a dependency.")},r,n))&&(n.exports=r)}}function a(t,r){var n=u[t];if(n&&!n.evaluated&&n.declarative){r.push(t);for(var o=0,i=n.normalizedDeps.length;o<i;o++){var l=n.normalizedDeps[o];-1==s.call(r,l)&&(u[l]?a(l,r):c(l))}n.evaluated||(n.evaluated=!0,n.module.execute.call(e))}}function c(e){if(d[e])return d[e];var t=u[e];if(!t)throw"Module "+e+" not present.";var n=u[e];n.groupIndex=0;var c=[];r(n,c);for(var n=!!n.declarative==c.length%2,s=c.length-1;0<=s;s--){for(var l=c[s],f=0;f<l.length;f++){var p=l[f];n?o(p):i(p)}n=!n}return a(e,[]),u[e]=void 0,c=t.module.exports,c&&(t.declarative||!0===c.__esModule)||(c={"default":c,__useDefault:!0}),d[e]=c}var u={},s=Array.prototype.indexOf||function(e){for(var t=0,r=this.length;t<r;t++)if(this[t]===e)return t;return-1},l={},d={};return function(r,n){var o;for(o={register:t,get:c,set:function(e,t){d[e]=t},newModule:function(e){return e},global:e},o.set("@empty",{}),n(o),o=0;o<r.length;o++)c(r[o])}}("undefined"!=typeof window?window:global)(["background-exports"],function(e){e.register("crypto",[],function(e){var t;return e("generateKey",function(){return t.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}),e("exportKey",function(e){return t.subtle.exportKey("jwk",e)}),e("importKey",function(e){return t.subtle.importKey("jwk",e,{name:"AES-GCM"},!0,["encrypt","decrypt"])}),e("encrypt",function(e,r){var n=window.crypto.getRandomValues(new Uint8Array(16)),o=new Uint8Array(0);return t.subtle.encrypt({name:"AES-GCM",iv:n,additionalData:o,tagLength:128},r,e).then(function(e){return[n,o,e]})}),e("decrypt",function(e,r){return t.subtle.decrypt({name:"AES-GCM",iv:e[0],additionalData:e[1],tagLength:128},r,e[2])}),{setters:[],execute:function(){t=window.crypto}}}),e.register("bg-storage-service",[],function(e){function t(){return o||(o=new n),o}var r,n,o;return{setters:[],execute:function(){r={set:function(e,t){return new Promise(function(r,n){var o;chrome.storage.local.set((o={},Object.defineProperty(o,e,{value:t,configurable:!0,enumerable:!0,writable:!0}),o),function(){return chrome.runtime.lastError?n(chrome.runtime.lastError):void r()})})},get:function(e,t){return new Promise(function(r,n){chrome.storage.local.get(e,function(o){return chrome.runtime.lastError?n(chrome.runtime.lastError):void r(o.hasOwnProperty(e)?o[e]:t)})})}},n=function i(){function e(){return $traceurRuntime.asyncWrap(function(e){for(;;)switch(e.state){case 0:i=r.get("cfDraw_store",{}),e.state=5;break;case 5:return void Promise.resolve(i).then(e.createCallback(3),e.errback);case 3:t=e.value,e.state=-2;break;default:return e.end()}},this)}var t,n={},o=!1,i=null;return n.getData=function(){return $traceurRuntime.asyncWrap(function(e){for(;;)switch(e.state){case 0:return void Promise.resolve(i).then(e.createCallback(2),e.errback);case 2:e.returnValue=t,e.state=4;break;case 4:e.state=-2;break;default:return e.end()}},this)},n.start=function(){if(o)throw Error("bg-storage-service already started");o=!0,e()},n.stop=function(){o&&(o=!1)},n.onMessage=function(e){o&&e&&"castifyDrawStore"===e.type&&(t=e.data,r.set("cfDraw_store",t))},n.STORE_MSG_TYPE="castifyDrawStore",n},o=null,e("getBgStorageService",t)}}}),e.register("chrome-messaging",[],function(e){function t(e){return e instanceof Error?Promise.reject(e.toString()):Promise.reject(e)}return e("sendMessage",function(e,t){return new Promise(function(r,n){chrome.runtime.sendMessage({type:e,data:t},function(e){chrome.runtime.lastError?n(chrome.runtime.lastError):e?"result"===e.type?r(e.data):"error"===e.type&&n(e.data):n()})})}),e("respond",function(e,r){Promise.resolve(r)["catch"](t).then(function(t){e({type:"result",data:t})},function(t){e({type:"error",data:t})})}),{setters:[],execute:function(){}}}),e.register("w69b/q",[],function(e){var t;return{setters:[],execute:function(){t={defer:function(){var e={};return e.promise=new Promise(function(t,r){e.resolve=t,e.reject=r}),e}},t.when=Promise.resolve.bind(Promise),t.all=Promise.all.bind(Promise),t.reject=Promise.reject.bind(Promise),Promise.prototype["finally"]||(Promise.prototype["finally"]=function(e){var t=this.constructor;return this.then(function(r){return t.resolve(e()).then(function(){return r})},function(r){return t.resolve(e()).then(function(){throw r})})}),e("default",t)}}}),e.register("throttle",[],function(e){function t(e,t,r){var n,o,i;r=!1!==r;var a=function(){i=Object.assign([],arguments),o=function(){return o=n=null,e.apply(null,i)},r?(n&&window.clearTimeout(n),n=window.setTimeout(o,t)):n||(n=window.setTimeout(o,t))};return a.flush=function(){n&&(window.clearTimeout(n),o())},a.cancel=function(){n&&window.clearTimeout(n)},a}return{setters:[],execute:function(){e("default",t)}}}),e.register("bg-message-service",["crypto"],function(e){function t(){return o||(o=new n),o}var r,n,o;return{setters:[function(e){r=e}],execute:function(){n=function i(){function e(e,r,n){if(!e)return!1;if("castifyDrawGetMsgKey"===e.type){if(r.tab.url.startsWith("https://"))return t.then(function(e){n(e)})["catch"](function(){n(null)}),!0;n("plain")}else if("castifyDrawFrameBroadcast"===e.type&&r.tab)chrome.tabs.sendMessage(r.tab.id,e.data);else if("castifyDrawFrameBroadcastWithResult"===e.type&&r.tab)return chrome.tabs.sendMessage(r.tab.id,e.data,function(e){n(e)}),!0;return!1}var t=r.generateKey().then(r.exportKey),n={},i=!1;return n.start=function(){i||(chrome.runtime.onMessage.addListener(e),i=!0)},n.stop=function(){i&&(i=!1,chrome.runtime.onMessage.removeListener(e))},n},o=null,e("getBgMessageService",t)}}}),e.register("w69b/promise-tool",["w69b/q"],function(e){var t,r;return{setters:[function(e){t=e["default"]}],execute:function(){r={wrapChromeError:function(e,r){return function(){var n=Array.prototype.slice.call(arguments,0),o=t.defer();return n.push(function(e){chrome.runtime.lastError?o.reject(chrome.runtime.lastError):o.resolve(e)}),e.apply(r,n),o.promise}},wrapCallbacks:function(e,r){return function(){var n=Array.prototype.slice.call(arguments,0),o=t.defer();return n.push(o.resolve.bind(o)),n.push(o.reject.bind(o)),e.apply(r,n),o.promise}}},e("default",r)}}}),e.register("w69b/webrtc",["w69b/promise-tool","w69b/q"],function(e){function t(e){return e.some(function(e){return!!e.label})}var r,n,o,i;return{setters:[function(e){r=e["default"]},function(e){n=e["default"]}],execute:function(){o={},i=window.navigator,o.getUserMedia=i.mediaDevices&&i.mediaDevices.getUserMedia?i.mediaDevices.getUserMedia.bind(i.mediaDevices):r.wrapCallbacks(i.getUserMedia||i.webkitGetUserMedia||i.mozGetUserMedia||i.msGetUserMedia,i),o.getSources=i.mediaDevices&&i.mediaDevices.enumerateDevices?function(){return n.when(i.mediaDevices.enumerateDevices()).then(function(e){return e.filter(function(e){return e.kind.endsWith("input")}).map(function(e){var t={id:e.deviceId,label:e.label};return t.kind=e.kind.substring(0,e.kind.length-5),t})})}:window.MediaStreamTrack&&MediaStreamTrack.getSources?r.wrapCallbacks(MediaStreamTrack.getSources,MediaStreamTrack):function(){return Promise.resolve([])},o.getSourcesByKind=function(e){return o.getSources().then(function(t){return t.filter(function(t){return t.kind===e})})},o.getVideoSources=function(){return o.getSourcesByKind("video")},o.getAudioSources=function(){return o.getSourcesByKind("audio")},o.hasCamera=function(){return o.getVideoSources().then(function(e){return 0<e.length})},o.hasMicrophone=function(){return o.getAudioSources().then(function(e){return 0<e.length})},o.hasVideoAccess=function(){return o.getVideoSources().then(t)},o.hasAudioAccess=function(){return o.getAudioSources().then(t)},e("default",o)}}}),e.register("bg-cam-sustain-service",["chrome-messaging","w69b/webrtc","throttle"],function(e){function t(){return a||(a=new i),a}var r,n,o,i,a;return{setters:[function(e){r=e},function(e){n=e["default"]},function(e){o=e["default"]}],execute:function(){i=function c(){function e(){u.cancel(),i&&(i.getTracks().forEach(function(e){e.stop()}),a=i=null)}function t(e,t,n){return!!(e&&"castifyDrawCamSustainMsg"===e.type&&(e=e.data)&&l.hasOwnProperty(e.type))&&(r.respond(n,l[e.type](e.data)),!0)}var i,a,u,s={},c=!1;u=o(e,1e3);var l={start:function(t){return $traceurRuntime.asyncWrap(function(r){for(;;)switch(r.state){case 0:u.cancel(),r.state=12;break;case 12:r.state=i?4:6;break;case 4:r.state=JSON.stringify(a)===JSON.stringify(t)?1:3;break;case 1:r.returnValue=void 0,r.state=2;break;case 2:r.state=-2;break;case 3:e(),r.state=6;break;case 6:return void Promise.resolve(n.getUserMedia({video:t})).then(r.createCallback(10),r.errback);case 10:i=r.value,r.state=9;break;case 9:a=t,r.state=-2;break;default:return r.end()}},this)},stop:function(){u()}};return s.start=function(){c||(chrome.runtime.onMessage.addListener(t),c=!0)},s.stop=function(){c&&(c=!1,e(),chrome.runtime.onMessage.removeListener(t))},s},a=null,e("getBgCamSustainService",t)}}}),e.register("bg-castify-draw-service",["bg-message-service","bg-storage-service","bg-cam-sustain-service","throttle"],function(e){function r(e,t){return function(){var r=Array.prototype.slice.call(arguments,0);return new Promise(function(n,o){r.push(function(e){chrome.runtime.lastError?o(chrome.runtime.lastError):n(e)}),e.apply(t,r)})}}function n(e,t,r){function n(t){var n=[u.executeScript(e,{file:t?y:w,allFrames:!0,matchAboutBlank:!0,runAt:"document_start"})];return t&&n.push(u.insertCSS(e,{file:r,allFrames:!0,matchAboutBlank:!0,runAt:"document_start"})),Promise.all(n)}function o(){if(!v){var t=n(!0).then(function(){return m=u.connect(e,{name:"castifyDraw"}),m.onDisconnect.addListener(function(){v===t&&(v=null)}),m.onMessage.addListener(function(e){S.hasOwnProperty(e.type)?S[e.type](m,e.data):E&&E(e)}),m});t["catch"](function(e){console.error("BgCastifyDrawServiceError",e)}),v=t}return v}function a(e){var r,n;return $traceurRuntime.asyncWrap(function(a){for(;;)switch(a.state){case 0:r=new Promise(function(e){S.initializeDone=function(){S.initializeDone=null,e()}}),e=Object.assign({bundlesPath:t},e),a.state=9;break;case 9:return void Promise.resolve(o()).then(a.createCallback(2),a.errback);case 2:return void Promise.resolve(i().getData()).then(a.createCallback(5),a.errback);case 5:n=a.value,a.state=4;break;case 4:h("initialize",{config:e,storage:n}),a.state=11;break;case 11:return void Promise.resolve(r).then(a.createCallback(7),a.errback);case 7:S.initializeDone=null,b=void 0,a.state=-2;break;default:return a.end()}},this)}function s(t){t.tabId==e&&(0===t.frameId?(R.cancel(),g(),a(b)):R())}function l(t){t.replacedTabId===e&&(e=t.tabId,g(),a(b))}function d(e){p(e.tabId)}function f(){chrome.tabs.query({active:!0,windowId:chrome.windows.WINDOW_ID_CURRENT},function(e){p(e.length?e[0].id:-1)})}function p(t){t===e?(k=!0,h("updateTabFocused",k)):k&&(k=!1,h("updateTabFocused",k))}function h(e,t){return o().then(function(r){r.postMessage({type:e,data:t})})}function g(){v&&(v.then(function(e){e.disconnect()}),v=null)}var m,v,b,y=t+"content-script.js",w=t+"content-script-frame.js",x={},S={},E=null,k=!0,R=c(function(){n()},1e3);return x.initialize=function(e){return $traceurRuntime.asyncWrap(function(t){for(;;)switch(t.state){case 0:b=e,t.state=4;break;case 4:return void Promise.resolve(a(e)).then(t.createCallback(-2),t.errback);default:return t.end()}},this)},x.setOnMessageListener=function(e){E=e},x.sendMessage=function(e){return $traceurRuntime.asyncWrap(function(t){for(;;)switch(t.state){case 0:t.returnValue=h(e.type,e.data),t.state=2;break;case 2:t.state=-2;break;default:return t.end()}},this)},x.dispose=function(){g(),chrome.webNavigation.onCommitted.removeListener(s),chrome.webNavigation.onTabReplaced.removeListener(l),chrome.tabs.onActivated.removeListener(d),chrome.windows.onFocusChanged.removeListener(f)},o(),chrome.webNavigation.onCommitted.addListener(s),chrome.webNavigation.onTabReplaced.addListener(l),chrome.tabs.onActivated.addListener(d),chrome.windows.onFocusChanged.addListener(f),x}var o,i,a,c,u,s;return{setters:[function(e){o=e.getBgMessageService},function(e){i=e.getBgStorageService},function(e){a=e.getBgCamSustainService},function(e){c=e["default"]}],execute:function(){u={executeScript:r(chrome.tabs.executeScript,chrome.tabs),insertCSS:r(chrome.tabs.insertCSS,chrome.tabs),connect:chrome.tabs.connect.bind(chrome.tabs)},s=function(){return $traceurRuntime.createClass(function(e,t){this._servicesStarted=!1,this._tabBgServices=new Map,this._storageService=i(),this._bundlesPath=e,this._cssPath=t},{_sendMessageToAllTabs:function(e){for(var r=t.makeIterator(this._tabBgServices.values()),n=r.next();!n.done;n=r.next())n.value.sendMessage(e)},_startServicesIfNotStarted:function(){this._servicesStarted||(this._servicesStarted=!0,o().start(),this._storageService.start(),a().start())},_onMessageListener:function(e,r){var n,o;if(r&&r.type===this._storageService.STORE_MSG_TYPE){this._storageService.onMessage(r);for(var i=t.makeIterator(this._tabBgServices.entries()),a=i.next();!a.done;a=i.next()){a=a.value,t.initSymbol(),t.initSymbolIterator();var a=(n=a[$traceurRuntime.toProperty(Symbol.iterator)](),(o=n.next()).done?void 0:o.value),c=(o=n.next()).done?void 0:o.value;a!==e&&c.sendMessage(r)}}},loadInTab:function(e,t){var r,o;return $traceurRuntime.asyncWrap(function(i){for(;;)switch(i.state){case 0:r=this,this._startServicesIfNotStarted(),i.state=8;break;case 8:i.state=this._tabBgServices.get(e)?1:3;break;case 1:i.returnValue=void 0,i.state=2;break;case 2:i.state=-2;break;case 3:o=new n(e,this._bundlesPath,this._cssPath),o.setOnMessageListener(function(t){return r._onMessageListener(e,t)}),this._tabBgServices.set(e,o),i.state=10;break;case 10:return void Promise.resolve(o.initialize(t)).then(i.createCallback(-2),i.errback);default:return i.end()}},this)},disposeInTab:function(e){var t=this._tabBgServices.get(e);t&&(t.dispose(),this._tabBgServices["delete"](e),this._tabBgServices.size||this._stopServices())},disposeAll:function(){for(var e=t.makeIterator(this._tabBgServices.values()),r=e.next();!r.done;r=e.next())r.value.dispose();
this._tabBgServices.clear(),this._stopServices()},_stopServices:function(){this._servicesStarted=!1,a().stop(),o().stop(),this._storageService.stop()}},{})}(),e("BgCastifyDrawService",s)}}}),e.register("background-exports",["bg-castify-draw-service"],function(e){var t;return{setters:[function(e){t=e.BgCastifyDrawService}],execute:function(){window.BgCastifyDrawService=t}}})}),window.angular&&angular.module("w69b.es6",[]),Array.prototype.find||(Array.prototype.find=function(e){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,r=Object(this),n=r.length>>>0,o=arguments[1],i=0;i<n;i++)if(t=r[i],e.call(o,t,i,r))return t}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(void 0===this||null===this)throw new TypeError("Cannot convert this value to object");var t=Object(this),r=parseInt(t.length,10)||0;if(0===r)return!1;var n=parseInt(arguments[1],10)||0;if(n>=r)return!1;var o;for(n>=0?o=n:(o=r+n,o<0&&(o=0));o<r;){var i=t[o];if(e===i||e!==e&&i!==i)return!0;o++}return!1}}),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{value:function(e,t){var r=this.toString();(void 0===t||t>r.length)&&(t=r.length),t-=e.length;var n=r.indexOf(e,t);return n!==-1&&n===t}}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,t){return t=t||0,this.lastIndexOf(e,t)===t}}),angular.module("castifyExt.commonConfig",["castifyExt.castifyAuth","w69b.chromeAnalytics","w69b.chromeRuntime","castifyExt.helpCenterConfig","castifyExt.appOptions","castifyExt.userAccount","castifyExt.deployConfig"]).config(["$compileProvider","$sceDelegateProvider","analyticsProvider","$locationProvider",function(e,t,r,n){r.setTrackingId("UA-23874345-14"),r.setApp("Screencastify"),t.resourceUrlWhitelist(["self","http://localhost:9008/**","blob:**","filesystem:chrome-extension://**","https://**"]);var o=/^\s*(https?|mailto|blob|chrome-extension|filesystem:chrome-extension):/;e.aHrefSanitizationWhitelist(o),e.imgSrcSanitizationWhitelist(o),n.hashPrefix("")}]).run(["$rootScope","analytics","chromeRuntime","appOptions","$injector","userAccount",function(e,t,r,n,o,i){function a(){return i.getAccount().then(function(e){var o="unknown";if(e.license.isPaid)o="paid";else{if(!e.license.isTester)return o="trial";o="tester"}t.tracker.set("dimension1",o),t.tracker.set("dimension2",r.getManifest().version),t.tracker.set("dimension5",n.values.hwEncoding),e.user?(t.tracker.set("userId",e.user.analyticsUid),t.tracker.set("dimension4",e.user.analyticsUid),t.setEnabled(n.values.enableAnalytics&&e.user.analyticsEnabled!==!1)):t.setEnabled(n.values.enableAnalytics)})}var c=o.has("$transitions")?o.get("$transitions"):null,u=n.loadedPromise.then(a);c&&c.onSuccess({},function(e){var r=e.targetState().state(),n=r.analyticsView||r.pageTitle;n&&u.then(function(){t.tracker.sendAppView(n)})}),e.$on("event:userAccountChanged",a)}]).factory("castifyConfig",["deployConfig",function(e){return{API_URL:e.apiUrl,IS_E2E:window.localStorage.e2e}}]),angular.module("castifyExt.authConfig",["castifyExt.youtubeAuth","castifyExt.castifyAuth","w69b.chromeRuntime","w69b.googleHttpAuthInterceptor","castifyExt.youtubeAuth"]).config(["$httpProvider","youtubeAuthProvider","googleHttpAuthInterceptorProvider","deployConfigProvider",function(e,t,r,n){t.setClientId(n.clientId),e.interceptors.push("youtubeHttpAuthInterceptor"),e.interceptors.push("googleHttpAuthInterceptor"),r.enableAuthAutoRetry(!0),r.setAuthProvider("castifyAuth")}]),angular.module("castifyExt.deployConfig",[]).provider("deployConfig",function(){var e={apiUrl:"https://api.screencastify.com/api",clientId:"242262968495-o42n5tqeo08dsa75p3j4dk1k61t05ln3.apps.googleusercontent.com",scopes:chrome.runtime.getManifest().oauth2.scopes,redirectUri:"https://www.screencastify.com/oauth2postback",editorOpenUri:"https://editor.screencastify.com/open/drive",notificationUri:"https://us-central1-castify-notifications-prod.cloudfunctions.net/api/userNotification/"};return _extends({},e,{$get:function(){return e}})}),angular.module("castifyExt.audioStreamMixer",["castifyExt.audioContextPool"]).factory("audioStreamMixer",["audioContextPool",function(e){function t(){var t=e.acquire(),r=t.createMediaStreamDestination(),n={},o={},i={};return i.addStream=function(e,i){var a=t.createMediaStreamSource(i),c=t.createGain();o[e]=a,n[e]=c,a.connect(c),c.connect(r)},i.replaceStream=function(e,r){var a=o[e];a||i.addStream(e,r),a.disconnect();var c=t.createMediaStreamSource(r);c.connect(n[e])},i.setGain=function(e,t){n[e].gain.value=t},i.outStream=r.stream,i.dispose=function(){i.outStream.getTracks().forEach(function(e){e.stop()}),r.disconnect(),angular.forEach(n,function(e){e.disconnect()}),angular.forEach(o,function(e){e.disconnect()}),e.release(t)},i}return t}]),angular.module("castifyExt.chromeVideoRecorder",["w69b.pnaclVideoEncoder","w69b.webrtc","w69b.chromeCapture","w69b.chromeTabs","w69b.promiseTool","w69b.spawn","w69b.chromeCommands","castifyExt.ui.audioCountdown","castifyExt.optionalPermissions","castifyExt.castifyDrawService","castifyExt.resizeTab","castifyExt.audioStreamMixer","castifyExt.requestMicPermission","castifyExt.webrtcRecorder","castifyExt.hdpiTool","w69b.filesHelper","castifyExt.bgFiles"]).provider("chromeVideoRecorder",function(){var e="/components/castify/pnacl/manifest_pnacl.nmf",t=!0;this.setEncoderUrl=function(r,n){e=r,t=!!n},this.$get=["$log","pnaclVideoEncoder","webrtc","chromeCapture","$q","castifyDrawService","resizeTab","chromeTabs","audioStreamMixer","$rootScope","requestMicPermission","promiseTool","optionalPermissions","spawn","hdpiTool","webrtcRecorder","audioCountdown","chromeCommands","filesHelper",function(r,n,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w){function x(e,t){var r=e.getSettings(),n=r.height,o=r.width;return Math.floor(n*o*t)}function S(e,t){switch(t){case"medium":return x(e,ae);case"low":return x(e,ce);case"high":default:return x(e,ie)}}function E(){r.warn("video stream ended while still recording"),d.$broadcast("chromeVideoRecorder:streamEnded")}function k(e){e.getTracks().forEach(function(e){e.stop()})}function R(){return Number((/Chrome\/(\d+)/.exec(window.navigator.userAgent)||[void 0,0])[1])}function _(){K&&K.dispose(),K=null,z.video&&z.video.removeEventListener("inactive",E),angular.forEach(z,function(e){k(e)}),z={},H&&(G.pause(),G.src="",URL.revokeObjectURL(H),H=null),J&&(URL.revokeObjectURL(J),J=null)}function A(e){z.video&&(z.video.removeEventListener("inactive",E),k(z.video)),z.video=e,e.addEventListener("inactive",E),H&&URL.revokeObjectURL(H),H=URL.createObjectURL(e)}function C(e){J&&URL.revokeObjectURL(J),J=URL.createObjectURL(e)}function T(e){function t(){var t=[],r=B.filter(function(e){return e.height<=i.height});e.resolution&&(r=r.filter(function(e){return e.height!==i.height}),r.unshift(i)),r.forEach(function(e){t.push({minHeight:e.height})});var n={audio:$(e),video:{optional:t,mandatory:{maxWidth:i.width,maxHeight:i.height,maxFrameRate:e.targetFPS}}};return e.camSourceId&&(n.video.mandatory.sourceId=e.camSourceId),o.getUserMedia(n)}function n(){return t()["catch"](function(e){return!e||"PermissionDeniedError"!==e.name&&"MediaDeviceFailedDueToShutdown"!==e.name&&"InvalidStateError"!==e.name?(r.warn("failed to get webcam stream",e),a.reject(e)):(r.debug("webcam permission error detected"),f().then(function(){return n()}))})}var i=e.resolution;return i||(i={width:4096,height:4096}),n()}function I(e){return e?e:a.reject("stream is null")}function P(e){var t=e.resolution;t||(t={width:4096,height:4096});var r=e.audio.system;if(X&&X.cancelled)return a.reject("cancelled");if("desktop"===e.captureSource||"screen"===e.captureSource){var n="desktop"===e.captureSource?["screen","window"]:["screen"];R()>=50&&e.audio.system&&n.push("audio"),Q=i.chooseDesktopMedia(n);var c=Q.promise.then(function(n){if(!n)return a.reject("cancelled");var i={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxWidth:t.width,maxHeight:t.height,maxFrameRate:e.targetFPS}}};return r&&(i.audio={mandatory:{chromeMediaSource:R()>=52?"desktop":"system"}}),o.getUserMedia(i).then(I)});return c["finally"](function(){Q=!1}),c}if("tab"==e.captureSource){var u={video:!0,videoConstraints:{mandatory:{maxWidth:t.width,maxHeight:t.height,maxFrameRate:e.targetFPS}},audio:r};return r&&(u.audioConstraints={mandatory:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1}}),i.tabCapture(u).then(I)}if("cam"==e.captureSource)return T(e).then(I);throw Error()}function $(e){if(e.audio.mic){var t={echoCancellation:e.audio.micAudioProcessing!==!1};return e.audio.micSourceId&&(t.sourceId=e.audio.micSourceId),{mandatory:t}}return!1}function M(e){function t(){return o.getUserMedia({audio:$(e),video:n})["catch"](function(e){return r.debug("capture mic failed",e&&e.name),a.reject(e)})}var n=!!e.embedWebcam;return n&&e.camSourceId&&(n={mandatory:{sourceId:e.camSourceId}}),t()["catch"](function(){return r.debug("requesting mic permission"),f().then(t)})}function D(){c.disposeAll(),_(),Y&&(Y=null),ee=null}function F(e){return r.warn("chromeVideoRecorder: could not get video stream",e),a.reject(e)}function L(){Y.onCrash=function(e){r.warn("video encoder crashed",e),D(),d.$broadcast("chromeVideoRecorder:crash",e)},Y.onError=function(e){"start_timeout"===e||angular.isString(e)&&e.startsWith("start_timeout:")||(D(),d.$broadcast("chromeVideoRecorder:error",e))}}function j(e){var t=e.audio.system&&"tab"==e.captureSource;t&&(G.src=H,G.volume=1,G.play())}function U(e){for(var t=2,r=t,n=1;n<Math.floor(16/m.devicePixelRatio);++n)if(r=Math.round(100*m.devicePixelRatio*n)/100,r%2===0){t=r;break}var o=e.width%t,i=e.height%t;return!(!o&&!i)&&(e.width-=o,e.height-=i,!0)}function O(e){e.hwEncoding&&(r.debug("chromeVideoRecorder: trying to use hw encoding"),e.encoder="webrtc",ee.mimeType=oe,(!e.resolution||e.resolution.width>1920)&&(e.resolution={width:1920,height:1080}))}function N(e){return e.startDelay&&e.audibleCountdown!==!1?p.withTimeout(function(){return b.load(e.startDelay)["catch"](function(e){r.warn("chromeVideoRecorder: loading countdown failed: ",e)})},q,function(){return r.warn("chromeVideoRecorder: loading countdown timed out"),!0}):null}var B=[{width:1920,height:1080},{width:1280,height:720},{width:854,height:480},{width:640,height:360},{width:320,height:240},{width:320,height:180}],q=2e3,W=30,V=void 0,z={},H=void 0,J=void 0,G=document.createElement("video"),Y=void 0,K=void 0,Q=null,X=void 0,Z={},ee=null,te=!1,re={draw:void 0},ne='video/webm; codecs="vp8, opus"',oe='video/webm; codecs="h264, opus"',ie=20,ae=5,ce=1;return Z.start=function(i){function f(){if("webrtc"===i.encoder){if(v.isSupported(i.mimeType))return v();ee.encoder=null}return n(e,t)}function p(){return"tab"===i.captureSource?s.get(i.tabId).then(function(e){ee.originalMainSize={width:e.width,height:e.height}}):null}function w(){return i.audio.mic||i.embedWebcam?"cam"===i.captureSource?E:M(i):null}function x(){if(ee={},i.draw=i.draw||{showToolbox:!0},V=i,O(i),"webrtc"===i.encoder?ee.mimeType||(ee.mimeType=ne):("nacl"===i.encoder?ee.codec=null:i.encoder&&(ee.codec=i.encoder),i.audioCodec&&(ee.audioCodec=i.audioCodec)),null===i.draw.tool?(i.draw.tool="pointer",i.draw.pointerOptions=["autoHide"]):(i.draw.tool="pointer",i.draw.pointerOptions=["ring"]),i.draw.allowWebcam=!1,i.draw.embedWebcam=!1,"tab"!==i.captureSource&&("webrtc"!==i.encoder||"desktop"!==i.captureSource&&"screen"!==i.captureSource)||(i.draw.allowWebcam=!0,i.draw.embedWebcam=i.embedWebcam,i.draw.camSourceId=i.camSourceId,i.draw.camPosition=i.camPosition),i.targetFPS=i.targetFPS||W,"cam"===i.captureSource&&(i.audio.system=!1,i.embedWebcam=!1,ee.videoTrackIsCam=!0),!i.filename)throw new Error("filename required");i.audio||(i.audio={}),i.brandingFilename&&(ee.brandingFilename="/html5_persistent/"+i.brandingFilename),i.startDelay&&(ee.startDelay=i.startDelay),X={cancelled:!1,cancel:function(){X.cancelled=!0,Q&&Q.cancel("cancelled")}},Y=f(),L()}var E,k=g.wrap(regeneratorRuntime.mark(function $(){var e,t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if("tab"===i.captureSource){r.next=2;break}return r.abrupt("return",null);case 2:return r.t0=m,r.next=5,s.get(i.tabId);case 5:if(r.t1=r.sent,e=r.t0.toPhysicalResolution.call(r.t0,r.t1),i.resolution||(i.resolution=angular.copy(e)),i.resolution=m.scaleResolution(e,i.resolution),U(i.resolution),!U(e)){r.next=14;break}return t=m.toCssResolution(e),r.next=14,u(i.tabId,t.width,t.height,!1);case 14:return r.abrupt("return",null);case 15:case"end":return r.stop()}},$,this)})),R=g.wrap(regeneratorRuntime.mark(function B(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if("tab"!==i.captureSource){t.next=6;break}return t.next=3,h.hasTabPermissions(i);case 3:if(e=t.sent){t.next=6;break}return t.abrupt("return",a.reject("tab_permissions_denied"));case 6:case"end":return t.stop()}},B,this)})),_=g.wrap(regeneratorRuntime.mark(function q(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("tab"===i.captureSource||"desktop"===i.captureSource||"screen"===i.captureSource){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,y.getAll();case 4:i.draw.chromeCommands=e.sent;case 5:case"end":return e.stop()}},q,this)})),T=g.wrap(regeneratorRuntime.mark(function H(){var e,t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,a.all([Y.load(),k(),R(),N(i),_()]);case 2:return r.debug("chromeVideoRecorder: getting video stream"),n.next=5,P(i)["catch"](F);case 5:return E=n.sent,r.debug("chromeVideoRecorder: got video stream"),A(E),n.next=10,p();case 10:return n.next=12,h.hasTabPermissions(i);case 12:if(e=n.sent,"tab"!==i.captureSource&&("desktop"!==i.captureSource&&"screen"!==i.captureSource||!e)){n.next=31;break}if(!i.draw.allowWebcam){n.next=22;break}if(n.t0=i.audio.mic||i.embedWebcam,!n.t0){n.next=20;break}return n.next=19,o.hasVideoAccess();case 19:n.t0=n.sent;case 20:i.draw.allowWebcam=n.t0,i.embedWebcam=!1;case 22:return re.draw=i.draw,n.prev=23,n.next=26,c.loadInTab(i.tabId,i.draw);case 26:n.next=31;break;case 28:n.prev=28,n.t1=n["catch"](23),r.warn("chromeVideoRecorder: failed to initialize draw",n.t1);case 31:return n.next=33,w();case 33:return t=n.sent,r.debug("chromeVideoRecorder: got all streams"),ee.videoTrack=E.getVideoTracks()[0],"webrtc"===i.encoder&&(ee.bitRate=S(ee.videoTrack,i.bitRateOption)),i.audio.system&&!E.getAudioTracks().length&&(i.audio.system=!1,r.warn("failed to capture system audio - stream has no audio track."),d.$broadcast("chromeVideoRecorder:systemAudioUnsupported")),i.audio.system&&i.audio.mic?"webrtc"===i.encoder?(K=l(),ee.audioTrack=K.outStream.getAudioTracks()[0],t&&i.audio.mic&&(K.addStream("mic",t),K.setGain("mic",i.audio.micGain||1)),i.audio.system&&K.addStream("system",E)):(ee.audioTrack=E.getAudioTracks()[0],ee.audioTrack2=t.getAudioTracks()[0],ee.micVolume=i.audio.micGain||1):i.audio.mic?"webrtc"!==i.encoder?(ee.audioTrack2=t.getAudioTracks()[0],ee.micVolume=i.audio.micGain||1):ee.audioTrack=t.getAudioTracks()[0]:i.audio.system&&(ee.audioTrack=E.getAudioTracks()[0]),t&&(z.mic=t),i.embedWebcam&&t&&t.getVideoTracks().length&&(ee.camTrack=t.getVideoTracks()[0],ee.camPosition=i.camPosition,C(t)),j(i),r.debug("chromeVideoRecorder: starting encoder...",ee),n.next=45,Y.start(i.filename,ee);case 45:r.debug("chromeVideoRecorder: recording started"),b.start();case 47:case"end":return n.stop()}},H,this,[[23,28]])}));x();var I=T()["catch"](function(e){return r.error("chromeVideoRecorder: start error",e),D(),a.reject(e)});return X.promise=I,I["finally"](function(){X=null}),I},Z.setAutoStop=function(e){V.nonpersistent.autoStop=e},Z.restart=g.wrap(regeneratorRuntime.mark(function ue(){var e,t,n,o;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return e=V.filename,t=g.wrap(regeneratorRuntime.mark(function a(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r.debug("chromeVideoRecorder: removing files..."),t.next=3,w.removeByPath(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}},a,this)})),n=g.wrap(regeneratorRuntime.mark(function u(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,b.stop();case 2:return e.next=4,c.disposeAll();case 4:return e.next=6,Y.stop();case 6:case"end":return e.stop()}},u,this)})),o=g.wrap(regeneratorRuntime.mark(function l(e,t){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,Y.start(e,t);case 2:return n.next=4,s.getActiveTab();case 4:return r=n.sent,n.next=7,c.loadInTab(r.id,re.draw);case 7:return n.next=9,N(V);case 9:return n.next=11,b.start();case 11:case"end":return n.stop()}},l,this)})),r.debug("chromeVideoRecorder: restarting..."),te=!0,i.prev=6,i.next=9,n();case 9:return i.next=11,t(e);case 11:return i.next=13,o(e,ee);case 13:i.next=20;break;case 15:throw i.prev=15,i.t0=i["catch"](6),r.error("chromeVideoRecorder: restart error",i.t0),D(),i.t0;case 20:return i.prev=20,te=!1,i.finish(20);case 23:case"end":return i.stop()}},ue,this,[[6,15,20,23]])})),Z.stop=function(){return b.stop(),c.disposeAll(),Y.stop()["finally"](function(){_(),Y=null,ee=null})},Z.pause=function(){var e=Y.pause();return e.then(function(){b.pause()}),e},Z.resume=function(){var e=Y.resume();return e.then(function(){b.start()}),e},Z.setMicGain=function(e){K&&K.setGain("mic",e)},Z.getState=function(){return Z.getStateObj().state},Z.getStateObj=function(){var e;return e=te?{state:"recording",time:0}:Y?Y.getStateObj():{state:"inactive",time:0},angular.extend({},e,{videoUrl:H,cameraUrl:J,isDesktopDialogShown:!!Q})},Z.cancelPendingStart=function(){return!!X&&(X.cancel(),!0)},Z.getCurrentTime=function(){return Y?Y.getCurrentTime():0},Z.getRecordingConfig=function(){return V},Z.replaceStream=g.wrap(regeneratorRuntime.mark(function se(e){var t,n,o,i,u;return regeneratorRuntime.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(V.tabId!==e.tabId){s.next=2;break}throw new Error("cannot replace stream for same tab");case 2:if(t=V.tabId,n=V.audio.system,o=angular.extend({},V,e),Y.replaceTracks){s.next=7;break}return s.abrupt("return",a.reject("chromeVideoRecorder: replaceTracks not supported by chosen recorder"));case 7:return i=void 0,s.prev=8,s.next=11,P(o);case 11:i=s.sent,s.next=18;break;case 14:return s.prev=14,s.t0=s["catch"](8),r.warn("could not get replacement stream",s.t0),s.abrupt("return",a.reject(s.t0));case 18:return V=o,u={videoTrack:i.getVideoTracks()[0]},n&&(u.audioTrack=i.getAudioTracks()[0]),c.loadInTab(e.tabId,e.draw),c.disposeInTab(t),s.next=25,Y.replaceTracks(u);case 25:ee.videoTrack=i.getVideoTracks()[0],A(i),j(o);case 28:case"end":return s.stop()}},se,this,[[8,14]])})),Z}],this.$get.$inject=["$log","pnaclVideoEncoder","webrtc","chromeCapture","$q","castifyDrawService","resizeTab","chromeTabs","audioStreamMixer","$rootScope","requestMicPermission","promiseTool","optionalPermissions","spawn","hdpiTool","webrtcRecorder","audioCountdown","chromeCommands","filesHelper"]}),angular.module("castifyExt.fileNameGenerator",["w69b.filesHelper","w69b.uuid"]).factory("fileNameGenerator",["uuid","filesHelper",function(e,t){return function(r,n){function o(){return r+e()+n}function i(){var e=o();return t.getFileEntryByPath(e).then(function(){return i()},function(){return e})}return r||(r=""),n||(n=""),i()}}]),angular.module("castifyExt.appOptions",["w69b.chromeStorage","castifyExt.enterprisePolicy"]).factory("appOptions",["chromeStorage","$rootScope","$q","enterprisePolicy",function(e,t,r,n){function o(e){return n.options.hasOwnProperty(e)}function i(e){return n.options[e]}var a={videoTitleNamingScheme:"tabTitle",notifyAudio:!0,notifyFramerate:!1,notifyTabFocus:!0,uploadPrivacy:"public",autoOpen:!0,autoPlay:!0,driveSync:!1,enableDiskSpaceWatcher:!0,notifySyncProgress:!0,notifyEditProgress:!0,enableAnalytics:!0,enableCrashReports:!1,showDrawingToolsHint:!0,showEditToolsHint:!0,enableWindowPicker:!0,encoder:null,audioCodec:null,bitRateOption:"high",hwEncoding:!1,hideRestartAlert:!1},c={micGain:1,micAudioProcessing:!0,defaultEncoder:null},u=!1,s={},l=angular.copy(a);return s.localValues=angular.copy(c),s.loadedPromise=r.all({sync:e.sync.getSingle("options"),local:e.local.getSingle("options"),managed:n.loadedPromise}).then(function(e){angular.extend(l,e.sync),angular.extend(s.localValues,e.local),u=!0}),s.values={},Object.keys(a).forEach(function(e){Object.defineProperty(s.values,e,{enumerable:!0,get:function(){return o(e)?i(e):l[e]},set:function(t){l[e]=t}})}),s.save=function(){return e.sync.setSingle("options",l)},s.saveLocal=function(){return e.local.setSingle("options",s.localValues)},s.isLoaded=function(){return u},s.isSetByEnterprisePolicy=function(e){return o(e)},e.onChanged.addListener(function(e,r){"sync"==r&&e.options&&(angular.extend(l,e.options.newValue),t.$$phase||t.$digest()),"local"==r&&e.options&&(angular.extend(s.localValues,e.options.newValue),t.$$phase||t.$digest())}),s}]),angular.module("castifyExt.switchTab",["w69b.spawn","w69b.chromeCommands","w69b.chromeNotifications","castifyExt.castifyDrawService"]).factory("switchTab",["$log","chromeCommands","chromeNotifications","spawn","castifyDrawService",function(e,t,r,n,o){var i={};return i.chromeNotify=function(n){e.debug("switchTab: draw lost focus"),t.getAll().then(function(e){for(var t=0;t<e.length;++t)if("focus-tab"==e[t].name)return e[t];return null}).then(function(e){var t="Screencastify is recording a tab in the background. ";"webrtc"!==n.encoder&&(t+="Use the extension icon to switch the record focus to your current tab.",e&&e.shortcut&&(t+=" You can also use the keyboard shortcut "+e.shortcut+".")),r.simple.create({priority:2,title:"Recording a background tab",message:t},"activeTab")})},i.loadAdditionalDraw=n.wrap(regeneratorRuntime.mark(function a(t){return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return e.debug("switchTab: load new draw"),r.next=3,o.loadInTab(t);case 3:case"end":return r.stop()}},a,this)})),i}]),angular.module("castifyExt.bgRecord",["w69b.chromeTabs","w69b.chromeAnalytics","w69b.chromeStorage","w69b.chromeWindows","w69b.chromeNotifications","w69b.filesHelper","w69b.spawn","castifyExt.switchTab","castifyExt.chromeVideoRecorder","castifyExt.bgFiles","castifyExt.bgUserAccount","castifyExt.appOptions","castifyExt.recordTool","castifyExt.fileNameGenerator","castifyExt.crashReporter","castifyExt.helpCenter","castifyExt.branding","castifyExt.connect.appRegistry","castifyEdit.bgEditJobScheduler","castifyExt.ui.countdownIcon","castifyExt.statsClient","castifyExt.optionalPermissions"]).factory("bgRecordService",["chromeVideoRecorder","$rootScope","$q","$log","chromeRuntime","chromeTabs","$window","analytics","appOptions","recordTool","fileNameGenerator","bgFiles","chromeStorage","chromeWindows","crashReporter","chromeNotifications","helpCenter","branding","appRegistry","filesHelper","spawn","bgEditJobScheduler","countdownIcon","statsClient","userAccount","switchTab","optionalPermissions",function(e,t,r,n,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w,x,S,E,k,R,_){function A(e){return{path:{19:"images/"+e+"19.png",38:"images/"+e+"38.png"}}}function C(){return y.getDirByPath(oe,{create:!0})}function T(e){if(re)throw new Error("already blocked");re=!0;var t=r.defer();return ne=t.promise,e["finally"](function(){re=!1,t.resolve()}),e}function I(e,t){n.warn("bgRecord: recorder_fatal_error",t),c.tracker.sendException(t,!0),F(),"out_of_disk_space"===t?m.setNotifyHelp(g.simple.create({priority:1,title:"Out of disk space",message:"Recording was stopped forcefully. Your recording might be corrupted.",buttons:[{title:"Help"}]},"disk_space")):"no_data"===t?m.setNotifyHelp(g.simple.create({priority:1,title:"Oops, we failed to capture anything",message:"Please try to restart you computer if this problem persists."}),"no_audio"):g.simple.create({priority:1,title:"Oops, something went wrong",message:"Please try to restart Chrome if this problem persists."})}function P(e,t){if(c.tracker.sendException(e,!0),"nacl_load"===e)m.setNotifyHelp(g.simple.create({priority:1,title:"Failed to load NaCl module",message:"Click for help",buttons:[{title:"Help"}]}),"load_nacl");else if("tab_permissions_denied"===e)g.simple.create({priority:1,title:"Tab recording and annotation tools requires additional permissions.",message:"Please use the Screencastify Icon to start recording."});else if("trial_monthly_limit"===e)m.setNotifyHelp(g.simple.create({priority:1,title:"Monthly recordings limit reached.",message:"Please upgrade to make more recordings this month.",buttons:[{title:"Upgrade"}]}),"trial_monthly_limit");else if("start_timeout:no_audio"===e)m.setNotifyHelp(g.simple.create({priority:1,title:"Failed to capture audio",message:"Please try to restart you computer or re-plug your mic."}),"no_audio");else if("start_timeout:no_cam"===e)m.setNotifyHelp(g.simple.create({priority:1,title:"Failed to capture your webcam",message:"Please try to restart you computer or re-plug your cam."}),"no_cam");else{var r="tab"===t.captureSource?"Please try to re-open the tab you are trying to record.":"Please try to restart your computer if this problem persists";m.setNotifyHelp(g.simple.create({priority:1,title:"Failed to start recording",message:r,buttons:[{title:"Help"}]}),"start_recording")}}function $(e,t){u.values.enableCrashReports&&h.report("encoder",t),c.tracker.sendException("encoder_crash",!0),F(),U(),g.simple.create({priority:2,title:"Encoder crashed",message:"Oops, the video encoder crashed. This should not have happened. Please submit a bug report."},"crash")}function M(e,t){te.forEach(function(r){r.postMessage({type:e,data:t})})}function D(t,r){if(te.length){var n=angular.copy(e.getStateObj());angular.extend(n,t),n.config=e.getRecordingConfig(),n.previewShown=!!X,n.isBlocked=re,!r&&angular.equals(n,ae)||(M("stateUpdate",n),ae=n)}}function F(){n.debug("bgRecord: cleaning up after fatal error stop"),i.onActivated.removeListener(se.onTabActivated),Y(),re=!1,de()}function L(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,o=void 0,i=void 0;switch(t){case"stop":o=e.stop(),i=ue;break;case"pause":o=e.pause(),i=function(){return n.debug("bgRecord: "+t+" finished")};break;case"resume":o=e.resume(),i=function(){return n.debug("bgRecord: "+t+" finished")};break;case"restart":o=e.restart(),i=function(){return n.debug("bgRecord: "+t+" finished")}}return n.debug("bgRecord: "+t+" in progress..."),o["finally"](i),T(o),c.trackEvent("recorder",t,"",r),o}function j(e){return i.getActiveTab().then(function(t){e.tabId=t.id,e.windowId=t.windowId,e.tabTitle=t.title})}function U(){n.info("bgRecord: Saving webrtc as default encoder..."),u.localValues.defaultEncoder="webrtc",u.saveLocal()}function O(e,t){return(!e.embedWebcam||"desktop"!==e.captureSource)&&(t||"tab"!==e.captureSource)}function N(e){return u.values.encoder?u.values.encoder:angular.isDefined(window.navigator.mimeTypes["application/x-nacl"])?u.localValues.defaultEncoder?"webrtc"!==u.localValues.defaultEncoder||O(e)?u.localValues.defaultEncoder:null:void 0:"webrtc"}function B(){c.trackEvent("recorder","streamEnded","",1),se.stop()}function q(){g.simple.create({priority:1,title:"Not recording system audio",message:"Capturing system audio is only supported for full-screen or tab recording."},"noSystemAudio")}function W(t){if(!re){if(n.debug("bgRecord: replacing stream...",t),"inactive"===e.getState())return void n.error("bgRecord: cannot replace tab while not recording");g.clear("activeTab"),c.trackEvent("recorder","replaceStream","",1),T(e.replaceStream(t))}}function V(e){if("recorder"==e.name){te.push(e),D({},!0),e.onDisconnect.addListener(function(){var t=te.indexOf(e);t>=0&&te.splice(t,1)});var r={start:se.start,stop:se.stop,restart:se.restart,replaceStream:W,pause:se.pause,resume:se.resume,cancelPendingStart:se.cancelPendingStart,showPreview:function(e){e?K():Y()},setAutoStop:se.setAutoStop};e.onMessage.addListener(function(e){r.hasOwnProperty(e.type)&&r[e.type](e.data),t.$$phase||t.$digest()})}}function z(){g.clear("audioDropped"),g.clear("lowFrameRate"),g.clear("activeTab"),g.clear("noSystemAudio")}function H(t){if(!re){var r=e.getState();if("toggle-recording"==t)"recording"===r||"paused"===r?se.stop():s.getRecordConfig().then(function(e){se.start(e)});else if("toggle-pause"==t)"paused"===r?se.resume():"recording"===r&&se.pause();else if("focus-tab"==t){var n=e.getRecordingConfig();if("inactive"===r||"tab"!==n.captureSource)return;i.getActiveTab().then(function(e){n.tabId!=e.id&&W({tabId:e.id,windowId:e.windowId,tabTitle:e.title})})}}}function J(){var t=!1;Z.$watchCollection(e.getStateObj,function(){D()}),Z.$watch(function(){return re},function(e,t){e!==t&&D()}),Z.$watch(function(){return[e.getState(),Math.min(0,e.getCurrentTime())]},function(){return ce()},!0),Z.$watch(function(){return Math.floor(e.getStateObj().droppedAudioTime)},function(e){if(u.values.notifyAudio&&e){var r={type:"basic",priority:2,title:"Dropping Audio Frames",message:"Screencastify dropped "+e+" seconds audio. Audio will be choppy. Try to restart recording with a lower resolution or frame rate.",iconUrl:"images/icon128.png"};t?g.update("audioDropped",r):g.create("audioDropped",r),t=!0}}),Z.$watch(function(){return u.localValues.micGain},function(t,r){t!==r&&e.setMicGain(t)}),Z.$watch(function(){return Math.floor(e.getCurrentTime()/60)},function(e){var t=se.getConfig();if(t){var r=t.nonpersistent.autoStop;r&&e>=r&&se.stop()}}),Z.$on("chromeVideoRecorder:streamEnded",B),Z.$on("chromeVideoRecorder:crash",$),Z.$on("chromeVideoRecorder:error",I),Z.$on("chromeVideoRecorder:systemAudioUnsupported",q)}function G(){(re||"inactive"!==e.getState())&&(n.info("bgRecord: onSuspend() while recorder is active, preventing unloading"),o.getBackgroundPage())}function Y(){X&&p.remove(X),D()}function K(){if(!X){n.debug("bgRecord: opening preview window");var e=4;"cam"===se.getConfig().captureSource&&(e=1);var t=Math.ceil(a.screen.width/e),r=Math.ceil(a.screen.height/e);p.create({url:"livepreview.html",type:"panel",width:t,height:r,top:a.screen.height-r,left:a.screen.width-t}).then(function(e){X=e.id,D(),p.onRemoved.addListener(function t(r){e.id==r&&(p.onRemoved.removeListener(t),n.debug("bgRecord: closed preview window"),X=null,D())})})}}var Q,X,Z,ee,te=[],re=!1,ne=r.when(),oe="/_recording",ie="bgRecord:pendingConfig",ae={},ce=w.wrap(regeneratorRuntime.mark(function fe(t){var r,n;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(t||(t=e.getState()),"paused"!==t){o.next=5;break}r=A("icon_paused"),o.next=17;break;case 5:if("recording"!==t){o.next=16;break}if(n=e.getCurrentTime()<0,!n){o.next=13;break}return o.next=10,S.getIcon(e.getCurrentTime());case 10:r=o.sent,o.next=14;break;case 13:r=A("icon_recording");case 14:o.next=17;break;case 16:r=A("icon");case 17:chrome.browserAction.setIcon(r);case 18:case"end":return o.stop()}},fe,this)})),ue=w.wrap(regeneratorRuntime.mark(function pe(){var r,o,i,c,u,s;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(n.debug("bgRecord: stop finished"),r=e.getRecordingConfig(),o=r.filename,i=o.split("/").slice(-1)[0],c=d.localFilenameToId(i),u=!1,!a.navigator.userAgent.includes("Windows")||"webrtc"===r.encoder){l.next=19;break}return l.t0=y,l.next=10,y.getFileEntryByPath(o);case 10:return l.t1=l.sent,l.next=13,l.t0.getMetadata.call(l.t0,l.t1);case 13:if(s=l.sent,!(s.size>2e9)){l.next=19;break}return n.debug("Working around 2GB chrome bug on Windows for file of size",s.size),l.next=18,le(o,c,i);case 18:u=!0;case 19:if(u){l.next=22;break}return l.next=22,y.moveFileByPath(o,i);case 22:f.local.remove(ie),t.$broadcast("recorder:stopped",c,r);
case 24:case"end":return l.stop()}},pe,this)})),se={};se.restart=function(){return re||"inactive"===e.getState()?r.reject():L("restart")},se.stop=function(){if(re||"inactive"===e.getState())return r.reject();i.onActivated.removeListener(se.onTabActivated),Y(),z();var t=e.getCurrentTime();return Q.send(),t>0&&E.sendRecordingCreated(t),L("stop",Math.round(t))},se.pause=function(){return re||"recording"!==e.getState()?r.reject():(g.clear("activeTab"),L("pause"))},se.resume=function(){if(!re&&"paused"===e.getState())return i.getActiveTab().then(function(e){se.onTabActivated({tabId:e.id,windowId:e.windowId})}),L("resume")},se.setAutoStop=function(t){e.setAutoStop(t)},se.start=function(t){function o(){return t.autoShareApp?b.getAppInfo(t.autoShareApp.id).then(function(e){t.autoShareApp=e}):r.when()}function a(){var e=[];return e.push(C()),e.push(l(oe+"/",".webm").then(function(e){t.filename=e})),e.push(j(t)),t.autoShareApp&&t.autoShareApp.isPaid||e.push(v.getFilename().then(function(e){e&&(t.brandingFilename=e)})),r.all(e)}function s(){function o(){n.info("bgRecord: retrying with webrtc..."),t.encoder="webrtc";var r=e.start(t);return r}return e.start(t)["catch"](function(e){return"nacl_load"===e&&"webrtc"!==t.encoder&&O(t,!0)?o():r.reject(e)})}if(re||"inactive"!==e.getState())return r.reject();i.onActivated.addListener(se.onTabActivated),c.trackEvent("recorder","start",t.captureSource,1),Q=c.trackTimer("recorder","duration"),t.audio.micGain=u.localValues.micGain,t.audio.micAudioProcessing=u.localValues.micAudioProcessing,t.audioCodec=u.values.audioCodec,t.bitRateOption=u.values.bitRateOption,t.hwEncoding=u.values.hwEncoding,t.limitResolution?t.resolution=t.maxResolution:t.resolution=null,u.values.enableWindowPicker||"desktop"!==t.captureSource||(t.captureSource="screen"),t.encoder=N(t);var d=w.wrap(regeneratorRuntime.mark(function h(){var e,n;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!t.autoShareApp||!t.autoShareApp.isPaid){o.next=2;break}return o.abrupt("return");case 2:return o.next=4,k.getAccount();case 4:if(e=o.sent,n=e.license,!(n.limitNumRecordings&&e.numRecordingsMonth>=n.maxNumRecordings)){o.next=8;break}return o.abrupt("return",r.reject("trial_monthly_limit"));case 8:case"end":return o.stop()}},h,this)}));n.debug("bgRecord: starting in progress",t),ee={cancelled:!1,cancel:function(){ee.cancelled=!0,e.cancelPendingStart()}};var p=o().then(d).then(a).then(function(){return ee.cancelled?r.reject("cancelled"):s()});return T(p),p["finally"](function(){ee=null}),p.then(function(){n.debug("bgRecord: started recording"),f.local.setSingle(ie,t),t.showPreview&&K()},function(e){if("cancelled"!==e)return D({startError:e}),P(e,t),r.reject(e)}),p},se.onTabActivated=w.wrap(regeneratorRuntime.mark(function he(t){var r,o;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return r=e.getRecordingConfig(),i.next=3,_.hasTabPermissions(r);case 3:if(o=i.sent,"recording"===e.getState()){i.next=6;break}return i.abrupt("return");case 6:"desktop"!==r.captureSource&&"screen"!==r.captureSource||!o?"tab"===r.captureSource&&(t.tabId!==r.tabId&&u.values.notifyTabFocus&&t.windowId===r.windowId?R.chromeNotify(r):(n.debug("bgRecord: recording tab got focus"),g.clear("activeTab"))):R.loadAdditionalDraw(t.tabId);case 7:case"end":return i.stop()}},he,this)}));var le=w.wrap(regeneratorRuntime.mark(function ge(e,t,r){var o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=y,a.next=3,y.getFileEntryByPath(e);case 3:return a.t1=a.sent,a.next=6,a.t0.getMetadata.call(a.t0,a.t1);case 6:return o=a.sent,n.debug("bgRecord: adding fix job for incomplete recording",e,o.size),i=x.addJob({type:"fixWebm",inPath:e,fileId:t,outPath:r}),a.prev=9,a.next=12,i.promise;case 12:n.debug("bgRecord: fixed incomplete recording",e),a.next=20;break;case 15:return a.prev=15,a.t2=a["catch"](9),n.warn("bgRecord: failed to fix incomplete recording",e,a.t2),a.next=20,y.moveFileByPath(e,r);case 20:case"end":return a.stop()}},ge,this,[[9,15]])})),de=w.wrap(regeneratorRuntime.mark(function me(){var e,r,n,o,i,a,c,u,s,l,p,h;return regeneratorRuntime.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return g.next=2,y.listByPath(oe)["catch"](function(){return null});case 2:if(e=g.sent){g.next=5;break}return g.abrupt("return");case 5:return g.next=7,f.local.getSingle(ie);case 7:r=g.sent,n=!0,o=!1,i=void 0,g.prev=11,a=e[Symbol.iterator]();case 13:if(n=(c=a.next()).done){g.next=26;break}return u=c.value,s=u.fullPath,l=s.split("/").slice(-1)[0],p=d.localFilenameToId(l),g.next=20,le(s,p,l);case 20:h={},r&&r.filename!==s&&(h=r),t.$broadcast("recorder:fixedFile",p,h);case 23:n=!0,g.next=13;break;case 26:g.next=32;break;case 28:g.prev=28,g.t0=g["catch"](11),o=!0,i=g.t0;case 32:g.prev=32,g.prev=33,!n&&a["return"]&&a["return"]();case 35:if(g.prev=35,!o){g.next=38;break}throw i;case 38:return g.finish(35);case 39:return g.finish(32);case 40:case"end":return g.stop()}},me,this,[[11,28,32,40],[33,,35,39]])}));return se.install=function(){Z=t.$new(!0),J(),de(),o.onConnect.addListener(V),o.onConnectExternal.addListener(V),o.onSuspend.addListener(G),chrome.commands.onCommand.addListener(H)},se.uninstall=function(){Z.$destroy(),o.onConnect.removeListener(V),chrome.commands.onCommand.removeListener(H)},se.getRecorderState=function(){return e.getStateObj()},se.cancelPendingStart=function(){return!!ee&&(ee.cancel(),!0)},se.getConfig=function(){return e.getRecordingConfig()},se.isBlocked=function(){return re},se.waitWhileBlocked=function(){return ne},se}]),angular.module("castifyExt.upload.uploadBase",["castifyExt.bgFiles","w69b.filesHelper"]).factory("UploadBase",["$q","$log","bgFiles","filesHelper",function(e,t,r,n){function o(e){return n.getFileByPath(r.idToLocalFilename(e))}function i(e){this.config=e,this.minStartTime=0,this.numErrors=0}i.targetClasses_={},i.register_=function(e,t){i.targetClasses_[e]=t},i.create=function(e){var t=i.targetClasses_[e.target];if(!t)throw new Error("unknown target "+e.target);return new t(e)},i.CancelledError={reason:"cancelled",isCancelled:!0};var a=i.prototype;return i.unserialize=function(e){var t=e[0],r=e[1],n=i.targetClasses_[t];if(!n)throw new Error("unknown target "+t);return n.fromObject(r)},a.serialize=function(){return[this.config.target,this.toObject()]},a.fromObject=function(e){throw new Error},a.toObject=function(){throw new Error},a.start=function(){},a.cancel=function(){return!1},a.onProgress=function(){},a.onComplete=function(){},a.onError=function(e){},a.handleComplete_=function(e){t.debug("upload complete",e),this.responseData=e},a.handleError_=function(t){return e.reject(t)},a.handleProgress_=function(e){return e},a.loadFile_=function(){var t=this.config,n=o(t.fileId);return e.all({file:n,fileDesc:r.getFileDescriptor(t.fileId)})["catch"](function(r){return t.isSyncUpload?e.reject(i.CancelledError):e.reject(r)})},a.toString=function(){var e=this.config;return"Upload of file "+e.fileId+" to "+e.target},i}]),angular.module("castifyExt.upload.googleUpload",["castifyExt.upload.uploadBase","castifyExt.driveUtils","w69b.googledrive","w69b.googleUploader","castifyExt.bgFiles","castifyExt.youtubeAuth"]).run(["UploadBase","driveUtils","googledrive","googleUploader","bgFiles","$q","$log","$http","$timeout","youtubeAuth","castifyConfig",function(e,t,r,n,o,i,a,c,u,s,l){function d(e){if(angular.isObject(e)&&angular.isNumber(e.status)){var t=e.status;if(t<=0||t>=500&&t<600||e.config&&e.config.authAutoRetry===!1&&401===t)return!0;var r=p.getErrorReason(e);if(["userRateLimitExceeded"].includes(r))return!0}return!1}function f(e){return{id:e.id,channelId:e.snippet.channelId}}function p(t,r){e.call(this,t),this.uploadUrl=r,this.cancelled=!1}function h(){p.apply(this,arguments)}function g(e){p.apply(this,arguments)}function m(t,r){e.call(this,t),this.pollTimer_=null,this.jobId=r}function v(t,r){if(!t.channelId)throw Error("channelId required");e.call(this,t),r&&this.setupDelegate_(r)}var b=l.API_URL+"/upload";p.prototype=Object.create(e.prototype),p.prototype.constructor=e;var y=p.prototype;y.handleProgress_=function(e){e.uploadUrl?this.uploadUrl=e.uploadUrl:(this.loadedBytes_=e.loaded,this.progress=e.loaded/e.total)},y.handleError_=function(t){return t===e.CancelledError||this.cancelled?i.reject(e.CancelledError):(a.debug("googleUploader: handling error",t),i.reject({isTransient:d(t),reason:p.getErrorReason(t)}))},y.resumeUpload_=function(e){return this.uploader_=n.resumeUpload(e,this.uploadUrl),this.uploader_.promise},y.start=function(){this.cancelled=!1;var t=this;this.loadFile_().then(function(r){return t.totalBytes_=r.file.size,t.cancelled?i.reject(e.CancelledError):t.uploadUrl?t.resumeUpload_(r.file,r.fileDesc):t.startUpload_(r.file,r.fileDesc)}).then(this.handleComplete_.bind(this),this.handleError_.bind(this),this.handleProgress_.bind(this)).then(function(e){t.onComplete(e)},function(e){t.onError(e)},function(e){t.onProgress(e)})},p.getErrorReason=function(e){if(angular.isString(e))return e;if(e&&e.data){var t,r=e.data;if(r.error&&r.error.errors&&r.error.errors.length&&(t=r.error.errors[0]),t)return t.reason}else if(e&&e.message)return e.message;return"unknown"},y.toObject=function(){return{config:this.config,uploadUrl:this.uploadUrl}},y.cancel=function(){return!!this.cancelled||(this.loadedBytes_&&this.totalBytes_-this.loadedBytes_<512e3?(a.debug("googleUploader: refusing to cancel almost complete upload"),!1):(this.cancelled=!0,this.uploader_&&this.uploader_.cancel(),!0))},h.prototype=Object.create(p.prototype),h.prototype.constructor=p,e.register_("drive",h),y=h.prototype,y.handleComplete_=function(e){return p.prototype.handleComplete_.call(this,e),o.updateLocalInfo(this.config.fileId,{driveInfo:e}),this.openLink=e.alternateLink,this.setDrivePrivacy_(e.id,this.config.privacy,this.config.domain)},h.doesFileExistInParent=function(e,t){return r.getFile(e).then(function(e){return e.parents&&e.parents.some(function(e){return e.id===t})&&(!e.labels||!e.labels.trashed)},function(e){return 404!=e.status&&i.reject(e)})},y.startUpload_=function(o,a){function c(){if(l.cancelled)return i.reject(e.CancelledError);var t={title:d,description:s.description||"",mimeType:"video/webm",properties:h.toDrivePropertyList_(p),parents:[{id:f}]};return l.uploader_=n.driveUpload(o,t),l.uploader_.promise}function u(t){return l.cancelled?i.reject(e.CancelledError):r.patchFile(t,{properties:h.toDrivePropertyList_(p)})}var s=this.config,l=this,d=s.title;/\.webm$/i.test(d)||(d+=".webm");var f,p={duration:a.duration,width:a.width,height:a.height,uuid:a.id,recordingDate:a.createdAt.getTime(),isScreencastifySyncFile:!0};return t.getDriveUploadParentId().then(function(t){if(l.cancelled)return i.reject(e.CancelledError);if(f=t,a.driveInfo&&a.driveInfo.id){var r=a.driveInfo.id;return h.doesFileExistInParent(r,f).then(function(e){return e?u(r):c()})}return c()})},y.setDrivePrivacy_=function(r,n,o){return"private"===n?i.when(null):this.cancelled?i.reject(e.CancelledError):t.setSimplePrivacy(r,n,o)},h.toDrivePropertyList_=function(e){var t=[];return angular.forEach(e,function(e,r){t.push({key:r,value:e,visibility:"PRIVATE"})}),t},y.toObject=function(){return{config:this.config,uploadUrl:this.uploadUrl}},h.fromObject=function(e){return new h(e.config,e.uploadUrl)},g.prototype=Object.create(p.prototype),g.prototype.constructor=p,e.register_("_youtube_local",g),y=g.prototype,y.handleComplete_=function(e){return p.prototype.handleComplete_.call(this,e),o.updateYoutubeInfo(this.config.fileId,f(e)),this.openLink="http://youtu.be/"+e.id,e},y.startUpload_=function(e){var t=this.config,r={title:t.title,privacy:t.privacy,description:t.description||""};return this.uploader_=n.youtubeUpload(e,r,{youtubeAuth:t.channelId}),this.uploader_.promise},y.resumeUpload_=function(e){return this.uploader_=n.resumeUpload(e,this.uploadUrl,{youtubeAuth:this.config.channelId}),this.uploader_.promise},y.toObject=function(){return{config:this.config,uploadUrl:this.uploadUrl}},g.fromObject=function(e){return new g(e.config,e.uploadUrl)},m.prototype=Object.create(e.prototype),m.prototype.constructor=e,e.register_("_youtube_remote",m),y=m.prototype,y.start=function(){var e=this,t=this.config;this.jobId?this.pollAndHandle_():o.getFileDescriptor(t.fileId).then(function(e){return c.post(b,{driveId:e.driveInfo.id,privacy:t.privacy,channelId:t.channelId},{googleAuth:!0})}).then(function(t){var r=t.data;a.debug("RemoteYoutubeUpload: job created",r),e.jobId=r.id,e.startPollTimer_()},this.handleError_.bind(this))},y.handleComplete_=function(t){e.prototype.handleComplete_.call(this,t),o.updateYoutubeInfo(this.config.fileId,f(t)),this.openLink="http://youtu.be/"+t.id,this.onComplete()},y.pollJob_=function(){return c.get(b+"/"+this.jobId,{googleAuth:!0}).then(function(e){return e.data})},y.handleError_=function(e){this.onError({isTransient:d(e),reason:p.getErrorReason(e)})},y.pollAndHandle_=function(){var e=this;this.pollJob_().then(function(t){a.debug("remote upload job is ",t);var r=t.state;if("completed"===r)e.handleComplete_(t.result);else if("failed"===r){var n=null;if(t.result&&t.result.error)try{n=JSON.parse(t.result.error)}catch(o){}n?e.handleError_({data:n}):t.result&&t.result.error&&"string"==typeof t.result.error?e.handleError_(t.result.error):e.handleError_("remote job failed")}else e.progress=t.progress,e.onProgress(),e.startPollTimer_()},this.handleError_.bind(this))},y.startPollTimer_=function(){var e=this;this.pollTimer_&&u.cancel(this.pollTimer_),u(function(){e.pollTimer_=null,e.pollAndHandle_()},3e3)},y.toObject=function(){return{config:this.config,jobId:this.jobId}},m.fromObject=function(e){return new m(e.config,e.jobId)},v.prototype=Object.create(e.prototype),v.prototype.constructor=e,e.register_("youtube",v),y=v.prototype,y.toObject=function(){var e=null;return this.delegate_&&(e=this.delegate_.serialize()),{config:this.config,serializedDelegate:e}},v.fromObject=function(t){var r=null;return t.serializedDelegate&&(r=e.unserialize(t.serializedDelegate)),new v(t.config,r)},y.handleError_=function(e){a.warn("YoutubeUploadProxy error",e),this.onError({isTransient:!1,reason:"unknown"})},y.start=function(){var t=this;o.getFileDescriptor(this.config.fileId).then(function(r){var n;if(n=r.driveInfo&&r.driveInfo.id?"_youtube_remote":"_youtube_local",!t.delegate_||t.delegate_.config.target!==n){var o=angular.copy(t.config);o.target=n,t.setupDelegate_(e.create(o))}t.delegate_.start()},this.handleError_.bind(this))},["progress"].forEach(function(e){Object.defineProperty(y,e,{get:function(){var t=this.delegate_;return t?t[e]:null}})}),y.setupDelegate_=function(e){var t=this;if(t.delegate_){var r=t.delegate_;delete r.onError,delete r.onProgress,delete r.onError}t.delegate_=e,e.onError=function(e){t.onError(e)},e.onProgress=function(){t.onProgress()},e.onComplete=function(){t.onComplete()}},y.cancel=function(){return!!this.delegate_&&this.delegate_.cancel()}}]),angular.module("castifyExt.bgUpload",["w69b.chromeStorage","w69b.chromeRuntime","w69b.chromeAnalytics","castifyExt.upload.uploadBase","castifyExt.upload.googleUpload","w69b.throttle","castifyExt.offline","castifyExt.syncAuthTool"]).factory("bgUploadService",["chromeStorage","chromeRuntime","$log","analytics","$rootScope","UploadBase","throttle","onlineState","syncAuthTool","$timeout",function(e,t,r,n,o,i,a,c,u,s){function l(e){if("uploader"==e.name){G.push(e),X(),e.onDisconnect.addListener(function(){var t=G.indexOf(e);t>=0&&G.splice(t,1)});var t={upload:K.upload,cancel:K.cancel};e.onMessage.addListener(function(e){t.hasOwnProperty(e.type)&&t[e.type](e.data)})}}function d(){H.length&&(r.info("onSuspend() while upload queue is not empty, preventing unloading"),t.getBackgroundPage()),Q.flush()}function f(){function e(e,r){var n=e.fileId,o=e.target;r.fileId=n,r.target=o,r.isSyncUpload=e.isSyncUpload,t[n]=t[n]||{},t[n][o]=r}if(G.length){var t={};J.forEach(function(t){e(t.config,{state:"error",error:t.error,config:t.config})}),H.forEach(function(t){e(t.config,{state:"queued",config:t.config})}),z.forEach(function(t){var r={state:"uploading",progress:t.progress};e(t.config,r)}),p("stateUpdate",t)}}function p(e,t){G.forEach(function(r){r.postMessage({type:e,data:t})})}function h(){var t=z.concat(H).map(function(e){return e.serialize()});e.local.setSingle(j,{queued:t,recentErrors:J})}function g(){Q(),X(),Y++}function m(){return e.local.getSingle(j).then(function(e){e&&(J=e.recentErrors||[],H=(e.queued||[]).map(function(e){return i.unserialize(e)}))})}function v(e){delete e.onProgress,delete e.onComplete,delete e.onError;var t=z.indexOf(e);z.splice(t,1),T(),g()}function b(e){var t=H.indexOf(e);H.splice(t,1)}function y(e,t){J=J.filter(function(r){return r.config.target!==t||r.config.fileId!==e})}function w(e,t){for(y(e.fileId,e.target),J.push({config:e,error:t});J.length>U;)J.shift()}function x(e){r.debug("bgUpload: upload complete",e.toString()),v(e),o.$broadcast("uploader:complete",{config:e.config,data:e.responseData,link:e.openLink})}function S(e){e.numErrors++;var t=Math.min(W,Math.pow(2,e.numErrors-1)*q);e.minStartTime=Date.now()+t+Math.random()*V,r.debug("transient upload error, re-queuing in %s: %s",t,e.toString()),P(e)}function E(e,t){if(r.warn("upload error",t),v(e),t===i.CancelledError)r.debug("upload was cancelled",e.toString());else if(t.isTransient)S(e),c.check();else{u.broadcastIfSyncError(t);var a=e.config;o.$broadcast("uploader:failed",{config:a,error:t}),w(a,t),t.reason&&n.tracker.sendException("upload_failed: "+t.reason,!1)}g()}function k(e){g()}function R(e){e.onComplete=x.bind(null,e),e.onError=E.bind(null,e),e.onProgress=k.bind(null,e)}function _(e){return H.filter(function(t){return t.config.fileId===e.fileId&&t.config.target===e.target})[0]}function A(e){return z.filter(function(t){return t.config.fileId===e.fileId&&t.config.target===e.target})[0]}function C(e){return _(e)||A(e)}function T(){function e(){var e=z.length<N&&H.length;if(!e)return!1;var t=H[0],r=t.minStartTime<=Date.now();if(!r)return!1;var n=z.length<B;return!t.config.isSyncUpload||n}if(I(),L&&(s.cancel(L),L=null),c.isOnline()&&H.length)if(H[0].minStartTime<=Date.now()){for(;e();){var t=H.shift();r.debug("starting queued upload",t.toString()),R(t),z.push(t),t.start()}g()}else{var n=H[0],o=n.minStartTime-Date.now();r.debug("scheduling upload queue start in "+o),L=s(T,o)}else;}function I(){H.sort(function(e,t){var r=e.minStartTime-t.minStartTime;if(0===r){if(e.config.isSyncUpload&&!t.config.isSyncUpload)return 1;if(t.config.isSyncUpload&&!e.config.isSyncUpload)return-1}return r})}function P(e){r.debug("queuing upload",e.toString()),H.push(e),g(),T()}function $(){var e=!0,t=!1,r=void 0;try{for(var n,o=H[Symbol.iterator]();!(e=(n=o.next()).done);e=!0){var i=n.value;i.minStartTime=0}}catch(a){t=!0,r=a}finally{try{!e&&o["return"]&&o["return"]()}finally{if(t)throw r}}}function M(e,t){if(r.debug("online state changed to ",t),t)$(),T();else{for(var n=z.concat([]);n.length;){var o=n.pop();o.cancel()&&(v(o),P(i.unserialize(o.serialize())))}$(),g()}}function D(){K.cancelAllUploads()}var F,L,j="uploadsPending",U=5,O=3,N=5,B=N-O,q=2e3,W=12e4,V=1e3,z=[],H=[],J=[],G=[],Y=0,K={},Q=a(h,2e3,!1),X=a(f,300,!1);return K.cancelAllUploads=function(e){var t=H.filter(function(t){return!e||t.config.isSyncUpload}),n=t.length;t.forEach(function(e){r.debug("bgUpload: cancelling queued sync upload",e.toString()),b(e)}),z.forEach(function(t){e&&!t.config.isSyncUpload||(r.debug("bgUpload: cancelling active sync upload",t.toString()),t.cancel(),++n)}),n&&(r.debug("bgUpload: cancelled %s sync uploads",n),g())},K.upload=function(e){var t=e.fileId,o=C(e);return o?(r.info("upload already pending "+t),void(o.config.isSyncUpload&&!e.isSyncUpload&&(r.info("marking upload as non-sync "+t),o.config.isSyncUpload=!1,g(),T()))):(y(e.fileId,e.target),n.trackEvent("uploader","start",e.target,1),void P(i.create(e)))},K.cancel=function(e){if(!e.fileId||!e.target)throw new Error;var t=_(e);t?b(t):(t=A(e),t&&t.cancel()),t?(r.debug("cancelled upload",t.toString()),g()):r.debug("no queued or active upload found to cancel",e)},K.getTargetFileState=function(e,t){function r(r){return r.config.fileId===e&&r.config.target===t}var n=z.find(r);if(n)return{state:"uploading",config:n.config,progress:n.progress};var o=H.find(r);return o?{state:"queued",config:o.config}:null},K.isOnline=function(){return c.isOnline()},K.getWatcherStateId=function(){return Y},K.install=function(){return F=o.$new(!0),m().then(function(){T(),t.onConnect.addListener(l),t.onSuspend.addListener(d),F.$on("onlineState:changed",M),o.$on("event:signInChanged",D)})},K.uninstall=function(){t.onConnect.removeListener(l),t.onSuspend.removeListener(d),F.$destroy()},K.STORAGE_KEY=j,K}]),angular.module("castifyExt.localFileDb",["w69b.chromeStorage","w69b.filesHelper"]).factory("localFileDb",["$filter","$q","chromeStorage","filesHelper",function(e,t,r,n){function o(e){return s+e}function i(e){var t=o(e),r=u.getSingle(t,{});return r}function a(e){angular.extend(this,e)}var c={},u=r.local,s="filedb_",l=a.prototype;return a.createFromIdOrFileEntry=function(e){var r,o,u=angular.isString(e)?n.getFileEntryByPath(c.idToFilename(e)):t.when(e);return u.then(function(e){return r=e,o=c.filenameToId(e.name),t.all({metadata:n.getMetadata(r),info:i(o)}).then(function(e){var t=r.toURL(),n={id:o,uuid:o,url:t,mimeType:"video/webm",createdAt:e.metadata.modificationTime,title:e.info.title,size:e.metadata.size};if(e.info.videoInfo){var i=e.info.videoInfo;angular.extend(n,{duration:i.duration,width:i.size.width,height:i.size.height})}if(e.info.previewImages&&(n.thumbnailUrl=e.info.previewImages[0].url),e.info.driveInfo&&(n.driveInfo=e.info.driveInfo),e.info.youtubeInfo){var c=e.info.youtubeInfo;n.youtubeInfo={id:c.id,channelId:c.channelId}}return e.info.autoShare&&(n.autoShare=e.info.autoShare),new a(n)})})},l.rename=function(e){return c.updateInfo(this.id,{title:e})},l.remove=function(){var e=this.id;return t.all({result:n.removeByPath(c.idToFilename(e)),info:i(e)}).then(function(e){if(e.info.previewImages)return t.all(e.info.previewImages.map(function(e){return n.removeByPath(e.path)}))}).then(function(){return u.remove(o(e))})},l.updateYoutubeInfo=function(e){return c.updateInfo(this.id,{youtubeInfo:e})},c.listFiles=function(){return n.listByPath("/").then(function(e){var r=[];return e.forEach(function(e){e.isFile&&"."!==e.name[0]&&r.push(a.createFromIdOrFileEntry(e))}),t.all(r).then(function(e){var t={};return e.forEach(function(e){t[e.id]=e}),t})})},c.filenameToId=function(e){if(/\.webm/i.test(e))return e.slice(0,-5);throw new Error("invalid filename: "+e)},c.idToFilename=function(e){return e+".webm"},c.getFileDescriptor=function(e){return a.createFromIdOrFileEntry(e)},c.updateInfo=function(e,r,n){var i,a=o(e);return i=n?t.when(r):u.get(a).then(function(e){return angular.extend(e[a]||{},r)}),i.then(function(e){var t={};return t[a]=e,u.set(t),e})},c}]),angular.module("castifyExt.recordTool",["castifyExt.connect.connectedApps","castifyExt.connect.appRegistry","castifyExt.hdpiTool","castifyExt.appOptions","w69b.webrtc","w69b.chromeStorage","w69b.chromeWindows","w69b.spawn","w69b.chromeSystem"]).factory("recordTool",["chromeStorage","$window","webrtc","connectedApps","appRegistry","hdpiTool","spawn","chromeSystem","castifyConfig","chromeWindows","appOptions",function(e,t,r,n,o,i,a,c,u,s,l){function d(){return t.navigator.userAgent}function f(){return Number((/Chrome\/(\d+)/.exec(window.navigator.userAgent)||[void 0,0])[1])}function p(){return d().indexOf("CrOS")>=0}function h(){return d().indexOf("Mac OS")>=0}function g(){return d().indexOf("CrOS aarch")>=0}function m(){return d().indexOf("CrOS x86_64")>=0}function v(){return g()?5:(m(),30)}function b(e){return r.getSources().then(function(t){function r(e,r){return t.some(function(t){return t.kind===e&&t.label&&(!r||r===t.id)})}return e.audio.mic&&(r("audio")?e.audio.micSourceId&&!r("audio",e.audio.micSourceId)&&delete e.audio.micSourceId:e.audio.mic=!1),r("video")?e.camSourceId&&!r("video",e.camSourceId)&&delete e.camSourceId:("cam"===e.captureSource&&(e.captureSource="tab"),e.embedWebcam&&(e.embedWebcam=!1)),e})}function y(e){return e.autoShareApp?n.isConnected(e.autoShareApp.id).then(function(t){return t||delete e.autoShareApp,e}):e}var w={},x="recordConfig",S=null;w.toResolution=function(e){return{width:e.width,height:e.height}},w.getResolutionLimit=function(e,t){return e.limitResolution?"tab"===e.captureSource?i.scaleResolution(i.toPhysicalResolution(t),e.maxResolution):e.maxResolution:null};var E=a.wrap(regeneratorRuntime.mark(function _(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(S){e.next=4;break}return e.next=3,c.cpu.getInfo();case 3:S=e.sent.numOfProcessors;case 4:return e.abrupt("return",S);case 5:case"end":return e.stop()}},_,this)})),k=a.wrap(regeneratorRuntime.mark(function A(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,E();case 2:if(e=t.sent,!(e>=4)){t.next=7;break}return t.abrupt("return",{width:1920,height:1080});case 7:return t.abrupt("return",{width:1280,height:720});case 8:case"end":return t.stop()}},A,this)})),R=a.wrap(regeneratorRuntime.mark(function C(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=g(),e.t0){e.next=6;break}return e.next=4,E();case 4:e.t1=e.sent,e.t0=e.t1<=4;case 6:return e.abrupt("return",e.t0);case 7:case"end":return e.stop()}},C,this)}));return w.canCaptureSystemAudio=function(){return d().indexOf("Windows")>=0||p()&&f()>=46},w.getRecentlyConnectedApp=function(){return n.getRecent().then(function(e){return e?o.getAppInfo(e):null})},w.clearRecentlyConnectedApp=function(){return n.clearRecent()},w.setRecordConfig=function(t){return e.local.setSingle(x,t)},w.isPreviewSupported=a.wrap(regeneratorRuntime.mark(function T(e){var t,r,n;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(t=function(){return l.values.hwEncoding||"webrtc"===l.values.encoder},r=e.captureSource,"tab"!==r){o.next=4;break}return o.abrupt("return",!1);case 4:if("cam"!==r&&h()){o.next=6;break}return o.abrupt("return",!0);case 6:return o.next=8,s.getCurrent();case 8:return n=o.sent,o.abrupt("return","fullscreen"!==n.state&&!t()&&e.embedWebcam);case 10:case"end":return o.stop()}},T,this)})),w.isInjectable=function(e){return e&&(e.startsWith("https://")||e.startsWith("http://")||e.startsWith("file://"))&&!e.startsWith("https://chrome.google.com/webstore/")},w.getRecordConfig=a.wrap(regeneratorRuntime.mark(function I(){var t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.local.getSingle(x,{});case 2:if(t=r.sent,!angular.isDefined(t.limitResolution)){r.next=7;break}r.t0=t.limitResolution,r.next=10;break;case 7:return r.next=9,R();case 9:r.t0=r.sent;case 10:if(t.limitResolution=r.t0,!t.maxResolution){r.next=15;break}r.t1=t.maxResolution,r.next=18;break;case 15:return r.next=17,k();case 17:r.t1=r.sent;case 18:if(t.maxResolution=r.t1,t.audio=angular.isObject(t.audio)?t.audio:{mic:!0,system:!1},t.draw=t.draw||{showToolbox:!0,tool:"pointer"},t.embedWebcam=t.embedWebcam||!1,t.camPosition=t.camPosition||"bottomRight",t.captureSource=t.captureSource||"desktop",t.targetFPS=t.targetFPS||v(),t.startDelay=angular.isDefined(t.startDelay)?t.startDelay:u.IS_E2E?0:3,"desktop"!==t.captureSource&&"screen"!==t.captureSource||w.canCaptureSystemAudio()||(t.audio.system=!1),r.t2=t.showPreview,!r.t2){r.next=32;break}return r.next=31,w.isPreviewSupported(t);case 31:r.t2=!r.sent;case 32:if(!r.t2){r.next=34;break}t.showPreview=!1;case 34:return t.nonpersistent={},r.next=37,b(t);case 37:return t=r.sent,r.next=40,y(t);case 40:return t=r.sent,r.abrupt("return",t);case 42:case"end":return r.stop()}},I,this)})),w}]),angular.module("castifyExt.resizeTab",["w69b.chromeTabs","w69b.chromeWindows"]).factory("resizeTab",["chromeTabs","chromeWindows","$q",function(e,t,r){function n(n,o,i,a){function c(){return e.get(n).then(function(e){return l=e})}function u(){return t.get(l.windowId).then(function(e){if("normal"!==e.state&&a===!1)return r.reject();var n=e.width-l.width,c=e.height-l.height,u=o+n+d,s=i+c+f;return t.update(l.windowId,{width:u,height:s,state:"normal"})})}function s(e){return e.width!=o||e.height!=i?(d+=o-e.width,f+=i-e.height,u().then(c)):e}var l,d=0,f=0;return c().then(u).then(c).then(s).then(s)["catch"](function(){return l})}return n}]),angular.module("castifyExt.castifyDrawService",["w69b.promiseTool","w69b.spawn"]).factory("bgCastifyDrawService",function(){return new window.BgCastifyDrawService("components/castifyDraw/release/","components/castifyDraw/release/global-ext.css")}).factory("castifyDrawService",["$q","$log","promiseTool","spawn","bgCastifyDrawService",function(e,t,r,n,o){var i={},a=1e4;return i.disposeAll=function(){o.disposeAll()},i.disposeInTab=function(e){return o.disposeInTab(e)},i.loadInTab=n.wrap(regeneratorRuntime.mark(function c(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return t.debug("chromeVideoRecorder: loading castifyDraw..."),c.prev=1,c.next=4,r.withTimeout(function(){return e.when(o.loadInTab(n,i))},a);case 4:c.next=9;break;case 6:c.prev=6,c.t0=c["catch"](1),t.warn("castifyDrawService: failed to load castify draw for tab %s",n,c.t0);case 9:case"end":return c.stop()}},c,this,[[1,6]])})),i}]),angular.module("castifyExt.recordingHooks",["castifyExt.videoPreviewRenderer","castifyExt.appOptions","castifyExt.ui.openInAppTab","castifyExt.bgFiles","castifyExt.connect.bgConnectService","w69b.spawn","w69b.clipboard","w69b.chromeRuntime","w69b.chromeTabs","w69b.filesHelper","castifyExt.recordTool"]).factory("recordingHooks",["$rootScope","$filter","videoPreviewRenderer","chromeTabs","appOptions","bgFiles","clipboard","openInAppTab","$q","$log","$timeout","filesHelper","spawn","bgConnectService",function(e,t,r,n,o,i,a,c,u,s,l,d,f,p){function h(e){l(function(){c("app.html#/files/"+encodeURIComponent(e))},500)}function g(e){if(0===e.lastIndexOf(k,0)){var t=e.substr(k.length);n.create({url:t}),chrome.notifications.clear(e)}}function m(e,r){function n(e){return t("date")(e,"MMM d, y h:mm a")}var a=o.values.videoTitleNamingScheme,c=void 0;return c="tab"===r.captureSource&&"tabTitle"===a&&r.tabTitle?""+r.tabTitle:""+n(Date.now()),i.rename(e,c)}function v(e,t){if(!t.config.isSyncUpload){var r=t.config,n=t.link;if(/https?:\/\//.test(n)){var o='Your screencast "'+r.title+'" has been uploaded. Click here to open it.';r.copyLinkToClipboard&&(a.copy(n),o+=" The link was copied to your clipboard.");var i={type:"basic",priority:0,title:"Upload complete",message:o,iconUrl:"images/icon128.png"};r.showNotification&&chrome.notifications.create(k+n,i,angular.noop)}}}function b(e){return d.getFileEntryByPath(e).then(function(e){return d.getMetadata(e)}).then(function(e){return e.size})}function y(e){return r.renderPreview(e)["catch"](function(t){s.warn("rendering preview image failed",e);var r=i.idToLocalFilename(e);return b(r).then(function(e){return e<R?(s.warn("file is empty, removing it"),d.removeByPath(r),u.reject(t)):null})})}function w(e,t){return f(regeneratorRuntime.mark(function r(){var n,o,a;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.autoShareApp.id,o=t.connectMeta&&t.connectMeta.shareUrl,a=t.connectMeta&&t.connectMeta.payload,r.next=5,i.updateLocalInfo(e,{autoShare:{appId:n,shareUrl:o,payload:a,timestamp:Date.now()}});case 5:return r.next=7,i.registerLocalFile(e);case 7:return r.next=9,p.share(n,e,o);case 9:case"end":return r.stop()}},r,this)}))}function x(e,t,r){return f(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,y(t);case 2:if(!r.autoShareApp){n.next=7;break}return n.next=5,w(t,r);case 5:n.next=12;break;case 7:return n.next=9,i.registerLocalFile(t);case 9:return n.next=11,m(t,r);case 11:o.values.autoOpen&&"recorder:fixedFile"!==e.name&&h(t);
case 12:s.debug("recording hooks completed for",t);case 13:case"end":return n.stop()}},n,this)}))}var S=[],E={},k="upload:",R=1e4;return E.install=function(){S=[e.$on("recorder:stopped",x),e.$on("recorder:fixedFile",x),e.$on("uploader:complete",v)],chrome.notifications.onClicked.addListener(g)},E.uninstall=function(){S.forEach(function(e){e()}),S=[],chrome.notifications.onClicked.removeListener(g)},E}]),angular.module("castifyExt.videoPreviewRenderer",["castifyExt.bgFiles","w69b.filesHelper","w69b.promiseTool"]).factory("videoPreviewRenderer",["bgFiles","filesHelper","$q","promiseTool",function(e,t,r,n){function o(e){return t.getFileEntryByPath(l+"/"+e,{create:!0},{create:!0})}function i(e,t){var r=Math.max(t.width/e.width,t.height/e.height);return{width:e.width*r,height:e.height*r}}function a(e){function t(){o.resolve(i)}function n(){o.reject("failed to load video")}var o=r.defer(),i=document.createElement("video");return i.src=e,i.addEventListener("canplay",t),i.addEventListener("error",n),o.promise["finally"](function(){i.removeEventListener("canplay",t),i.removeEventListener("error",n)}),o.promise}function c(e){for(var t=window.atob(e),r=new Uint8Array(new ArrayBuffer(t.length)),n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}function u(e){var t=e.toDataURL(),n="data:image/png;base64,";if(0!==t.lastIndexOf(n,0))throw Error();var o=t.substring(n.length);return o=new Uint8Array(c(o)),r.when(new Blob([o],{type:"image/png"}))}function s(e,t){var r=document.createElement("canvas");r.width=t.width,r.height=t.height;var n=r.getContext("2d");return n.drawImage(e,0,0,t.width,t.height),u(r)}var l="_previewImages",d={width:640,height:360},f={};return f.renderPreview=function(r){return n.withTimeout(function(){var n,c,u,f=r+".png",p={};return t.getFileEntryByPath(e.idToLocalFilename(r)).then(function(e){return a(e.toURL())}).then(function(e){var t={width:e.videoWidth,height:e.videoHeight};return p.size=t,p.duration=e.duration,u=i(t,d),s(e,u)}).then(function(e){return n=e,o(f)}).then(function(e){return c=e,t.createWriter(c)}).then(function(e){return t.writeFile(e,n)}).then(function(){var t={path:l+"/"+f,size:u,url:c.toURL()};return e.updateLocalInfo(r,{previewImages:[t],videoInfo:p})}).then(function(){return c})},3e3)},f}]),angular.module("castifyExt.updateMigrationService",["w69b.chromeRuntime","w69b.chromeVersionOrder","castifyExt.hdpiTool","castifyExt.appOptions","w69b.chromeAnalytics","w69b.chromeStorage"]).factory("updateMigrationService",["chromeRuntime","$log","chromeVersionOrder","analytics","chromeStorage","appOptions","hdpiTool",function(e,t,r,n,o,i,a){function c(e){return{path:{19:"images/"+e+"19.png",38:"images/"+e+"38.png"}}}function u(e,n){e!==n&&(t.info("updating from "+e+" to "+n),r.isLess(e,"1.35.0")&&o.sync.setSingle("showOldIcon",!0))}function s(){n.sendNonInteractionEvent("install","success"),o.local.setSingle("tos_confirmed",!0)}function l(n){t.debug("installed",n);var o=e.getManifest().version;"update"===n.reason&&u(n.previousVersion,o),"install"===n.reason&&s(),n.previousVersion&&!r.isLessOrEqual(n.previousVersion,"1.33.5")||f()}function d(e){var t=c(e?"icon_old":"icon");chrome.browserAction.setIcon(t)}var f=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,n,o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(o=function(){var e=a.getScreenCssResolution();return e=a.toPhysicalResolution(e),e.width<=1920},n=function(){return e().indexOf("CrOS aarch")>=0},e=function(){return window.navigator.userAgent},!(n()||o()&&Math.random()<.01)){r.next=11;break}return t.info("enabling hardware encoding by default"),r.next=7,i.loadedPromise;case 7:i.values.hwEncoding=!0,i.save(),r.next=12;break;case 11:t.info("NOT enabling hardware encoding by default");case 12:case"end":return r.stop()}},r,this)}));return function(){return e.apply(this,arguments)}}(),p={};return p.install=function(){e.onInstalled.addListener(l)},o.onChanged.addListener(function(e,t){"sync"==t&&e.showOldIcon&&d(e.showOldIcon.newValue)}),p}]),angular.module("castifyExt.setupService",["castifyExt.appOptions","w69b.webrtc","w69b.chromeStorage","w69b.spawn","castifyExt.connect.connectedApps","castifyExt.userAccount","castifyExt.optionalPermissions"]).factory("setupService",["webrtc","spawn","chromeStorage","appOptions","$log","optionalPermissions","userAccount","$http","castifyConfig","$location","connectedApps",function(e,t,r,n,o,i,a,c,u,s,l){function d(){return t(regeneratorRuntime.mark(function r(){var t,n,o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return t=e.hasVideoAccess(),n=e.hasMicrophone(),o=e.hasAudioAccess(),r.next=5,t;case 5:if(r.t0=r.sent,r.t0){r.next=15;break}return r.next=9,n;case 9:if(r.t1=!r.sent,r.t1){r.next=14;break}return r.next=13,o;case 13:r.t1=r.sent;case 14:r.t0=r.t1;case 15:return r.abrupt("return",r.t0);case 16:case"end":return r.stop()}},r,this)}))}var f={},p="setupService:welcomeShown",h=u.API_URL+"/survey_questions";return f.setSetupComplete=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return r.sync.setSingle(p,e)},f.getSetupComplete=function(){return r.sync.getSingle(p,!1)},f.getDriveSyncEnabled=t.wrap(regeneratorRuntime.mark(function g(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.loadedPromise;case 2:return e.abrupt("return",n.values.driveSync);case 3:case"end":return e.stop()}},g,this)})),f.getSetupState=function(){return t(regeneratorRuntime.mark(function e(){var t,r,n,o,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([a.getAccount(),i.hasLiteTabPermissions(),d(),f.getDriveSyncEnabled()]);case 2:return t=e.sent,r=_slicedToArray(t,4),n=r[0],o=r[1],c=r[2],u=r[3],e.abrupt("return",{tab:o,cam:c,signedIn:!!n.user,filledSurvey:!!n.user&&!!n.user.survey&&!!n.user.survey.user_type,driveSync:u});case 9:case"end":return e.stop()}},e,this)}))},f.isComplete=function(){return t(regeneratorRuntime.mark(function e(){var t,r,n,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([f.getSetupState(),l.hasConnectedApps(),f.getSetupComplete()]);case 2:return t=e.sent,r=_slicedToArray(t,3),n=r[0],i=r[1],a=r[2],o.debug("setupService.isComplete state",n,i),e.abrupt("return",n.signedIn||i||n.tab||a);case 9:case"end":return e.stop()}},e,this)}))},f.smartRoute=t.wrap(regeneratorRuntime.mark(function m(e){var t,r,n,o,i,a;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,f.getSetupState();case 2:if(t=c.sent,r=t.signedIn,n=t.tab,o=t.cam,i=t.filledSurvey,a=n&&o,r){c.next=12;break}return c.abrupt("return",f.goToPage("/signin"));case 12:if(e||a){c.next=16;break}return c.abrupt("return",f.goToPage("/permissions"));case 16:if(i){c.next=20;break}return c.abrupt("return",f.goToPage("/survey"));case 20:f.goToPage("/final");case 21:case"end":return c.stop()}},m,this)})),f.goToPage=function(e){s.path("/setup"+e)},f.postSurvey=function(e){return a.postUpdate({survey:e})},f.fetchSurveyQuestions=function(){return c.get(h).then(function(e){return e.data})},f.updateStorage=function(e){n.values.driveSync=e,n.save()},f}]),angular.module("castifyExt.diskSpaceWatcher",["castifyExt.bgRecord","w69b.filesHelper","w69b.ui.bytesFilter","castifyExt.appOptions","w69b.chromeNotifications","castifyExt.helpCenter"]).factory("diskSpaceWatcher",["bgRecordService","$timeout","filesHelper","$rootScope","$filter","appOptions","chromeNotifications","helpCenter","$log",function(e,t,r,n,o,i,a,c,u){function s(){return m}function l(){return r.getPersistentQuota().then(function(e){return e.quota-e.usage})}function d(t){var r={priority:2,title:"Critically low disk space",message:"You have less than 1GB left. Recording was paused automatically.",buttons:[{title:"Help"}]};a.clear("diskSpaceCritical")["finally"](function(){c.setNotifyHelp(a.simple.create(r,"diskSpaceCritical"),"disk_space")}),u.info("diskSpaceWatcher: auto-pausing on critical low space"),e.pause()}function f(e){e+=1073741824;var t={priority:2,title:"Low disk space",message:"You have only "+o("bytes")(e)+" left. Recording will be paused automatically soon.",buttons:[{title:"Help"}]};c.setNotifyHelp(a.simple.create(t,"diskSpaceLow"),"disk_space")}function p(){h(),i.values.enableDiskSpaceWatcher&&l().then(function(e){e<=s()?d(e):e<=v&&f(e),e>s()&&(g=t(p,b))})}function h(){g&&(t.cancel(g),g=null)}var g,m=0,v=104857600,b=1e4,y={};return y.install=function(){n.$watch(function(){return"recording"===e.getRecorderState().state&&!e.isBlocked()},function(e,t){e!==t&&(e?p():h())}),n.$on("recorder:stopped",function(){a.clear("diskSpaceCritical"),a.clear("diskSpaceLow")})},y.setThresholds=function(e,t){m=t,v=e},y}]),angular.module("castifyExt.audioContextPool",[]).factory("audioContextPool",["$window",function(e){var t=[],r={};return r.acquire=function(){return t.length?t.pop():new e.AudioContext({latencyHint:"playback"})},r.release=function(e){t.push(e)},r}]),angular.module("castifyExt.ui.openInAppTab",["w69b.chromeTabs","w69b.chromeWindows"]).service("openInAppTab",["chromeTabs","chromeRuntime","chromeWindows","$q",function(e,t,r,n){return function(n){var o="chrome-extension://"+t.id+"/app.html";return 0===n.lastIndexOf("#",0)&&(n=o+n),e.create({active:!0,url:n}).then(function(e){r.update(e.windowId,{focused:!0})})}}]).directive("openInAppTab",["$window","openInAppTab",function(e,t){return{restrict:"A",link:function(r,n,o){n.bind("click",function(r){var n=angular.element(r.target),i=o.href||n.attr("href");i&&(r.preventDefault(),t(i).then(function(){e.close()}))})}}}]),angular.module("castifyExt.ui.audioCountdown",[]).factory("audioCountdown",["$q","$timeout",function(e,t){function r(){n||(n=new Audio(i))}var n,o,i="components/castifyExt/ui/audio-countdown.dat",a=10,c=0,u=0,s=!1,l={};return l.load=function(t){s=!0,r();var o=e.defer();return n.addEventListener("canplay",function i(){n.removeEventListener("canplay",i),o.resolve()}),n.error?(s=!1,o.reject("failed to load audio countdown: "+(n.error&&n.error.code))):n.addEventListener("error",function u(){s=!1,n.removeEventListener("error",u),o.reject("failed to load audio countdown: "+(n.error&&n.error.code))}),n.currentTime=Math.max(a-t,0),c=1e3*Math.max(t-a,0),o.promise},l.pause=function(){n&&s&&(o?(t.cancel(o),o=null,c-=Date.now()-u):n.pause())},l.start=function(){n&&s&&!n.ended&&(u=Date.now(),c?o=t(function(){o=null,n.play()},c):n.play())},l.stop=function(){l.pause(),s=!1},l}]),angular.module("castifyExt.ui.countdownIcon",["w69b.spawn"]).factory("countdownIcon",["spawn","$q",function(e,t){function r(e){var r=o.get(e);if(r)return r;var n="images/icon"+e+".png",i=t.defer(),a=new Image;return a.addEventListener("load",function c(){a.removeEventListener("load",c),i.resolve(a)}),a.src=n,o.set(e,i.promise),i.promise}var n={},o=new Map,i={path:{19:"images/icon_countdown19.png",38:"images/icon_countdown38.png"}},a=e.wrap(regeneratorRuntime.mark(function c(e,t){var n,o,i,a;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return n=document.createElement("canvas"),n.width=e,n.height=e,o=n.getContext("2d"),i=38,a=e/i,o.scale(a,a),c.t0=o,c.next=10,r(i);case 10:return c.t1=c.sent,c.t0.drawImage.call(c.t0,c.t1,0,0),o.font="bold 35px sans-serif",o.textBaseline="middle",o.textAlign="center",o.fillStyle="red",o.fillText(t,i/2,i/2),c.abrupt("return",o.getImageData(0,0,n.width,n.height));case 18:case"end":return c.stop()}},c,this)}));return n.getIcon=e.wrap(regeneratorRuntime.mark(function u(e){return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(e=Math.ceil(-e),!(e>=10)){r.next=3;break}return r.abrupt("return",t.when(i));case 3:return r.next=5,a(38,e);case 5:return r.t0=r.sent,r.t1={38:r.t0},r.abrupt("return",{imageData:r.t1});case 8:case"end":return r.stop()}},u,this)})),n}]),angular.module("castifyExt.bgLicensing",["castifyExt.castifyAuth","w69b.chromeStorage","w69b.chromeRuntime","w69b.spawn","w69b.promiseTool","castifyExt.connect.connectedApps"]).factory("bgLicensing",["castifyAuth","$http","chromeRuntime","chromeStorage","$q","$log","castifyConfig","promiseTool","spawn","connectedApps",function(e,t,r,n,o,i,a,c,u,s){function l(t){return e.getAuthToken({interactive:t})}function d(){function e(){var e=window.chrome.identity,t=c.wrapChromeError(e.getAuthToken,e);return t({interactive:!1,scopes:["email","https://www.googleapis.com/auth/chromewebstore.readonly"]})}function i(){return u(regeneratorRuntime.mark(function n(){var o,i,a,c,u;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return o=h+r.id,n.next=3,e();case 3:return i=n.sent,n.next=6,t.get(o,{headers:{Authorization:"Bearer "+i}});case 6:if(a=n.sent,c=a.data,!c.result||!c.createdTime){n.next=11;break}return u=new Date(Number(c.createdTime)),n.abrupt("return",u<g);case 11:return n.abrupt("return",!1);case 12:case"end":return n.stop()}},n,this)}))}return n.sync.getSingle(m).then(function(e){return angular.isDefined(e)?e:o.reject()})["catch"](function(){return i().then(function(e){return n.sync.setSingle(m,e),e})})["catch"](function(){return!1})}function f(){return s.getConnectedAppInfo().then(function(e){var t=Date.now(),r=e.some(function(e){return e.isPaidInstall&&(!e.userExpiryDate||e.userExpiryDate>=t)});return r?{access:"full",type:"app",maxAgeSecs:3600}:null})}function p(e){function t(){var t="trial";return e&&(t=e.access,e.type&&(t+="_"+e.type)),t}function r(){return!y||e&&("tester"===e.access||"full"==e.access)}function n(){return!r()}function o(){return!(e&&!e.branding||r())}function i(){return!(!e||"full"!==e.access)}function a(){return!(!e||"tester"!==e.access)}function c(){return r()?Number.MAX_SAFE_INTEGER:v}function u(){return n()}function s(){return u()?b:Number.MAX_SAFE_INTEGER}var l=0;return e&&(l=Date.now()+1e3*e.maxAgeSecs),{validTill:l,type:t(),branding:o(),isTester:a(),isPaid:i(),limitLength:n(),maxLength:c(),limitNumRecordings:u(),maxNumRecordings:s()}}var h="https://www.googleapis.com/chromewebstore/v1.1/userlicenses/",g=1413892757176,m="cws_license",v=600,b=50,y=!0,w={};return w.getLicense=function(){function e(){return o.all([d(),f()]).then(function(e){var t=e[0],r=e[1];return r?r:t?{access:"tester",maxAgeSecs:2}:null})}var t=l().then(e,f).then(function(e){return e}).then(p);return t["catch"](function(e){i.debug("local update failed",e)}),t},w}]),angular.module("castifyExt.driveFileDb",["w69b.chromeStorage","w69b.spawn","castifyExt.driveUtils","castifyExt.offline","castifyExt.castifyAuth"]).factory("driveFileDb",["googledrive","driveUtils","castifyAuth","$q","onlineState","chromeStorage","spawn",function(e,t,r,n,o,i,a){function c(e,t){if(e){var r=e.match(/(.*)=s\d+$/);if(r)return r[1]+"=s"+t}return e}function u(e){var t=[];return angular.forEach(e,function(e,r){angular.isObject(e)?angular.forEach(e,function(e,n){t.push({key:r+"_"+n,value:e,visibility:"PRIVATE"})}):t.push({key:r,value:e,visibility:"PRIVATE"})}),t}function s(e){var t={};return e.forEach(function(e){if("PRIVATE"===e.visibility){if(e.key.indexOf("_")>0){var r=e.key.split("_",2),n=r[0],o=r[1];t[n]||(t[n]={}),t[n][o]=e.value}t[e.key]=e.value}}),t}function l(e){this.updateFromDriveResource_(e)}function d(){return n.when(i.local.getSingle(h,[]))}function f(e){i.local.setSingle(h,e)}var p=400,h="drive_files",g={},m=l.prototype;return m.updateFromDriveResource_=function(e){var t=s(e.properties),r={id:t.uuid,driveId:e.id,thumbnailUrl:c(e.thumbnailLink,p),createdAt:new Date(t.recordingDate?Number(t.recordingDate):e.createdDate),url:e.downloadUrl,urlRequiresAccessToken:!0,mimeType:e.mimeType,size:Number(e.fileSize),duration:Number(t.duration),width:Number(t.width),height:Number(t.height),driveInfo:e},n="."+e.fileExtension;e.fileExtension&&e.title.indexOf(n,e.title.length-n.length)!==-1?r.title=e.title.slice(0,-n.length):r.title=e.title,t.youtubeInfo&&(r.youtubeInfo=t.youtubeInfo),angular.extend(this,r)},m.remove=function(){return e.trashFile(this.driveId)},m.rename=function(t){var r=this.driveInfo.fileExtension;return r&&(r="."+r,t.indexOf(r,t.length-r.length)<0&&(t+=r)),e.patchFile(this.driveId,{title:t}).then(this.updateFromDriveResource_.bind(this))},m.updateYoutubeInfo=function(t){var r=s(this.driveInfo.properties);return r.youtubeInfo=t,e.patchFile(this.driveId,{properties:u({youtubeInfo:t})})},g.getFileDescriptor=function(t){var r="trashed = false and properties has { key='uuid' and value='"+t+"' and visibility='PRIVATE' }";return e.listFiles({maxResults:1,q:r}).then(function(e){return e.length?e[0]:n.reject()}).then(function(e){return new l(e)})},g.listFiles=function(){return a(regeneratorRuntime.mark(function r(){var n,i;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(!o.isOnline()){r.next=19;break}return r.prev=1,r.next=4,t.getDriveUploadParentId().then(function(t){var r="'"+t+"' in parents and trashed = false and properties has { key='isScreencastifySyncFile' and value='true' and visibility='PRIVATE' }";return e.listFiles({maxResults:1e3,q:r})});case 4:n=r.sent,f(n),r.next=17;break;case 8:if(r.prev=8,r.t0=r["catch"](1),!r.t0||!(r.t0.status<=0||r.t0.status>=500)){r.next=16;break}return r.next=13,d();case 13:n=r.sent,r.next=17;break;case 16:throw r.t0;case 17:r.next=22;break;case 19:return r.next=21,d();case 21:n=r.sent;case 22:return i={},n.forEach(function(e){var t=new l(e);i[t.id]=t}),r.abrupt("return",i);case 25:case"end":return r.stop()}},r,this,[[1,8]])}))},g}]),angular.module("castifyExt.bgFiles",["castifyExt.localFileDb","castifyExt.driveFileDb","w69b.chromeRuntime","castifyExt.appOptions","castifyExt.syncAuthTool","castifyExt.offline","w69b.spawn"]).factory("bgFiles",["localFileDb","driveFileDb","$q","$rootScope","chromeRuntime","appOptions","$log","syncAuthTool","$interval","onlineState","spawn",function(e,t,r,n,o,i,a,c,u,s,l){function d(e,t){this.$localDesc=e,this.$driveDesc=t,this.ownProperties_={}}function f(e){this.port=e}function p(e){return c.broadcastIfSyncError(e)}function h(){return i.values.driveSync}function g(e){var t={};return P.forEach(function(r){var n=e[r];angular.isDefined(n)&&(n instanceof Date&&(n=n.getTime()),t[r]=n)}),t}function m(e){var t={};return angular.forEach(e,function(e,r){t[r]=g(e)}),t}function v(){T++,A.listFiles().then(function(e){var t={full:m(e)};b("filesUpdate",t)})}function b(e,t){C.forEach(function(r){r.subscribed&&r.postMessage(e,t)})}function y(e){T++;var t=_[e],r={};t?(r.add={},r.add[e]=g(t)):r.remove=[e],b("filesUpdate",r)}function w(e){if("files"==e.name){var t=new f(e);C.push(t),e.onDisconnect.addListener(function(){var e=C.indexOf(t);e>=0&&C.splice(e,1)});var r={remove:A.remove,reload:function(e){A.reload(e).then(function(){t.postMessage("reloadSuccess",e)},function(){t.postMessage("reloadError",e)})},rename:function(e){A.rename(e.id,e.title)},removeAll:A.removeAll,subscribe:function(){t.subscribed=!0,t.postFiles()}};e.onMessage.addListener(function(e){r.hasOwnProperty(e.type)&&r[e.type](e.data)})}}function x(){return null}function S(e){a.debug("bgFiles: sync setting changed to "+e+" clearing cache"),A.clearCache(),C.length&&v(),n.$broadcast("bgFiles:syncSettingChanged",e)}function E(e){e&&k()}function k(){A.clearCache(),v()}var R,_={},A={},C=[],T=0,I=["id","size","width","height","duration","title","thumbnailUrl","createdAt","url","driveInfo","youtubeInfo","urlRequiresAccessToken","autoShare","mimeType"],P=I.concat(["isSynced","isLocal"]),$=d.prototype;return $.preferDriveDelegate_=function(){return this.$driveDesc?this.$driveDesc:this.$localDesc},$.preferLocalDelegate_=function(){return this.$localDesc?this.$localDesc:this.$driveDesc},$.getDelegate_=function(e){return this.ownProperties_.hasOwnProperty(e)?this.ownProperties_:"thumbnailUrl"===e||"urlRequiresAccessToken"===e||"url"===e?this.preferLocalDelegate_():this.preferDriveDelegate_()},$.callOnBoth_=function(e,t){t=Array.prototype.slice.call(arguments,1);var n,o=this;return n=o.$driveDesc?o.$driveDesc[e].apply(o.$driveDesc,t)["catch"](p):r.when(),n.then(function(){if(o.$localDesc)return o.$localDesc[e].apply(o.$localDesc,t)})},$.reload=function(){var n=[],o=this;o.$driveDesc&&n.push(t.getFileDescriptor(o.id).then(function(e){o.$driveDesc=e})),o.$localDesc&&n.push(e.getFileDescriptor(o.id).then(function(e){o.$localDesc=e}));var i=r.all(n).then(function(){o.ownProperties_={}});return i["finally"](function(){y(o.id)}),i},$.rename=function(e){var t=this,r=t.title;t.title=e;var n=t.callOnBoth_("rename",e);return n["catch"](function(){t.title=r}),n["finally"](function(){y(t.id)}),n},$.remove=function(){a.debug("bgFiles.remove",this.id);var e=this,t=e.callOnBoth_("remove");return t.then(function(){delete _[e.id],n.$broadcast("bgFiles:fileRemoved",e.id)}),t["finally"](function(){y(e.id)}),t},$.updateYoutubeInfo=function(e){var t=this,r=t.youtubeInfo;t.youtubeInfo=e;var n=t.callOnBoth_("updateYoutubeInfo",e);n["catch"](function(){t.youtubeInfo=r}),n["finally"](function(){y(t.id)})},I.forEach(function(e){Object.defineProperty($,e,{get:function(){var t=this.getDelegate_(e);return t?t[e]:null},set:function(t){this.ownProperties_[e]=t}})}),Object.defineProperty($,"isSynced",{get:function(){return!!this.$driveDesc}}),Object.defineProperty($,"isLocal",{get:function(){return!!this.$localDesc}}),$=f.prototype,$.postMessage=function(e,t){C.indexOf(this)<0||this.port.postMessage({type:e,data:t})},$.postFiles=function(){var e=this;A.listFiles().then(function(t){e.postMessage("filesUpdate",{full:m(t)})},function(t){a.warn("initial MessageClient subscribe postFiles failed",t),e.postMessage("filesUpdate",{error:!0})})},A.getFileDescriptor=function(e){return _[e]?r.when(_[e]):A.listFiles().then(function(t){return t[e]?t[e]:r.reject()})},A.listFiles=function(){if(!R){var n=i.loadedPromise.then(function(){return h()?t.listFiles():r.when({})});R=r.all({local:e.listFiles(),drive:n}).then(function(e){var t=Object.keys(e.local).concat(Object.keys(e.drive));return t.forEach(function(t){var r=e.local[t],n=e.drive[t],o=new d(r,n);_[o.id]=o}),_}),R["catch"](p),R["catch"](function(){R=null})}return R},A.removeAll=function(){var e=A.listFiles().then(function(e){return r.all(Object.keys(e).map(function(e){return A.remove(e)}))});return e["catch"](v),e},A.remove=function(e){return A.getFileDescriptor(e).then(function(e){return e.remove()})},A.rename=function(e,t){return A.getFileDescriptor(e).then(function(e){return e.rename(t)})},A.reload=function(e){return A.getFileDescriptor(e).then(function(e){return e.reload()})},A.clearCache=function(){R=null,angular.copy({},_)},A.idToLocalFilename=function(t){return e.idToFilename(t)},A.getFile=function(t){return e.getFile(t)},A.localFilenameToId=function(t){return e.filenameToId(t)},A.updateLocalInfo=function(t,r){return e.updateInfo(t,r).then(function(){A.reload(t).then(function(){y(t)})})},A.updateYoutubeInfo=function(e,t){return A.getFileDescriptor(e).then(function(e){return e.updateYoutubeInfo(t)})},A.getListVersionId=function(){return T},A.isSyncEnabled=h,A.registerLocalFile=function(t){return l(regeneratorRuntime.mark(function r(){var o,i;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.getFileDescriptor(t);case 2:return o=r.sent,r.next=5,A.getFileDescriptor(t)["catch"](function(){return new d(o,null)});case 5:i=r.sent,_[i.id]=i,y(t),n.$broadcast("bgFiles:localFileCreated",t);case 9:case"end":return r.stop()}},r,this)}))},A.refresh=function(n){if(!/^[0-9a-zA-Z-]*$/.test(n))throw new Error("invalid file id");return r.all({proxy:A.getFileDescriptor(n)["catch"](x),drive:t.getFileDescriptor(n)["catch"](x),local:e.getFileDescriptor(n)["catch"](x)}).then(function(e){var t=e.proxy;if(!t){if(!e.drive&&!e.local)return r.reject();t=new d(e.local,e.drive),_[t.id]=t}t.$driveDesc=e.drive,t.$localDesc=e.local,t.$driveDesc||t.$localDesc||(t.deleted=!0,delete _[n]),y(n)})},A.install=function(){u(k,9e5),n.$on("onlineState:changed",E),n.$on("event:userAccountChanged",k),i.loadedPromise.then(function(){n.$watch(h,function(e,t){t!==e&&S(e)})}),o.onConnect.addListener(w)},A}]),angular.module("castifyExt.licenseEnforcer",["castifyExt.bgRecord","castifyExt.userAccount","w69b.chromeTabs"]).factory("licenseEnforcer",["bgRecordService","$rootScope","userAccount","chromeTabs","$log","analytics",function(e,t,r,n,o,i){function a(e){var t="https://www.screencastify.com/buy?utm_source=app&utm_medium="+e+"&utm_campaign=recording_length";n.create({url:t})}function c(){o.debug("recordLimitReached"),i.sendNonInteractionEvent("recording_limit","notify","",1);var t={type:"basic",priority:2,title:"Recording stopped",message:"You have reached the recording limit of Screencastify Lite. Please upgrade to record longer screencasts",iconUrl:"images/icon128.png"};chrome.notifications.clear("recordLimitInfo",angular.noop),chrome.notifications.clear("recordLimitReached",angular.noop),chrome.notifications.create("recordLimitReached",t,angular.noop),e.stop(),a("auto")}function u(e){o.debug("recordLimitApproaching");var t={type:"basic",priority:2,title:"Approaching free recording limit",message:"Recording will be stopped automatically in "+e+" seconds. Please upgrade Screencastify to record longer screencasts.",iconUrl:"images/icon128.png"};chrome.notifications.create("recordLimitInfo",t,angular.noop)}function s(e){"recordLimitReached"!==e&&"recordLimitInfo"!==e||(a("notify"),chrome.notifications.clear(e,angular.noop))}var l=30,d={};return d.install=function(){function n(){var t=e.getConfig();return t.autoShareApp&&t.autoShareApp.isPaid}function o(){r.getAccount().then(function(e){i=e.license.maxLength})}var i=Number.MAX_VALUE;t.$on("event:userAccountChanged",o),o(),t.$watch(function(){return e.getRecorderState().time>=i},function(e){e&&!n()&&c()}),t.$watch(function(){return i-Math.ceil(e.getRecorderState().time)},function(e){e>0&&e<=l&&!n()&&u(e)}),t.$on("recorder:stopped",function(){chrome.notifications.clear("recordLimitInfo",angular.noop)})},chrome.notifications.onClicked.addListener(s),d}]),angular.module("castifyExt.bgMessages",["castifyExt.ui.openInAppTab","castifyExt.connect.connectedApps","castifyExt.userAccount"]).factory("bgMessages",["chromeRuntime","chromePersistentLogger","openInAppTab","chromeTabs","castifyAuth","connectedApps","userAccount","bgFiles","$log","$timeout",function(e,t,r,n,o,i,a,c,u,s){function l(r,n,o){if("bg:load"===r&&h)e.sendMessage("bg:loaded")["catch"](function(){return null});else if("bg:flushLogs"===r)return t.save().then(function(){o(!0)}),!0;return!1}function d(t){return"chrome-extension://"+e.id+"/app.html#"+t}function f(t,r,c){if("bg:launchApp"===t||t&&"bg:launchApp"===t.type)return p(t.data,r).then(function(){return c(!0)})["catch"](function(e){u.warn("launchApp error:",e),c(!1)}),!0;if("bg:launchSupport"===t)n.create({url:d("/support")});else{if("bg:getSignInToken"===t)return o.getAuthToken({interactive:!0}).then(function(e){c(e)},function(){c(!1)}),!0;if("bg:updateLicense"===t)a.update();else if("bg:isInstalled"===t)c(e.getManifest().version);else{if(t&&"bg:connectApp"===t.type)return i.connect(t.data).then(function(){c(!0)},function(){c(!1)}),!0;if("bg:getLicenseInfo"===t)return a.getAccount().then(function(e){var t={isPaid:e.license.isPaid,isTester:e.license.isTester};e.user&&(t.email=e.user.email,t.analyticsUid=e.user.analyticsUid),t.license=e.license,t.user=e.user,c(t)}),!0}}return!1}var p=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e,r){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(u.debug("handling bg:launchApp",e),r.tab&&r.tab.id){t.next=3;break}return t.abrupt("return");case 3:if(!e){t.next=11;break}return t.next=6,c.refresh(e);case 6:return t.next=8,s(g);case 8:n.update(r.tab.id,{url:d("/files/"+e)}),t.next=12;break;case 11:n.update(r.tab.id,{url:d("/")});case 12:case"end":return t.stop()}},t,this)}));return function(t,r){return e.apply(this,arguments)}}(),h=!1,g=500,m={};return m.install=function(){e.onMessage.addListener(l),e.onMessageExternal.addListener(f)},m.initializationCompleted=function(){e.sendMessage("bg:loaded")["catch"](function(){return null}),h=!0},m}]),angular.module("castifyExt.chromeEventPublisher",[]).run(["chromeRuntime","$rootScope",function(e,t){var r="event:";e.onMessage.addListener(function(e){angular.isObject(e)&&angular.isString(e.type)&&0===e.type.lastIndexOf(r,0)&&t.$broadcast(e.type,e.data),t.$$phase||t.$digest()})}]),angular.module("castifyExt.driveUtils",["w69b.googledrive","castifyExt.castifyAuth","w69b.es6","w69b.spawn","w69b.chromeStorage"]).factory("driveUtils",["googledrive","$q","spawn","$log","chromeStorage","$rootScope","$timeout",function(e,t,r,n,o,i,a){function c(){return n.debug("driveUtils: creating Drive folder"),e.postFile({title:"Screencastify",mimeType:"application/vnd.google-apps.folder",description:"Screencastify uses this folder to store Screencasts that you upload. You may rename or move it, it will upload to this folder.",properties:[{key:"isScreencastifyUploadFolder",value:!0,visibility:"PRIVATE"}]})}function u(e){if(e&&e.data){var t,r=e.data;if(r.error&&r.error.errors&&r.error.errors.length&&(t=r.error.errors[0]),t)return t.reason}else if(e&&e.message)return e.message;return null}function s(r){return e.getFile(r).then(function(e){return!e.labels.trashed},function(e){return 404!==e.status&&(n.warn("driveUtils: checkIfExists failed",e),t.reject(e))})}function l(){var t="mimeType = 'application/vnd.google-apps.folder' and trashed = false and properties has { key='isScreencastifyUploadFolder' and value='true' and visibility='PRIVATE' }";return e.listFiles({q:t,maxResults:1}).then(function(e){return n.debug("driveUtils: findFolder items #",e.length),e.length?e[0]:null})}function d(e,t){var r=e.filter(function(e){return e.type===t});return r.length?r[0]:null}function f(e){return d(e,"anyone")}function p(e){return d(e,"domain")}function h(e){var t=f(e),r=p(e);return t?t.withLink?"unlisted":"public":r?r.withLink?"domain_unlisted":"domain_public":"private"}function g(){m=null,o.sync.remove(y)}var m,v,b={},y="DRIVE_FOLDER_ID",w=1e4;return b.getDriveUploadParentId=function(e){return m&&!e||(m=r(regeneratorRuntime.mark(function t(){var e,r,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o.sync.getSingle(y);case 2:if(e=t.sent,t.t0=e,!t.t0){t.next=8;break}return t.next=7,s(e);case 7:t.t0=t.sent;case 8:if(!t.t0){t.next=11;break}return n.debug("driveUtil: using cached parent Id",e),t.abrupt("return",e);case 11:return t.next=13,l();case 13:if(r=t.sent){t.next=18;break}return t.next=17,c();case 17:r=t.sent;case 18:return i=r.id,t.next=21,o.sync.setSingle(y,i);case 21:return t.abrupt("return",i);case 22:case"end":return t.stop()}},t,this)})),m["catch"](function(e){b.isRateLimitError(e)?(v&&a.cancel(v),v=a(function(){m=null,v=null},w)):m=null})),m},b.getSimplePrivacy=function(t){return e.listPermissions(t).then(h)},b.getLink=function(e){return"https://drive.google.com/file/d/"+e+"/view"},b.setSimplePrivacy=function(n,o,i){var a=o.startsWith("domain_");if(a&&!i)throw new Error;return r(regeneratorRuntime.mark(function c(){var r,u,s,l;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,e.listPermissions(n);case 2:if(r=c.sent,u=f(r),s=p(r),h(r)!==o){c.next=9;break}return c.abrupt("return",t.when(null));case 9:if("private"!==o){c.next=18;break}if(!u){c.next=13;break}return c.next=13,e.removePermission(n,u.id);case 13:if(!s){c.next=16;break}return c.next=16,e.removePermission(n,s.id);case 16:c.next=27;break;case 18:if(!u){c.next=21;break}return c.next=21,e.removePermission(n,u.id);case 21:if(!s){c.next=24;break}return c.next=24,e.removePermission(n,s.id);case 24:return l={role:"reader",type:a?"domain":"anyone",withLink:"unlisted"===o||"domain_unlisted"===o},a&&(l.value=i),c.abrupt("return",e.insertPermission(n,l));case 27:case"end":return c.stop()}},c,this)}))},b.isGoogleAppsForbiddenError=function(e){return e&&403==e.status&&"domainPolicy"===u(e);
},b.isRateLimitError=function(e){return e&&403==e.status&&"rateLimitExceeded"===u(e)},i.$on("event:signInChanged",g),b}]),angular.module("castifyExt.youtubeUtils",["castifyExt.castifyAuth"]).factory("youtubeUtils",["$http","$q",function(e,t){function r(e){var r=e.data.items;return r.length?r[0]:t.reject("not found")}function n(t,n){return e.get(i,angular.extend({params:{id:t,part:"status,snippet"}},{youtubeAuth:n})).then(r)}function o(t,r,n){return n=angular.extend({id:t},n),e.put(i,n,angular.extend({params:{part:"status"}},{youtubeAuth:r})).then(function(e){return e.data})}var i="https://www.googleapis.com/youtube/v3/videos",a={};return a.getPrivacy=function(e,r){return n(e,r).then(function(e){return r!==e.snippet.channelId?t.reject():e.status.privacyStatus})},a.getLink=function(e){return"https://youtu.be/"+e},a.setPrivacy=function(e,t,r){return o(e,r,{status:{privacyStatus:t}})},a}]),angular.module("castifyExt.driveFileWatcher",["w69b.googledrive","w69b.chromeStorage","w69b.chromeAlarms","castifyExt.castifyAuth"]).factory("driveFileWatcher",["googledrive","chromeStorage","$rootScope","$log","chromeAlarms",function(e,t,r,n,o){function i(){return t.local.setSingle(f,{ids:Object.keys(v),lastCheckedAt:g})}function a(e,t){r.$broadcast("driveFileWatcher:"+e,t)}function c(e){delete v[e]}function u(t){if(v[t])return e.getFile(t).then(function(e){e.labels&&e.labels.trashed?(n.debug("file was trashed",t),a("removed",t),c(t)):e.thumbnailLink&&(n.debug("detected drive processing complete for file",t),a("processed",t),c(t))},function(e){n.debug("failed to check drive file",t,e),404==e.status?(n.debug("file was removed"),a("removed",t),c(t)):n.debug("we will try again later")})}function s(){function e(){return t.length?u(t.pop()).then(e,e):null}var t=Object.keys(v);t.length&&!h&&(n.debug("checking watched drive files",t),h=!0,e()["finally"](function(){h=!1,g=Date.now(),i(),l()}))}function l(e){Object.keys(v).length&&(!e&&Date.now()-g>=6e4*m?s():o.get(p).then(function(e){e||o.create(p,{delayInMinutes:m})}))}function d(e){e.name===p&&l()}var f="driveFileWatcher",p=f,h=!1,g=0,m=10,v={},b={};return b.watchFile=function(e){n.debug("watching drive file",e),v[e]=!0,i(),l(!0)},b.clear=function(){v={},i()},b.install=function(){t.local.getSingle(f).then(function(e){e&&(e.ids.forEach(function(e){v[e]=!0}),g=e.lastCheckedAt||0),l()}),o.onAlarm.addListener(d)},b}]),angular.module("castifyExt.bgSyncManager",["castifyExt.appOptions","castifyExt.bgUpload","w69b.chromeRuntime","castifyExt.driveFileWatcher","w69b.googledrive","castifyExt.localFileDb","castifyExt.chromeEventPublisher","castifyExt.bgFiles","w69b.spawn","castifyExt.bgSyncDownloader"]).factory("bgSyncManager",["$rootScope","appOptions","bgUploadService","localFileDb","googledrive","chromeRuntime","$q","driveFileWatcher","$log","bgFiles","spawn","bgSyncDownloader",function(e,t,r,n,o,i,a,c,u,s,l,d){function f(e){return u.debug("bgSyncManager: staring sync upload",e.id),r.upload({fileId:e.id,target:"drive",privacy:"private",title:e.title,isSyncUpload:!0})}function p(e,t){function r(e){if(e.title!==i.title){u.debug("bgSyncManager: title changed, applying post-upload changes");var t=e.title;return/\.webm/i.test(t)||(t+=".webm"),o.patchFile(l,{title:t})}return a.when()}if(t.config.isSyncUpload){var i=t.config,l=t.data.id;u.debug("bgSyncManager: sync upload of file %s complete, driveId %s",i.fileId,l),n.getFileDescriptor(i.fileId).then(function(e){return r(e)})["catch"](function(e){u.warn("bgSyncManager: sync upload hook failed",e)}).then(function(){s.refresh(i.fileId),c.watchFile(l)})}}function h(e){return n.listFiles().then(function(t){for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];if(n.driveInfo&&n.driveInfo.id===e)return n}return a.reject()})}function g(e){return n.getFileDescriptor(e).then(function(e){return e.remove().then(function(){return u.debug("bgSyncManager: removed local file",e.id),s.refresh(e.id)})},angular.identity)}function m(e,t){w()&&(u.debug("bgSyncManager: drive file %s processed",t),h(t).then(function(e){return s.refresh(e.id).then(function(){k(e.id)})},angular.identity))}function v(e,r){t.values.driveSync&&(u.debug("bgSyncManager: drive file %s remove detected, removing local file",r),h(r).then(function(e){g(e.id).then(function(){k(e.id)})},angular.identity))}function b(e){var t=P.get(e.id);if(t&&!t.downloadPending){var r=d.startDownload(e.id);t.downloadPending=!0,r.done.then(t.deferred.resolve.bind(t.deferred),t.deferred.reject.bind(t.deferred)),r.done["finally"](function(){t.downloadPending=!1,t.timestamp=Date.now()})}}function y(e,t){k(t)}function w(){return t.isLoaded()&&t.values.driveSync}function x(e){var t=P.get(e.id),r=e.isSynced&&!!e.driveInfo.thumbnailLink,n=e.isSynced&&new Date(e.driveInfo.createdDate)<Date.now()-D,o=t&&(t.downloadPending||t.timestamp+$>=Date.now());return e.isLocal&&(r||n)&&!o}function S(e){var t=e.autoShare;return t&&t.timestamp+$<Date.now()}function E(){return l(regeneratorRuntime.mark(function e(){var t,r,o,i,a,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=!0,r=!1,o=void 0,e.prev=3,e.t0=Object,e.next=7,n.listFiles();case 7:e.t1=e.sent,e.t2=Symbol.iterator,i=e.t0.keys.call(e.t0,e.t1)[e.t2]();case 10:if(t=(a=i.next()).done){e.next=20;break}return c=a.value,e.next=14,s.getFileDescriptor(c);case 14:if(u=e.sent,u.isSynced||u.autoShare){e.next=17;break}return e.abrupt("return",!1);case 17:t=!0,e.next=10;break;case 20:e.next=26;break;case 22:e.prev=22,e.t3=e["catch"](3),r=!0,o=e.t3;case 26:e.prev=26,e.prev=27,!t&&i["return"]&&i["return"]();case 29:if(e.prev=29,!r){e.next=32;break}throw o;case 32:return e.finish(29);case 33:return e.finish(26);case 34:return e.abrupt("return",!0);case 35:case"end":return e.stop()}},e,this,[[3,22,26,34],[27,,29,33]])}))}function k(e){l(regeneratorRuntime.mark(function t(){var r,n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,s.getFileDescriptor(e);case 2:if(r=t.sent,!w()){t.next=15;break}if(r.isSynced||r.autoShare||f(r),!x(r)){t.next=13;break}return t.next=8,E();case 8:if(!t.sent){t.next=12;break}g(r.id),t.next=13;break;case 12:M.add(r.id);case 13:n=P.get(r.id),n&&!n.isDone&&(r.isLocal?n.deferred.resolve():b(r));case 15:r.autoShare&&S(r)&&g(r.id);case 16:case"end":return t.stop()}},t,this)}))["catch"](function(t){u.error("bgSyncManager.syncFile("+e+") failed : ",t)})}function R(e,t){e={id:t,deferred:a.defer(),isDone:!1},P.set(t,e);var r=e.deferred.promise;return r.then(function(){e.isDone=!0}),r["catch"](function(){P["delete"](t)}),e}function _(e,t){t||r.cancelAllUploads(!0),I.syncFiles()}function A(){var e=!0,t=!1,r=void 0;try{for(var n,o=M[Symbol.iterator]();!(e=(n=o.next()).done);e=!0){var i=n.value;k(i)}}catch(a){t=!0,r=a}finally{try{!e&&o["return"]&&o["return"]()}finally{if(t)throw r}}}function C(){c.clear(),M.clear(),F()["finally"](function(){I.syncFiles()})}function T(e,n){t.values.driveSync&&r.cancel({target:"drive",fileId:n})}var I={},P=new Map,$=18e5,M=new Set,D=72e5;I.syncFiles=function(){l(regeneratorRuntime.mark(function e(){var t,r,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Set,r=!0,o=!1,i=void 0,e.prev=4,e.t0=Object,e.next=8,n.listFiles();case 8:e.t1=e.sent,e.t2=Symbol.iterator,a=e.t0.keys.call(e.t0,e.t1)[e.t2]();case 11:if(r=(c=a.next()).done){e.next=17;break}u=c.value,t.add(u);case 14:r=!0,e.next=11;break;case 17:e.next=23;break;case 19:e.prev=19,e.t3=e["catch"](4),o=!0,i=e.t3;case 23:e.prev=23,e.prev=24,!r&&a["return"]&&a["return"]();case 26:if(e.prev=26,!o){e.next=29;break}throw i;case 29:return e.finish(26);case 30:return e.finish(23);case 31:for(s=!0,l=!1,d=void 0,e.prev=34,f=P.keys()[Symbol.iterator]();!(s=(p=f.next()).done);s=!0)h=p.value,t.add(h);e.next=42;break;case 38:e.prev=38,e.t4=e["catch"](34),l=!0,d=e.t4;case 42:e.prev=42,e.prev=43,!s&&f["return"]&&f["return"]();case 45:if(e.prev=45,!l){e.next=48;break}throw d;case 48:return e.finish(45);case 49:return e.finish(42);case 50:for(g=!0,m=!1,v=void 0,e.prev=53,b=t[Symbol.iterator]();!(g=(y=b.next()).done);g=!0)w=y.value,k(w);e.next=61;break;case 57:e.prev=57,e.t5=e["catch"](53),m=!0,v=e.t5;case 61:e.prev=61,e.prev=62,!g&&b["return"]&&b["return"]();case 64:if(e.prev=64,!m){e.next=67;break}throw v;case 67:return e.finish(64);case 68:return e.finish(61);case 69:case"end":return e.stop()}},e,this,[[4,19,23,31],[24,,26,30],[34,38,42,50],[43,,45,49],[53,57,61,69],[62,,64,68]])}))};var F=l.wrap(regeneratorRuntime.mark(function L(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(w()){t.next=2;break}return t.abrupt("return");case 2:return u.info("Removing synced files before account change."),e=[],t.t0=angular,t.next=7,n.listFiles();case 7:return t.t1=t.sent,t.t2=function(t){t.driveInfo&&e.push(g(t.id))},t.t0.forEach.call(t.t0,t.t1,t.t2),t.next=12,a.all(e);case 12:case"end":return t.stop()}},L,this)}));return I.requestSyncLocal=function(e){if(!w())return a.when();var t=P.get(e)||R(t,e);return t.timestamp=Date.now(),k(e),t.deferred.promise},I.storeAutoSharedFile=l.wrap(regeneratorRuntime.mark(function j(e){var t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,s.getFileDescriptor(e);case 2:return t=r.sent,r.next=5,s.updateLocalInfo(e,{autoShare:null});case 5:t.autoShare=null,k(e);case 7:case"end":return r.stop()}},j,this)})),I.syncFile=k,I.areAllLocalFilesSynced=E,I.install=function(){e.$on("uploader:complete",p),e.$on("driveFileWatcher:processed",m),e.$on("driveFileWatcher:removed",v),e.$on("bgFiles:localFileCreated",y),e.$on("bgFiles:fileRemoved",T),e.$on("bgFiles:syncSettingChanged",_),e.$on("bgSyncStatus:syncComplete",A),e.$on("event:signInChanged",C),I.syncFiles()},I}]),angular.module("castifyExt.bgSyncDownloader",["castifyExt.bgFiles","w69b.filesHelper","w69b.chromeRuntime","castifyExt.simplePortService","w69b.spawn"]).factory("fetchTool",["spawn","castifyAuth","filesHelper","$q",function(e,t,r,n){function o(e){return t.getAuthToken({interactive:!1}).then(function(t){e.headers.append("Authorization","Bearer "+t)})}function i(e,t){return new Promise(function(r,n){e.onwriteend=r,e.onerror=n,e.write(t)})}function a(t,a){function c(){return e(regeneratorRuntime.mark(function n(){var e,c,d,f,p,h;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e=new Request(t),n.next=3,o(e);case 3:return n.next=5,r.getFileEntryByPath(a,{create:!0});case 5:return c=n.sent,n.next=8,r.getMetadata(c);case 8:return d=n.sent,e.headers.append("range","bytes = "+d.size+" -"),n.next=12,fetch(e,{mode:"cors"});case 12:if(f=n.sent,f.ok){n.next=15;break}throw new Error("fetch failed");case 15:if(!l){n.next=17;break}return n.abrupt("return");case 17:return u=f.body.getReader(),n.next=20,u.read();case 20:return p=n.sent,n.prev=21,s.bytesLoaded=d.size,n.next=25,r.createWriter(c);case 25:h=n.sent;case 26:if(p.done){n.next=35;break}return n.next=29,i(h,new Blob([p.value]));case 29:return s.bytesLoaded+=p.value.length,n.next=32,u.read();case 32:p=n.sent,n.next=26;break;case 35:n.next=41;break;case 37:throw n.prev=37,n.t0=n["catch"](21),u.cancel(),n.t0;case 41:case"end":return n.stop()}},n,this,[[21,37]])}),!0)}var u,s={},l=!1;return s.path=a,s.cancel=function(){u&&u.cancel(),l=!0},s.done=n.when(c()),s}return{downloadUrlToFile:a}}]).factory("bgSyncDownloader",["bgFiles","spawn","castifyAuth","$window","filesHelper","fetchTool","$log","$q","simplePortService",function(e,t,r,n,o,i,a,c,u){function s(){return o.getDirByPath(g,{create:!0})}function l(){return t(regeneratorRuntime.mark(function e(){var t,r,n,i,a,u,l,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s();case 2:return e.next=4,o.listByPath(g);case 4:for(t=e.sent,r=[],n=!0,i=!1,a=void 0,e.prev=9,u=t[Symbol.iterator]();!(n=(l=u.next()).done);n=!0)d=l.value,r.push(o.remove(d));e.next=17;break;case 13:e.prev=13,e.t0=e["catch"](9),i=!0,a=e.t0;case 17:e.prev=17,e.prev=18,!n&&u["return"]&&u["return"]();case 20:if(e.prev=20,!i){e.next=23;break}throw a;case 23:return e.finish(20);case 24:return e.finish(17);case 25:return e.next=27,c.all(r);case 27:case"end":return e.stop()}},e,this,[[9,13,17,25],[18,,20,24]])}))["catch"](function(e){a.error("bgSyncDownloader.cleanup failed",e)})}function d(r){function n(){return t(regeneratorRuntime.mark(function n(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,p;case 2:return n.next=4,e.getFileDescriptor(r);case 4:if(u=n.sent,!s){n.next=7;break}return n.abrupt("return");case 7:return t=g+"/"+u.id,c=i.downloadUrlToFile(u.url,t),n.next=11,c.done;case 11:return n.next=13,o.moveFileByPath(t,e.idToLocalFilename(u.id));case 13:return n.next=15,e.registerLocalFile(u.id);case 15:case"end":return n.stop()}},n,this)}))}var c,u,s=!1,l={get bytesLoaded(){return c?c.bytesLoaded:0},get progress(){return u&&u.size?l.bytesLoaded/u.size:0}};return l.cancel=function(){c&&c.cancel(),s=!0},l.done=n(),l.done["catch"](function(e){a.warn("bgSyncDownloader: download failed",e)}),l}function f(){var e={},t=!0,r=!1,n=void 0;try{for(var o,i=m.entries()[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var a=o.value,c=a[0],u=a[1];e[c]={progress:u.progress}}}catch(s){r=!0,n=s}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}v.postMessage("downloads",e)}var p,h={},g="_dl",m=new Map,v=u("syncDownloader");return h.getDownload=function(e){return m.get(e)},h.startDownload=function(e){var t=m.get(e);return t||(a.debug("bgSyncDownloader.startDownload("+e+")"),t=d(e),m.set(e,t),f(),t.done["finally"](function(){m["delete"](e),f()})),t},h.install=function(){p=l(),v.install()},v.handlers.update=function(){f()},h}]),angular.module("castifyExt.offline",[]).factory("onlineState",["$rootScope","$window","$http","$timeout","$log",function(e,t,r,n,o){function i(){if(f)return f;var e=Math.random().toString(36).substr(2,36),t=u+e;return f=r.get(t,{responseType:"arraybuffer",timeout:s}).then(function(){return f=null,o.debug("checkNetwork result is online"),!0},function(){return o.debug("checkNetwork result is offline"),f=null,!1}),f.then(a),f}function a(t){p!==t&&(o.debug("verified network state is ",t),p=t,e.$broadcast("onlineState:changed",t)),!t&&d.isNavigatorOnline()&&c(!0)}function c(e){function t(){return h=n(angular.noop,l),h.then(r)}function r(){return i().then(function(e){if(!e&&d.isNavigatorOnline()&&g)return t()})}g||(g=!0,(e?t():r())["finally"](function(){g=!1}))}var u="https://www.screencastify.com/images/cleardot.gif?",s=1e4,l=1e4,d={},f=null,p=!0,h=null,g=!1;return d.check=function(){return i()},d.isOnline=function(){return p},d.isNavigatorOnline=function(){return t.navigator.onLine!==!1},t.addEventListener("online",function(){d.check()}),t.addEventListener("offline",function(){a(!1),n.cancel(h),g=!1}),d}]),angular.module("castifyExt.syncAuthTool",["castifyExt.castifyAuth","w69b.chromeRuntime","castifyExt.appOptions","castifyExt.driveUtils"]).factory("syncAuthTool",["castifyAuth","$http","$q","$log","appOptions","chromeRuntime","$rootScope","driveUtils",function(e,t,r,n,o,i,a,c){var u={};return u.broadcastIfSyncError=function(e){return"not_signed_in"===e?(n.debug("syncAuthTool: sync enabled but not signed in"),a.$broadcast("event:syncAuthError"),i.sendMessage({type:"event:syncAuthError"})["catch"](angular.identity),r.reject(e)):(o.values.driveSync&&u.checkSetup()["catch"](function(t){switch(t){case"token":n.debug("syncAuthTool: sync enabled but we do not have a valid token"),a.$broadcast("event:syncAuthError"),i.sendMessage({type:"event:syncAuthError"})["catch"](angular.identity);break;case"forbidden":n.debug("syncAuthTool: detected drive-forbidden error",e),a.$broadcast("event:syncForbiddenError");break;default:n.warn("syncAuthTool: unhandled sync error detected",e)}}),r.reject(e))},u.hasValidAuthToken=function(){return e.getAuthToken({interactive:!1,validate:!0})},u.isRateLimitError=function(e){return c.isRateLimitError(e)},u.checkSetup=function(){function e(){return c.getDriveUploadParentId()["catch"](function(e){return c.isGoogleAppsForbiddenError(e)?r.reject("forbidden"):r.reject("unknown")})}return u.hasValidAuthToken()["catch"](function(){return r.reject("token")}).then(e).then(function(){return!0})},u}]),angular.module("castifyExt.requestMicPermission",[]).factory("requestMicPermission",["$window","$q","$interval",function(e,t,r){return function(){var n=t.defer(),o=e.open("mic.html","mic",""),i=!1;o.clGotStream=function(){i=!0,n.resolve()};var a=r(function(){o.closed&&!i&&n.reject("closed mic permission window without granting permission")},200);return n.promise["finally"](function(){r.cancel(a)}),n.promise}}]),angular.module("castifyExt.bgSyncStatus",["castifyExt.bgFiles","castifyExt.bgUpload","castifyExt.syncAuthTool","castifyExt.bgSyncManager","w69b.throttle","w69b.chromeRuntime","w69b.spawn"]).factory("bgSyncStatus",["bgFiles","bgUploadService","$rootScope","$log","throttle","syncAuthTool","chromeRuntime","bgSyncManager","spawn",function(e,t,r,n,o,i,a,c,u){function s(e){if("syncStatus"==e.name){L.push(e),d(),e.onDisconnect.addListener(function(){var t=L.indexOf(e);t>=0&&L.splice(t,1)});var t={retry:P.retry};e.onMessage.addListener(function(e){t.hasOwnProperty(e.type)&&t[e.type](e.data)})}}function l(e,t){L.forEach(function(r){r.postMessage({type:e,data:t})})}function d(){l("stateUpdate",M)}function f(e){p({type:"synced",numTotalFiles:e}),d()}function p(e){e.type!==M.type&&(n.debug("syncStatus: changing state to ",e),"synced"===e.type&&"unknown"!==M.type&&r.$broadcast("bgSyncStatus:syncComplete")),M=e,"uploading"!==e.type&&(D={})}function h(){"uploading"!==M.type&&p({type:"uploading"});var e=0,t=0,r=0;angular.forEach(D,function(n){e+=n,++t,n>=1&&++r}),M.progress=e/t,M.numTotalFiles=t,M.numCompleteFiles=r,d()}function g(e){"waiting"!==M.type&&p({type:"waiting"}),M.numTotalFiles=e,d()}function m(e){"offline"!==M.type&&p({type:"offline"}),M.numTotalFiles=e,d()}function v(){c.areAllLocalFilesSynced()["catch"](function(){return!1}).then(function(e){e?(n.debug("syncStatus: treating auth error with no local files as synced"),f(0)):(p({type:"error",errorReason:"token"}),d())})}function b(){p({type:"error",errorReason:"forbidden"}),d()}function y(){var e=null,t=!0,r=!1,n=void 0;try{for(var o,i=F.values()[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var a=o.value;a&&(e=a)}}catch(c){r=!0,n=c}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}p({type:"error",numTotalFiles:F.size,errorReason:e}),d()}function w(){i.checkSetup().then(y,function(e){"token"===e?v():"forbidden"===e?b():y()})}function x(e){var r=t.getTargetFileState(e,"drive");return r&&r.config.isSyncUpload?r:null}function S(e){var r=0,n=0;angular.forEach(e,function(e,t){D[t]=e&&e.progress||D[t]||0,e?"uploading"===e.state?++r:"queued"===e.state&&++n:n++}),r?h():n&&(t.isOnline()?g(n):m(n))}function E(){t.isOnline()?w():m(0)}function k(e,t){var r=t.config,o=t.error;r.isSyncUpload&&(n.debug("sync error detected",o),F.has(r.fileId)&&F["delete"](r.fileId),F.set(r.fileId,o&&o.reason),j())}function R(){return"error"==M.type}function _(){R()||v()}function A(){R()||b()}function C(){F.clear(),j()}function T(){p({type:"unknown"}),d(),$=r.$new(!0);var n=o(j,300,!0);$.$watchGroup([e.getListVersionId,t.getWatcherStateId,t.isOnline],function(){n()}),$.$on("uploader:failed",k),$.$on("event:syncAuthError",_),$.$on("event:syncForbiddenError",A),$.$on("event:userAccountChanged",C)}function I(){$&&$.$destroy(),$=null,p({type:"disabled"}),d()}var P={},$=null,M={type:"unknown"},D={},F=new Map,L=[],j=u.wrap(regeneratorRuntime.mark(function U(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!(F.size>0)){t.next=3;break}return E(),t.abrupt("return");case 3:return t.next=5,c.areAllLocalFilesSynced()["catch"](function(){return!1});case 5:if(!t.sent){t.next=8;break}return f(0),t.abrupt("return");case 8:e.listFiles().then(function(e){if($){var t={},r=!1,n=0;angular.forEach(e,function(e){e.autoShare||(e.isSynced?D.hasOwnProperty(e.id)&&(D[e.id]=1):(t[e.id]=x(e.id),r=!0),++n)}),angular.forEach(D,function(t,r){e[r]||delete D[r]}),r?S(t):f(n)}},function(e){n.debug("syncStatus list err",e),i.isRateLimitError(e)||E()});case 9:case"end":return t.stop()}},U,this)}));return P.retry=function(){F.clear(),c.syncFiles()},P.getState=function(){return M},P.install=function(){r.$watch(e.isSyncEnabled,function(e){e?T():I()}),a.onConnect.addListener(s)},P}]),angular.module("castifyExt.syncNotifications",["castifyExt.bgSyncStatus","w69b.throttle","w69b.chromeNotifications","castifyExt.ui.openInAppTab","castifyExt.appOptions","w69b.promiseTool","castifyExt.helpCenter"]).factory("syncNotifications",["$rootScope","bgSyncStatus","$log","throttle","chromeNotifications","$q","openInAppTab","appOptions","helpCenter","promiseTool",function(e,t,r,n,o,i,a,c,u,s){function l(e,t){x(function(){e=y+e;var r,n=!w;return w&&w!==e?(r=o.clear(w),n=!0):r=i.when(),t=angular.extend({type:"basic",priority:0,eventTime:Date.now(),isClickable:!1,title:"Saving on Drive",iconUrl:"images/icon128.png"},t),w=e,n?r.then(function(){return o.create(e,t)}):r.then(function(){return o.update(e,t)})})}function d(e){c.values.notifySyncProgress&&l("progress",{type:"progress",priority:0,message:"Your recording(s) are being saved "+e.numCompleteFiles+" / "+e.numTotalFiles,progress:Math.floor(100*e.progress)})}function f(e){c.values.notifySyncProgress&&l("waiting",{priority:0,message:e.numTotalFiles+" recording(s) are waiting to get saved on Drive."})}function p(e){l("offline",{title:"You are offline",priority:1,message:e.numTotalFiles+" recording(s) are not saved on Drive yet."})}function h(e){"token"===e.errorReason?l("auth",{priority:2,title:"Drive Authentication Problem",message:"Screencastify cannot save to Drive.",buttons:[{title:"Sign In"}]}):"forbidden"===e.errorReason?l("forbidden",{priority:2,title:"Drive Access Problem",message:"Drive API/Apps are disabled for your domain.",buttons:[{title:"Help"}]}):"quotaExceeded"===e.errorReason?l("quotaExceeded",{priority:2,title:"Out of Drive storage space",message:"You have reached your storage limit on Drive. Screencastify cannot store save to Drive anymore.",buttons:[{title:"Help"}]}):l("error",{priority:2,title:"Failed to save recordings on Drive.",message:"We failed to save "+e.numTotalFiles>0?e.numTotalFiles:"some recording(s) on Drive. Please contact support if this problem persists.",buttons:[{title:"Retry"}]})}function g(){x(function(){if(w){var e=o.clear(w);return w=null,e}})}function m(e,r){function n(t,n){return e===y+t&&r===(n||0)}n("error")?t.retry():n("auth")?a("#/setup/"):n("forbidden")?u.openHelp("drive_apps"):n("quotaExceeded")&&u.openHelp("quotaExceeded")}function v(){var e=t.getState(),r=S[e.type];r&&r(e)}var b={},y="sync_state_",w=null,x=s.serializer(),S={uploading:d,waiting:f,offline:p,error:h,synced:g,disabled:g};return b.install=function(){t.install();var r=n(v,1e3,!1);e.$watchCollection(t.getState,function(){r()}),o.onButtonClicked.addListener(m)},b}]),angular.module("castifyExt.youtubeAuth",["w69b.uritool","castifyExt.castifyAuth"]).provider("youtubeAuth",function(){var e,t=["https://www.googleapis.com/auth/youtube"];this.setScopes=function(e){t=e},this.setClientId=function(t){e=t},this.$get=["castifyAuth","$log","uritool","$q","$http","castifyConfig",function(r,n,o,i,a,c){function u(e){return m+"?"+o.encodeQuery(e)}function s(e){return e.data}function l(){return r.getRedirectURL().then(function(o){var a={redirect_uri:o,scope:t.join(" "),response_type:"code",client_id:e,access_type:"offline",include_granted_scopes:!1,prompt:"select_account consent"},c=u(a),s={url:c,interactive:!0};return r.launchWebAuthFlow(s).then(function(e){return n.debug("youtube oauth result",e),e.code?e.code:i.reject("youtube_flow_returned_no_code")})})}function d(e){return a.post(h,{code:e,version:2},{googleAuth:!0}).then(s,function(e){return n.warn("adding youtube code failed",e),i.reject("youtube_add_code_failed")})}function f(e){return a.get(g+"/"+e,{googleAuth:!0}).then(s).then(function(e){return e.expiresAt=Number(new Date(e.expiresAt)),e.issuedAt=Number(new Date(e.issuedAt)),e})}var p=c.API_URL+"/youtube/",h=p+"channels",g=p+"tokens",m="https://accounts.google.com/o/oauth2/auth",v={},b=0,y={};return y.addChannel=function(){return r.getAuthToken({interactive:!0}).then(l).then(d)},y.listChannels=function(){return a.get(h,{googleAuth:!0}).then(s)},y.removeChannel=function(e){return a["delete"](h+"/"+e,{googleAuth:!0}).then(s)},y.getAuthToken=function(e){if(!e.channelId)throw new Error;var t,r=e.channelId,n=Math.floor(Date.now()-b)+12e4,o=v[r];return o&&o.expiresAt>n?t=i.when(o):(t=f(r),t.then(function(e){v[r]=e,e.issuedAt&&(b=Date.now()-Number(e.issuedAt))})),t.then(function(e){return e.accessToken})},y}]}).factory("youtubeHttpAuthInterceptor",["$q","$injector","$log",function(e,t,r){function n(e){var t={channelId:e};return i().getAuthToken(t)}function o(e){return{Authorization:"Bearer "+e}}function i(){return a||(a=t.get("youtubeAuth")),a}var a;return{request:function(t){return t.youtubeAuth?(t.googleAuth&&delete t.googleAuth,n(t.youtubeAuth).then(function(e){return t.headers=angular.extend(t.headers||{},o(e)),t},function(t){return r.warn("youtubeAuth failed",t),e.reject("youtubeAuth failed")})):t}}}]),angular.module("castifyExt.enterprisePolicy",["w69b.chromeStorage"]).provider("enterprisePolicy",function(){var e={};this.setOverride=function(t){e=t},this.$get=["chromeStorage","$rootScope",function(t,r){var n={},o=!1,i={options:{}};angular.extend(i,e);var a=["disableSharing","disableSaveToDisk","options"];return a.forEach(function(e){Object.defineProperty(n,e,{get:function(){return i[e]}})}),n.loadedPromise=t.managed.get(a).then(function(t){angular.extend(i,t,e),o=!0}),n.isLoaded=function(){return o},n.has=function(e){return i.hasOwnProperty(e)},n.get=function(e){return i[e]},t.onChanged.addListener(function(e,t){"managed"===t&&(angular.forEach(e,function(e,t){i[t]=e.newValue}),r.$$phase||r.$digest())}),n}]}),angular.module("castifyExt.crashReporter",["w69b.chromePersistentLogger","w69b.chromeRuntime"]).factory("crashReporter",["castifyConfig","chromeRuntime","$http","chromePersistentLogger",function(e,t,r,n){function o(){return t.getManifest().version}function i(){return n.save().then(function(){return n.getMergedLogs(["popup","background","app"])})}var a=e.API_URL+"/crash",c={};return c.report=function(e,t){i().then(function(n){return r.post(a,{module:e,version:o(),logs:n.join("\n"),core:t})})},c}]),angular.module("castifyExt.helpCenter",["w69b.chromeTabs"]).factory("helpCenter",["chromeTabs",function(e){var t={};return t.tagUrls={},t.registerUrl=function(e,r){t.tagUrls[e]=r},t.hasHelpFor=function(e){return t.tagUrls.hasOwnProperty(e)},t.openHelp=function(r){var n=t.tagUrls[r];if(!n)throw new Error("No help url registered for "+r);e.create({url:n})},t.setNotifyHelp=function(e,r){e.onButtonClicked=e.onClicked=function(){t.openHelp(r),e.clear()}},t}]),angular.module("castifyExt.helpCenterConfig",["castifyExt.helpCenter"]).run(["helpCenter",function(e){e.registerUrl("load_nacl","https://screencastify.helpscoutdocs.com/article/33-failed-to-load-nacl-module"),e.registerUrl("disk_space","https://screencastify.helpscoutdocs.com/article/32-out-of-disk-space"),e.registerUrl("drive_apps","https://screencastify.helpscoutdocs.com/article/34-enabling-drive-on-google-apps"),e.registerUrl("start_recording","https://screencastify.helpscoutdocs.com/article/35-failed-to-start-recording"),e.registerUrl("change_account","https://screencastify.helpscoutdocs.com/article/31-how-to-sign-in-with-a-different-account"),e.registerUrl("quotaExceeded","https://screencastify.helpscoutdocs.com/article/20-out-of-space-on-google-drive"),e.registerUrl("youtubeSignupRequired","https://screencastify.helpscoutdocs.com/article/24-youtubesignuprequired-error-when-uploading-to-youtube"),e.registerUrl("no_audio","https://screencastify.helpscoutdocs.com/article/82-failed-to-capture-audio"),e.registerUrl("no_cam","https://screencastify.helpscoutdocs.com/article/83-failed-to-access-your-webcam"),e.registerUrl("trial_monthly_limit","https://www.screencastify.com/buy?utm_source=app&utm_content=notify&utm_campaign=monthly_limit"),e.registerUrl("youtubeCredentialsMissing","https://help.screencastify.com/article/219-i-received-a-youtubeauth-failed-error")}]),angular.module("castifyExt.oauthTokenCache",["w69b.chromeStorage"]).factory("oauthTokenCache",["chromeStorage","$q",function(e,t){function r(r){function n(){return e.local.getSingle(r).then(function(e){return e||{}})}function o(e){var t=i();angular.forEach(e,function(r,n){(!n.expiresAt||n.expiresAt<=t)&&delete e[r]})}function i(){return Math.floor(Date.now()-a)+12e4}var a=0,c={};return c.get=function(e){return n().then(function(r){var n=r[e];return n&&n.expiresAt>i()?t.when(n):t.reject()})},c.put=function(t,i){return n().then(function(n){return n[t]=i,i.issuedAt&&(a=Date.now()-Number(i.issuedAt)),o(n),e.local.setSingle(r,n)})},c.removeByToken=function(t){return n().then(function(n){return angular.forEach(n,function(e,r){e.accessToken===t&&delete n[r]}),e.local.setSingle(r,n)})},c.remove=function(t){return n().then(function(n){return delete n[t],e.local.setSingle(r,n)})},c.clear=function(){return e.local.remove(r)},c.withCache=function(e,t){return c.get(e)["catch"](function(){return t().then(function(t){return c.put(e,t).then(function(){return t})})})},c}return r}]),angular.module("castifyExt.castifyAuth",["castifyExt.simpleBgServiceConsumer"]).factory("castifyAuth",["simpleBgServiceConsumer",function(e){return e("castifyAuth",["launchWebAuthFlow","getRedirectURL","removeCachedAuthToken","getAuthToken","getAccount"])}]).factory("googleauth",["castifyAuth","$q",function(e,t){var r={};return r.loadClient=function(){return t.when()},r.getAuthToken=function(t){e.getAuthToken(angular.isObject(t)?t:{interactive:!!t})},r}]),angular.module("castifyExt.bgCastifyAuth",["w69b.chromeStorage","w69b.uritool","w69b.es6","w69b.chromeRuntime","w69b.uuid","w69b.promiseTool","castifyExt.oauthTokenCache","w69b.spawn","w69b.chromeNotifications","castifyExt.helpCenter","castifyExt.simpleBgServicePublisher","castifyExt.castifyAuth"]).provider("bgCastifyAuth",function(){var e,t=[],r="";this.setScopes=function(e){t=e},this.setClientId=function(t){e=t},this.setRedirectUri=function(e){r=e},this.$get=["$q","uritool","$rootElement","$window","chromeRuntime","$interval","castifyConfig","$http","chromeStorage","oauthTokenCache","uuid","promiseTool","$log","$rootScope","spawn","chromeNotifications","helpCenter","simpleBgServicePublisher",function(n,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w){function x(e){return l.get(j,{params:{access_token:e}})}function S(e){return x(e.accessToken).then(function(){return!0},function(e){return 400!==e.status})}function E(t){return t=angular.extend({redirect_uri:r,response_type:"code",client_id:e,access_type:"offline",include_granted_scopes:"true"},t),L+"?"+o.encodeQuery(t)}function k(e){var t=n.defer(),r=function(r){if("oauth2AuthResult"===r.type){var n=r.data,i=o.parseUrl(n),a=o.parseQuery((i.hash||i.query).substring(1));if(!a||a.state!==e)return;a.error?t.reject({error:a.error||"immediate_failed"}):t.resolve(a)}};return c.onMessageExternal.addListener(r),t.promise["finally"](function(){c.onMessageExternal.removeListener(r)}),t}function R(e){e.expiresAt=Number(new Date(e.expiresAt)),e.issuedAt=Number(new Date(e.issuedAt))}function _(e){return v(regeneratorRuntime.mark(function t(){var r,n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,l.post(U,{code:e},{headers:{"x-castify-version":c.getManifest().version}})["catch"]($);case 2:return r=t.sent,n=r.data,R(n.token),t.abrupt("return",n);case 6:case"end":return t.stop()}},t,this)}))}function A(e,t){var r=a.open(e),n=!1,o=k(t);o.promise.then(function(){n=!0});var i=u(function(){r.closed&&!n&&(g.debug("castifyAuth: user closed oauth window"),
o.reject("auth_window_closed"))},200),c=h.withTimeout(function(){return o.promise},9e4);return c["finally"](function(){u.cancel(i)}),c}function C(t){var r=p(),n={scope:t.scope,response_type:"code",client_id:e,access_type:"offline",state:r},o=[];t.email?n.login_hint=t.email:t.accountChooser&&o.push("select_account"),t.forceConsent&&o.push("consent"),n.prompt=o.join(" ");var i=E(n),a=A(i,r);return a.then(function(e){return e.code})}function T(e){function t(e){return C(e).then(_)}var r=t(e)["catch"](function(r){return r&&r.data&&"no_refresh_code"===r.data.error?t(angular.extend({},e,{forceConsent:!0})):n.reject(r)});return r}function I(e){return d.sync.getSingle(B,{}).then(function(t){return t[e]})}function P(e,t){var r={};return r[e]=t,d.sync.setSingle(B,r)}function $(e){return g.debug("castifyAuth: handling HTTP error",e),401===e.status?n.reject(V.NotSignedInError):e.status<=0||e.status>=500&&e.status<=599?n.reject(V.NetworkError):n.reject(e)}function M(e){return v(regeneratorRuntime.mark(function t(){var r,o,i,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,I(e.email);case 2:if(r=t.sent){t.next=5;break}return t.abrupt("return",n.reject(V.NotSignedInError));case 5:return o=null,e.scope&&(o=e.scope.split(" ")),t.next=9,l.get(U,{headers:{Authorization:r,"x-castify-version":c.getManifest().version},params:{scopes:o}})["catch"]($)["catch"](function(t){return t===V.NotSignedInError?P(e.email,null).then(function(){return n.reject(t)}):n.reject(t)});case 9:return i=t.sent,a=i.data,R(a.token),t.abrupt("return",a);case 13:case"end":return t.stop()}},t,this)}))}function D(){return null}function F(){m.$broadcast("event:signInChanged"),c.sendMessage({type:"event:signInChanged"})}var L="https://accounts.google.com/o/oauth2/auth",j="https://www.googleapis.com/oauth2/v1/tokeninfo",U=s.API_URL+"/client_auth",O="castifyAuth:account",N="castifyAuth:cache",B="castifyAuth:clientToken",q=f(N),W=h.serializer(),V={};return V.NotSignedInError="not_signed_in",V.NetworkError="network_error",V.getAccount=function(){return d.local.getSingle(O).then(function(e){return e?e:null})},V.setAccount=function(e){return d.local.setSingle(O,e)},V.getAuthToken=function(e){function r(e){return e+":"+u.scope}function o(t){return v(regeneratorRuntime.mark(function n(){var o,i,a;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return u.email=t,o=r(t),n.next=4,q.get(o)["catch"](D);case 4:if(i=n.sent,n.t0=i&&e.validate,!n.t0){n.next=10;break}return n.next=9,S(i);case 9:n.t0=!n.sent;case 10:if(!n.t0){n.next=13;break}i=null,q.remove(o);case 13:if(!i){n.next=15;break}return n.abrupt("return",{token:i});case 15:return n.prev=15,n.next=18,M(u);case 18:a=n.sent,n.next=31;break;case 21:if(n.prev=21,n.t1=n["catch"](15),!e.interactive){n.next=30;break}return n.next=26,T(u);case 26:a=n.sent,s=!0,n.next=31;break;case 30:throw n.t1;case 31:return n.next=33,q.put(o,a.token);case 33:return n.abrupt("return",a);case 34:case"end":return n.stop()}},n,this,[[15,21]])}))}function i(){return e.interactive?v(regeneratorRuntime.mark(function t(){var e,o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,T(u);case 2:return e=t.sent,s=!0,o=e.token,t.next=7,n.all([q.put(r(o.email),o),V.setAccount(o.email)]);case 7:return t.abrupt("return",e);case 8:case"end":return t.stop()}},t,this)})):n.reject(V.NotSignedInError)}function a(){return"select_account"===e.interactive?n.reject():V.getAccount()}function c(){var e=v(regeneratorRuntime.mark(function t(){var e,r,n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a()["catch"](D);case 2:if(e=t.sent,!e){t.next=9;break}return t.next=6,o(e);case 6:r=t.sent,t.next=12;break;case 9:return t.next=11,i();case 11:r=t.sent;case 12:if(n=r.clientToken,!n){t.next=16;break}return t.next=16,P(e||r.token.email,n);case 16:return s&&F(),t.abrupt("return",r.token.accessToken);case 18:case"end":return t.stop()}},t,this)}));return e["catch"](function(e){e===V.NotSignedInError&&m.$broadcast("castifyAuth:notSignedIn")}),e}e=angular.extend({interactive:!1,scopes:t},e),e.scopes||(e.scopes=t);var u={accountChooser:"select_account"===e.interactive,scope:e.scopes.join(" ")},s=!1;return W(c)},V.removeCachedAuthToken=function(e){return q.removeByToken(e.token)},V.launchWebAuthFlow=function(e){return e.interactive?A(e.url,e.state):A(e.url,e.state)},V.getRedirectURL=function(){return n.when(r)},V.signOut=function(){return n.all([d.sync.remove(B),q.clear(),d.sync.remove(O)]).then(function(){return null})},V.install=function(){w("castifyAuth",V,["install"])},V}]}).factory("castifyAuth",["bgCastifyAuth",function(e){return e}]),angular.module("castifyExt.branding",["castifyExt.userAccount","w69b.filesHelper","w69b.spawn"]).factory("branding",["userAccount","$http","filesHelper","spawn","$log",function(e,t,r,n,o){function i(){return r.getDirByPath(c,{create:!0})}var a="/images/branding.png",c="_branding",u=c+"/_branding.png",s={};return s.getFilename=function(){return n(regeneratorRuntime.mark(function c(){var n,s,l,d,f;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.prev=0,c.next=3,e.getAccount();case 3:if(n=c.sent.license,n.branding){c.next=6;break}return c.abrupt("return",null);case 6:return c.next=8,i();case 8:return c.next=10,r.getFileEntryByPath(u,{create:!0});case 10:return s=c.sent,c.next=13,r.getMetadata(s);case 13:if(l=c.sent,l.size&&8532===l.size){c.next=23;break}return c.next=17,r.createWriter(s);case 17:return d=c.sent,c.next=20,t.get(a,{responseType:"blob"});case 20:return f=c.sent,c.next=23,r.writeFile(d,f.data);case 23:return c.abrupt("return",u);case 26:return c.prev=26,c.t0=c["catch"](0),o.error("failed to prepare branding file",c.t0),c.abrupt("return",null);case 30:case"end":return c.stop()}},c,this,[[0,26]])}))},s}]),angular.module("castifyExt.simpleBgServicePublisher",["w69b.chromeRuntime"]).factory("simpleBgServicePublisher",["chromeRuntime","$q","$log",function(e,t,r){function n(n,o,i){function a(e,i,a){var c=function(e){try{a(e)}catch(t){}};if(e&&"simpleService"===e.type&&e.service===n&&o.hasOwnProperty(e.fn)&&!u[e.fn]){var s=t.when(o[e.fn].apply(o,_toConsumableArray(e.data)));return s.then(function(e){c({data:e})},function(t){r.debug("simpleService("+n+")."+e.fn+" failed : ",t),c({error:t})}),!0}return!1}function c(){e.onMessage.removeListener(a)}var u={};return(i||[]).forEach(function(e){u[e]=!0}),e.onMessage.addListener(a),c}return n}]),angular.module("castifyExt.simpleBgServiceConsumer",["w69b.chromeRuntime"]).factory("simpleBgServiceConsumer",["chromeRuntime","$q",function(e,t){function r(r,n){function o(e){return e.error?t.reject(e.error):e.data}function i(t){return function(){return e.sendMessage({type:"simpleService",fn:t,service:r,data:Array.prototype.concat.apply([],arguments)}).then(o)}}var a={};return n.forEach(function(e){a[e]=i(e)}),a}return r}]),angular.module("castifyExt.simplePortService",["w69b.chromeRuntime"]).factory("simplePortService",["chromeRuntime",function(e){function t(t){function r(e){e.name===t&&(n.add(e),e.onDisconnect.addListener(function(){n["delete"](e)}),e.onMessage.addListener(function(e){o.handlers.hasOwnProperty(e.type)&&o.handlers[e.type](e.data)}))}var n=new Set,o={handlers:{}};return o.postMessage=function(e,t){var r=!0,o=!1,i=void 0;try{for(var a,c=n[Symbol.iterator]();!(r=(a=c.next()).done);r=!0){var u=a.value;u.postMessage({type:e,data:t})}}catch(s){o=!0,i=s}finally{try{!r&&c["return"]&&c["return"]()}finally{if(o)throw i}}},o.install=function(){e.onConnect.addListener(r)},o}return t}]),angular.module("castifyExt.connect.connectedApps",["w69b.chromeStorage","w69b.spawn","castifyExt.connect.appRegistry"]).factory("connectedApps",["chromeStorage","spawn","appRegistry","$rootScope",function(e,t,r,n){function o(){return e.sync.getSingle(l,[]).then(function(e){return e.map(function(e){return angular.isObject(e)?e:{id:e,hasShareUrl:!0}})})}function i(t){return e.sync.setSingle(l,t)}function a(){return e.sync.getSingle(d)}function c(t){return e.sync.setSingle(d,t)}function u(e,t){return e.some(function(e){return e.id===t})}var s={},l="connectedAppIds",d="connectedAppRecentId";s.getConnected=function(e){return t(regeneratorRuntime.mark(function r(){var t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,o();case 2:return t=r.sent,e&&(t=t.filter(function(t){var r=!0;return angular.forEach(e,function(e,n){r=r&&t[n]===e}),r})),r.abrupt("return",t.map(function(e){return e.id}));case 5:case"end":return r.stop()}},r,this)}))},s.getConnectedAppInfo=t.wrap(regeneratorRuntime.mark(function p(){var e,t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o();case 2:return e=n.sent,n.next=5,r.getApps(e.map(function(e){return e.id}));case 5:return t=n.sent,t=angular.copy(t),t.forEach(function(t){var r=e.find(function(e){return e.id===t.id});angular.extend(t,r)}),n.abrupt("return",t);case 9:case"end":return n.stop()}},p,this)})),s.getConnectedAppInfoForApp=t.wrap(regeneratorRuntime.mark(function h(e){var t,r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.getConnectedAppInfo();case 2:if(t=n.sent,r=t.find(function(t){return t.id===e})){n.next=6;break}return n.abrupt("return",null);case 6:return n.abrupt("return",r);case 7:case"end":return n.stop()}},h,this)})),s.hasConnectedApps=function(){return s.getConnected().then(function(e){return e.length>0})},s.isConnected=function(e){return t(regeneratorRuntime.mark(function r(){var t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,o();case 2:return t=r.sent,r.abrupt("return",u(t,e));case 4:case"end":return r.stop()}},r,this)}))},s.disconnect=function(e){return t(regeneratorRuntime.mark(function r(){var t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,o();case 2:return t=r.sent,t=t.filter(function(t){return t.id!==e}),r.next=6,c(null);case 6:return r.next=8,i(t);case 8:n.$broadcast("connect:appDisconnected",e);case 9:case"end":return r.stop()}},r,this)}))},s.connect=function(e){return t(regeneratorRuntime.mark(function a(){var t,s;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,o();case 2:return t=a.sent,a.next=5,r.getAppInfo(e);case 5:if(s=a.sent,u(t,e)){a.next=11;break}if(t.push({id:e,hasShareUrl:!!s.shareUrl}),!s.shareUrl){a.next=11;break}return a.next=11,c(e);case 11:return a.next=13,i(t);case 13:n.$broadcast("connect:appConnected",e,s);case 14:case"end":return a.stop()}},a,this)}))};var f=t.wrap(regeneratorRuntime.mark(function g(e,t,r){var n,a,c;return regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return u.next=2,o();case 2:if(n=u.sent,a=n.find(function(t){return t.id===e})){u.next=6;break}throw new Error("Cannot set user data for non-connected app");case 6:return c=a[t],null===r||angular.isUndefined(r)?delete a[t]:a[t]=r,u.next=10,i(n);case 10:return u.abrupt("return",c);case 11:case"end":return u.stop()}},g,this)}));return s.setUserExpiryDate=t.wrap(regeneratorRuntime.mark(function m(e,t){var r;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,f(e,"userExpiryDate",t);case 2:r=o.sent,n.$broadcast("connect:userExpiryDateChange",r,t);case 4:case"end":return o.stop()}},m,this)})),s.setUserShareUrl=function(e,t){return f(e,"shareUrl",t)},s.clearRecent=function(){return c(null)},s.getRecent=function(){return a()},s}]),angular.module("castifyExt.connect.bgConnectService",["castifyExt.connect.appPermissions","castifyExt.connect.connectedApps","castifyExt.connect.appRecorder","castifyExt.simpleBgServicePublisher","castifyExt.bgSyncManager","castifyExt.bgFiles","w69b.chromeTabs","w69b.chromeWindows","w69b.asyncResponse","w69b.chromeRuntime","w69b.spawn","w69b.uritool","w69b.promiseTool"]).factory("bgConnectService",["connectedApps","appPermissions","$q","chromeTabs","spawn","uritool","simpleBgServicePublisher","chromeRuntime","asyncResponse","$log","chromeWindows","promiseTool","bgSyncManager","appRecorder","bgFiles",function(e,t,r,n,o,i,a,c,u,s,l,d,f,p,h){function g(e){var t="app.html#/files/"+encodeURIComponent(e);return n.create({url:t})}function m(e,t){return o(regeneratorRuntime.mark(function r(){var o,i,a,c,u,f,p,h,g,m,v,b;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:o=function(e){return d.withTimeout(function(){return e.sendWithResponse("shareFiles",t)},k)},i=!0,a=!1,c=void 0,r.prev=4,u=S.entries()[Symbol.iterator]();case 6:if(i=(f=u.next()).done){r.next=32;break}if(p=f.value,h=p[0],g=p[1],g.app.id===e){r.next=12;break}return r.abrupt("continue",29);case 12:return m=g.sender,r.prev=13,r.next=16,o(m);case 16:v=r.sent,r.next=23;break;case 19:r.prev=19,r.t0=r["catch"](13),s.debug("connect: shareFiles handler rejected with",r.t0),v=!1;case 23:if(!v){r.next=29;break}return b=h.sender.tab,s.debug("connect: shareFiles handled directly, focusing",b),n.update(b.id,{active:!0}),l.update(b.windowId,{focused:!0}),r.abrupt("return",!0);case 29:i=!0,r.next=6;break;case 32:r.next=38;break;case 34:r.prev=34,r.t1=r["catch"](4),a=!0,c=r.t1;case 38:r.prev=38,r.prev=39,!i&&u["return"]&&u["return"]();case 41:if(r.prev=41,!a){r.next=44;break}throw c;case 44:return r.finish(41);case 45:return r.finish(38);case 46:return r.abrupt("return",!1);case 47:case"end":return r.stop()}},r,this,[[4,34,38,46],[13,19],[39,,41,45]])}))}function v(e,t,r){var n=!0,o=!1,i=void 0;try{for(var a,c=S.values()[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var u=a.value;u.app.id===t&&u.sender.send(e,r)}}catch(s){o=!0,i=s}finally{try{!n&&c["return"]&&c["return"]()}finally{if(o)throw i}}}function b(e){var t=!0,r=!1,n=void 0;try{for(var o,i=S.values()[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var a=o.value;if(a.app.id===e)return!0}}catch(c){r=!0,n=c}finally{try{!t&&i["return"]&&i["return"]()}finally{if(r)throw n}}return!1}function y(e){return E&&E.appId===e.id}function w(e){"connectFrame"===e.name&&e.onMessage.addListener(function t(r){if("connect"===r.type){var n=r.data,o=u.createSender(function(t){e.postMessage(t)}),i=u.createRespond(e.postMessage.bind(e));e.onMessage.addListener(function(t){if(!o.handleResult(t)&&A.hasOwnProperty(t.type)){var r=A[t.type](n,t.data,e.sender);i(r,t)}}),e.onDisconnect.addListener(function(){var t=S.get(e);t&&y(t.app)&&(s.debug("connect: cancelling start due to port disconnect"),E.cancelPendingStart()),S["delete"](e)}),S.set(e,{app:n,sender:o}),e.onMessage.removeListener(t)}})}var x={},S=new Map,E=null,k=5e3,R="busy",_="access_denied";x.share=function(a,c,u){return o(regeneratorRuntime.mark(function l(){var o,d,p,h,g;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,f.requestSyncLocal(c);case 2:if(o=t.allowAccess(a,c),u){l.next=11;break}return l.next=6,e.getConnectedAppInfoForApp(a);case 6:if(d=l.sent,u=d&&d.shareUrl){l.next=11;break}return s.warn("connect.share() called for app without shareUrl",d),l.abrupt("return",r.reject("no_share_url"));case 11:return l.next=13,o;case 13:return p=[c],l.next=16,m(a,p);case 16:if(!l.sent){l.next=18;break}return l.abrupt("return");case 18:return h=JSON.stringify({ids:p}),g=u+"?"+i.encodeQuery({state:h}),l.abrupt("return",n.create({url:g}));case 21:case"end":return l.stop()}},l,this)}))};var A={};return A.startRecording=function(e,t,n){return o(regeneratorRuntime.mark(function i(){return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(t=t||{},s.debug("connect: startRecording",e,t),!E||E.appId===e.id){o.next=4;break}return o.abrupt("return",r.reject(R));case 4:if(o.t0=E,!o.t0){o.next=9;break}return o.next=8,E.cancelPendingStart();case 8:o.t0=!o.sent;case 9:if(!o.t0){o.next=12;break}return s.debug("connect: could not cancel pending start"),o.abrupt("return",r.reject(R));case 12:if(!E&&b(e.id)){o.next=14;break}return o.abrupt("return",r.reject(R));case 14:return E=p(e),E.ended.then(function(){v("recordingStateChanged",e.id,"inactive"),E=null}),E.onStateChanged=function(t){v("recordingStateChanged",e.id,t)},E.onTimeChanged=function(t){v("recordingTimeChanged",e.id,t)},t.tabId=n.tab.id,o.abrupt("return",E.start(t));case 20:case"end":return o.stop()}},i,this)}))},A.stopRecording=function(e){return y(e)?E.stop():r.reject(R)},A.pauseRecording=function(e){return y(e)?E.pause():r.reject(R)},A.resumeRecording=function(e){return y(e)?E.resume():r.reject(R)},A.getRecordingState=function(e){return y(e)?E.getState():"inactive"},A.getRecordingTime=function(e){return y(e)?E.getTime():0},A.storeFileInLibrary=o.wrap(regeneratorRuntime.mark(function C(e,n){var o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return n=n||{},o=n.fileId,a.next=4,t.hasAccess(e.id,o);case 4:if(a.sent){a.next=6;break}return a.abrupt("return",r.reject(_));case 6:return a.next=8,h.getFileDescriptor(o);case 8:if(i=a.sent,i.autoShare){a.next=11;break}return a.abrupt("return",r.reject("file is already stored in library"));case 11:return a.next=13,f.storeAutoSharedFile(o);case 13:if(!n.openFile){a.next=16;break}return a.next=16,g(o);case 16:case"end":return a.stop()}},C,this)})),x.install=function(){c.onConnect.addListener(w),a("connect",x,["install"])},x}]),angular.module("castifyExt.connect.appRegistry",["w69b.spawn","w69b.chromeStorage"]).factory("appRegistry",["castifyConfig","$http","$q","spawn","chromeStorage",function(e,t,r,n,o){function i(){return o.local.getSingle(h,[])}function a(e){return o.local.setSingle(h,e)}function c(e){return i().then(function(t){return t.filter(function(t){return e.includes(t.id)})})}function u(e,t){var r=Date.now(),n=e.some(function(e){return r>e._fetchTimestamp+g});return!n&&t.length===e.length}function s(e){return e.forEach(function(e){delete e._fetchTimestamp}),e}function l(e,t){return n(regeneratorRuntime.mark(function r(){var n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return e=new Set(e||[]),r.next=3,i();case 3:return n=r.sent,t.forEach(function(t){e.add(t.id)}),n=n.filter(function(t){return!e.has(t.id)}),t.forEach(function(e){e._fetchTimestamp=Date.now()}),n=n.concat(t),r.next=10,a(n);case 10:case"end":return r.stop()}},r,this)}))}function d(e){return n(regeneratorRuntime.mark(function o(){var n,i,a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(e&&0!==e.length){o.next=2;break}return o.abrupt("return",r.when([]));case 2:return o.next=4,c(e);case 4:if(i=o.sent,!u(i,e)){o.next=7;break}return o.abrupt("return",s(i));case 7:return o.prev=7,o.next=10,t.get(f,{params:{ids:e}});case 10:a=o.sent,n=a.data,o.next=17;break;case 14:return o.prev=14,o.t0=o["catch"](7),o.abrupt("return",s(i));case 17:return o.next=19,l(e,n);case 19:return o.abrupt("return",s(n));case 20:case"end":return o.stop()}},o,this,[[7,14]])}))}var f=e.API_URL+"/apps",p={},h="appRegistry:cache",g=6e4;return p.getApps=function(e){return d(e)},p.getAppInfo=function(e){return d([e]).then(function(e){return e.length?e[0]:r.reject()})},p}]),angular.module("castifyExt.connect.appPermissions",["w69b.chromeStorage","w69b.spawn"]).factory("appPermissions",["chromeStorage","spawn",function(e,t){function r(e){var t=Date.now();return e.filter(function(e){return e.timeout>=t})}function n(){return e.local.getSingle(i,[]).then(r)}function o(t){return e.local.setSingle(i,t)}var i="appPermissions",a=18e5,c={};return c.hasAccess=function(e,t){return n().then(function(r){return r.some(function(r){return r.appId===e&&r.fileId===t})})},c.allowAccess=function(e,r){return t(regeneratorRuntime.mark(function i(){var t;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,n();case 2:return t=i.sent,t=t.filter(function(t){return t.appId!==e&&t.appId!==r}),t.push({appId:e,fileId:r,timeout:Date.now()+a}),i.next=7,o(t);case 7:case"end":return i.stop()}},i,this)}))},c}]),angular.module("castifyExt.connect.appRecorder",["castifyExt.bgRecord","castifyExt.recordTool","w69b.spawn"]).factory("appRecorder",["bgRecordService","recordTool","$q","$rootScope","spawn",function(e,t,r,n,o){function i(i){function f(){v.resolve()}function p(){var e=[];e.push(n.$watch(b.getState,function(e,t){e!==t&&b.onStateChanged&&b.onStateChanged(e)})),e.push(n.$watch(b.getTime,function(e,t){e!==t&&b.onTimeChanged&&b.onTimeChanged(e)})),b.ended.then(function(){e.forEach(function(e){e()})})}function h(e){return angular.isObject(e)&&g(e.width,a,c)&&g(e.height,a,c)}function g(e,t,r){return angular.isNumber(e)&&e>=t&&e<=r}function m(e){e.recordConfig=e.recordConfig||{};var t=e.recordConfig;if(!angular.isObject(t))throw new Error("invalid recordConfig");if(t.audio=t.audio||{},!angular.isObject(t.audio))throw new Error("invalid recordConfig.audio");if(t.captureSource=t.captureSource||"desktop",!["desktop","screen","tab"].includes(t.captureSource))throw new Error("invalid captureSource");if(t.maxResolution=t.maxResolution||null,t.maxResolution){if(!h(t.maxResolution))throw new Error("invalid maxResolution");t.maxResolution={width:t.maxResolution.width,height:t.maxResolution.height}}if(t.maxFps=t.maxFps||null,t.maxFps&&!g(t.maxFps,s,u))throw new Error("invalid maxFps");if(t.startDelay=t.startDelay||0,t.audibleCountdown=!angular.isDefined(t.audibleCountdown)||!!t.audibleCountdown,t.embedWebcam=!!t.embedWebcam,t.startDelay&&!g(t.startDelay,l,d))throw new Error("invalid startDelay");if(!e.shareUrl&&!i.shareUrl)throw new Error("shareUrl required");if(e.shareUrl&&!/https?:\/\//.test(e.shareUrl))throw new Error("invalid shareUrl")}var v=r.defer(),b={};b.appId=i.id,b.ended=v.promise;var y=null,w=o.wrap(regeneratorRuntime.mark(function x(r){var n,o,a,c,u,s;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return r=r||{},m(r),n=r.recordConfig,o=t.canCaptureSystemAudio(),a=r.payload,l.next=7,t.getRecordConfig();case 7:return c=l.sent,u={},"tab"===n.captureSource&&(o=!0,angular.isObject(n.draw)&&(s=n.draw,u.draw={showToolbox:!!s.showToolbox},[null,"pointer"].includes(s.tool)&&(u.draw.tool=s.tool))),angular.extend(u,{captureSource:n.captureSource,tabId:r.tabId,startDelay:n.startDelay,audibleCountdown:n.audibleCountdown,targetFPS:n.maxFps,resolution:n.maxResolution,audio:{mic:!!n.audio.mic,micSourceId:n.audio.micSourceId||c.audio.micSourceId,system:o&&n.audio.system},autoShareApp:{id:i.id},connectMeta:{appId:i.id,shareUrl:r.shareUrl,payload:a}}),i.isWhitelisted&&angular.extend(u,{embedWebcam:n.embedWebcam,camPosition:n.camPosition||"bottomRight",camSourceId:n.camSourceId||c.camSourceId}),l.abrupt("return",e.start(u));case 13:case"end":return l.stop()}},x,this)}));return b.start=function(e){var t=r.when(w(e));y=t["finally"](function(){y=null}),t["catch"](f);var o=n.$on("recorder:stopped",function(){f(),o()});return t},b.pause=function(){return e.pause()},b.resume=function(){return e.resume()},b.restart=function(){return e.restart()},b.stop=function(){return e.stop()},b.getState=function(){return e.getRecorderState().state},b.getTime=function(){return e.getRecorderState().time},b.cancelPendingStart=function(){if(y&&e.cancelPendingStart()){var t=y.then(function(){return!1},function(){return!0});return y=null,t}return r.when(!1)},p(),b}var a=64,c=4096,u=60,s=1,l=0,d=10;return i}]),angular.module("castifyExt.webrtcRecorder",["w69b.spawn","w69b.filesHelper","w69b.asyncResponse","castifyExt.pausableTimer"]).factory("webrtcRecorder",["$log","filesHelper","spawn","asyncResponse","PausableTriggeringTimer","$rootScope","$q","PausableTimeout",function(e,t,r,n,o,i,a,c){function u(){function u(){k={state:"inactive",time:0}}function p(t){return I=I.then(function(){if(t||F>P){var e=new Blob(D);return D.length=0,F=0,A.sendWithResponse("write",e)}})["catch"](function(t){e.error("webrtcRecoder: flushQueue failed",t)})}function h(e){D.push(e),F+=e.size,L+=e.size,p()}function g(e){var t=e.data;h(t)}function m(){if(u(),T&&(T.dispose(),T=null),S){try{S.stop()}catch(e){}S=null,D.length=0,F=0}C&&(C.terminate(),C=null,A=null),j.reset()}function v(t){O||(O=!0,e.error("webrtcRecorder: fatal error: ",t),m(),R.onError&&R.onError(t))}function b(){var t=S?S.state:"inactive";if(e.debug("webrtcRecorder: state change",t),T||k.state!=t){if(T)k.state=T.paused?"paused":"recording";else switch(k.state=t,t){case"paused":j.pause();break;case"recording":j.paused?j.resume():j.started||j.start()}R.onStateChanged&&R.onStateChanged(k.state)}}function y(){k.time=j.time,B(),q(),R.onTimeChanged&&R.onTimeChanged(k.time),i.$$phase||i.$apply()}function w(){_.forEach(function(e){S.addEventListener(e,b)})}function x(e,t){S.addEventListener(e,function r(){S.removeEventListener(e,r),t.apply(this,arguments)})}var S,E,k,R={},_=["start","stop","pause","resume","error"];u();var A,C,T,I=Promise.resolve(),P=65536,$=500,M=500,D=[],F=0,L=0,j=new o(y,M),U=f,O=!1,N=7,B=r.wrap(regeneratorRuntime.mark(function W(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!A){e.next=4;break}return e.next=3,A.sendWithResponse("getFps");case 3:k.fps=e.sent;case 4:case"end":return e.stop()}},W,this)})),q=r.wrap(regeneratorRuntime.mark(function V(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:A&&k.time>=N&&(L||v("no_data"));case 1:case"end":return e.stop()}},V,this)}));return R.onStateChanged=null,R.onTimeChanged=null,R.start=r.wrap(regeneratorRuntime.mark(function z(r,o){var i;return regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:i=function(){return T=null,a.when(new Promise(function(t){x("start",function(){e.debug("webrtcEncoder: onStart"),t()}),w(),S.addEventListener("error",function(t){return e.warn("webrtcEncoder: error event ",t)}),S.start($)}))},e.debug("webrtcRecorder: onStart",r,o),E=new l,E.addTrack(o.videoTrack),o.audioTrack&&E.addTrack(o.audioTrack),u.prev=5,S=new s(E,{BitRate:o.bitRate,mimeType:o.mimeType||d,videoBitsPerSecond:o.bitRate}),u.next=13;break;case 9:throw u.prev=9,u.t0=u["catch"](5),e.error("failed to create MediaRecorder",u.t0),u.t0;case 13:if(!t.isSupported()){u.next=16;break}return u.next=16,t.removeByPath(r)["catch"](function(){return null});case 16:if(C=new Worker(U),A=n.createSender(function(e){return C.postMessage(e)}),C.addEventListener("message",function(e){return A.handleResult(e.data)}),A.send("init",{path:r,fsType:"PERSISTENT"}),S.addEventListener("dataavailable",g),!o.startDelay){u.next=31;break}return j.setStartTime(-o.startDelay),j.start(),T=new c(o.startDelay),T.start(),T.promise.then(i),b(),u.abrupt("return",a.when());case 31:return u.abrupt("return",i());case 32:case"end":return u.stop()}},z,this,[[5,9]])})),R.pause=function(){return T?(T.pause(),j.pause()):S.pause(),b(),a.when()},R.resume=function(){return T?(T.resume(),j.resume()):S.resume(),b(),a.when()},R.getStateObj=function(){return k},R.load=function(){return a.when()},R.getCurrentTime=function(){return k.time},R.stop=r.wrap(regeneratorRuntime.mark(function H(){var e,t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(!T){r.next=7;break}T.dispose(),T=null,j.reset(),b(),r.next=15;break;case 7:return e=new Promise(function(e){x("stop",function(){e()})}),S.stop(),r.next=11,e;case 11:return j.pause(),S=null,r.next=15,p(!0);case 15:return r.next=17,A.sendWithResponse("end");case 17:return t=r.sent,C.terminate(),C=null,A=null,j.reset(),r.abrupt("return",t);case 23:case"end":return r.stop()}},H,this)})),R}var s=window.MediaRecorder,l=window.webkitMediaStream||window.MediaStream,d='video/webm; codecs="vp9, opus"',f="/components/castifyMediawriter/dist/mediawriter.worker.min.js";return u.isSupported=function(e){function t(){var e=navigator.userAgent,t=e.match(/Firefox\/(\d+)/);return t&&t[1]>=44&&e.indexOf("Android")<0}function r(){var e=/Chrome\/(\d+)/.exec(window.navigator.userAgent);return e&&e[1]<51}return"undefined"!=typeof s&&(s.isTypeSupported&&s.isTypeSupported(e||d)||t())&&!r()},u}]),function(){var e=function(){function e(){_classCallCheck(this,e),this.reset()}return _createClass(e,[{key:"_now",value:function(){return Date.now()/1e3}},{key:"start",value:function(){this.reset(),this._firstTimestamp=this._now()}},{key:"reset",value:function(){this._firstTimestamp=-1,this._pausedAtTimestamp=-1,this._offset=0}},{key:"pause",value:function(){this.paused||(this._pausedAtTimestamp=this._now())}},{key:"resume",value:function(){if(!this.paused)throw new Error;this._offset-=this._now()-this._pausedAtTimestamp,this._pausedAtTimestamp=-1}},{key:"time",get:function(){return this.started?this.paused?this._pausedAtTimestamp-this._firstTimestamp+this._offset:this._now()-this._firstTimestamp+this._offset:0}},{key:"started",get:function(){return this._firstTimestamp>=0}},{key:"paused",get:function(){return this._pausedAtTimestamp>=0}}]),e}(),t=function(e){function t(e,r){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._interval=r,n._listener=e,n._startTime=0,n}return _inherits(t,e),_createClass(t,[{key:"setStartTime",value:function(e){this._startTime=e}},{key:"_fireChange",value:function(){this._listener&&this._listener(this.time)}},{key:"_startInterval",value:function(){this._listener&&this._interval&&(this._intervalId=setInterval(this._fireChange.bind(this),this._interval))}},{key:"_stopInterval",value:function(){this._intervalId&&clearInterval(this._intervalId),this._intervalId=0,this._fireChange()}},{key:"reset",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this._stopInterval()}},{key:"start",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this),this._startInterval()}},{key:"pause",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"pause",this).call(this),this._stopInterval()}},{key:"resume",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"resume",this).call(this),this._startInterval()}},{key:"time",get:function(){return _get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"time",this)+this._startTime}}]),t}(e),r=function(e){function t(e){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._timeout=e,r.promise=new Promise(function(e){return r._resolve=e}),r}return _inherits(t,e),_createClass(t,[{key:"_startInterval",value:function(){this._timerId=setTimeout(this._onTimer.bind(this),1e3*this.remaining)}},{key:"_onTimer",value:function(){this._timerId=null,this._resolve(),this.dispose()}},{key:"_stopInterval",value:function(){this._timerId&&clearTimeout(this._timerId)}},{key:"start",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this),this._startInterval()}},{key:"pause",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"pause",this).call(this),this._stopInterval()}},{key:"resume",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"resume",this).call(this),this._startInterval()}},{key:"dispose",value:function(){this._stopInterval(),this._resolve=null,this.promise=null}},{key:"remaining",get:function(){return this._timeout-this.time}}]),t}(e);angular.module("castifyExt.pausableTimer",[]).value("PausableTimer",e).value("PausableTimeout",r).value("PausableTriggeringTimer",t)}(),angular.module("castifyExt.optionalPermissions",["w69b.chromePermissions"]).factory("optionalPermissions",["chromePermissions",function(e){function t(e){return e&&(!e.draw||e.draw&&!e.draw.showToolbox)?o:n}var r={},n={permissions:["tabCapture","webNavigation","activeTab"],origins:["<all_urls>"]},o={permissions:["tabCapture","webNavigation","activeTab"],origins:[]};return r.hasLiteTabPermissions=function(){return e.contains(o)},r.hasTabPermissions=function(r){return e.contains(t(r))},r.requestTabPermissions=function(r){
return e.request(t(r))},r}]),angular.module("castifyExt.hdpiTool",[]).factory("hdpiTool",["$window",function(e){var t={};return t.devicePixelRatio=e.devicePixelRatio,t.toPhysicalResolution=function(e){return{width:Math.floor(e.width*t.devicePixelRatio),height:Math.floor(e.height*t.devicePixelRatio)}},t.toCssResolution=function(e){return{width:Math.round(e.width/t.devicePixelRatio),height:Math.round(e.height/t.devicePixelRatio)}},t.getScreenCssResolution=function(){return{width:e.screen.width,height:e.screen.height}},t.scaleResolution=function(e,t){var r=Math.min(t.height/e.height,t.width/e.width,1);return{width:Math.floor(e.width*r),height:Math.floor(e.height*r)}},t}]),angular.module("castifyExt.userAccount",["castifyExt.simpleBgServiceConsumer","castifyExt.chromeEventPublisher"]).factory("userAccount",["simpleBgServiceConsumer",function(e){return e("userAccount",["getAccount","signIn","postUpdate","signOut"])}]),angular.module("castifyExt.bgUserAccount",["castifyExt.userAccount","castifyExt.chromeEventPublisher","castifyExt.simpleBgServicePublisher","castifyExt.castifyAuth","castifyExt.bgLicensing","castifyExt.statsClient","w69b.chromeRuntime","w69b.chromeStorage","w69b.promiseTool","w69b.chromeAnalytics","w69b.spawn"]).factory("bgUserAccount",["$http","castifyAuth","$rootScope","castifyConfig","spawn","promiseTool","simpleBgServicePublisher","$log","chromeStorage","chromeRuntime","bgLicensing","$q","analytics","statsClient",function(e,t,r,n,o,i,a,c,u,s,l,d,f,p){function h(e){return e.data}function g(t){return e.post(_,t,{googleAuth:!0}).then(h)}function m(e){return T=e,u.local.setSingle(A,e)}function v(){return u.local.getSingle(A,null)}function b(e){return!e.license||!e.license.validTill||e.license.validTill<Date.now()}function y(){T&&T.user&&(c.debug("userAccount: refreshing account due to auth sign-in error"),x())}function w(){r.$broadcast("event:userAccountChanged"),s.sendMessage({type:"event:userAccountChanged"})["catch"](angular.identity),c.debug("userAccount: firing accountChanged")}function x(){c.debug("userAccount: refreshing account"),D(),M()["finally"](function(){w()})}function S(e,t,r){r.isPaidInstall&&x()}function E(e,t,r){function n(e){return!e||e>=Date.now()}n(t)!=n(r)&&x()}function k(e,t){return t?t.isPaid?t:e.isPaid?e:t.isTester?t:e.isTester?e:t.branding?e.branding?t.limitNumRecordings?e.limitNumRecordings?t:e:t:e:t:e}var R={},_=n.API_URL+"/account",A="userAccount",C=i.serializer(),T=null,I=o.wrap(regeneratorRuntime.mark(function L(){return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.getAccount();case 2:if(r.sent){r.next=4;break}return r.abrupt("return",null);case 4:return r.abrupt("return",e.get(_,{params:{license:"1"},googleAuth:!0}).then(h));case 5:case"end":return r.stop()}},L,this)})),P=o.wrap(regeneratorRuntime.mark(function j(e){var t,r,n,o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,d.all([e?e:I()["catch"](function(){return null}),l.getLicense()]);case 2:return t=a.sent,r=_slicedToArray(t,2),n=r[0],o=r[1],i=null,n&&(i=n.license,delete n.license),i=k(o,i),a.abrupt("return",{license:i,user:n});case 10:case"end":return a.stop()}},j,this)})),$=i.serializer().wrap(o.wrap(regeneratorRuntime.mark(function U(e){var t,r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!T){n.next=2;break}return n.abrupt("return",{account:T,updated:!1});case 2:return t=e,r=!1,e&&b(e)&&(e=null),n.next=7,P(e);case 7:if(e=n.sent,c.debug("userAccount: fetched",e),e.user||!t||!t.user){n.next=14;break}c.debug("userAccount: using expired, but signed-in account",t),e=t,n.next=19;break;case 14:return r=!0,m(e),n.next=18,p.clearDirtyNumRecordings();case 18:c.debug("userAccount: updated cache");case 19:return T=e,n.abrupt("return",{account:e,updated:r});case 21:case"end":return n.stop()}},U,this)}))),M=C.wrap(o.wrap(regeneratorRuntime.mark(function O(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!T){t.next=2;break}return t.abrupt("return",T);case 2:return t.next=4,v();case 4:if(e=t.sent,e&&e.license){t.next=11;break}return t.next=8,$(e);case 8:return t.abrupt("return",t.sent.account);case 11:if(!e||!b(e)){t.next=16;break}return C(function(){return $(e)}).then(function(e){e.updated&&w()}),t.abrupt("return",e);case 16:return t.abrupt("return",e);case 17:case"end":return t.stop()}},O,this)}))),D=C.wrap(function(){return c.debug("userAccount: clearing cache"),T=null,m(null)}),F=o.wrap(regeneratorRuntime.mark(function N(e){var t,r,n;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return t=function(e){return e.getUTCFullYear()+"-"+e.getUTCMonth()},o.next=3,p.getDirtyNumRecordings();case 3:return r=o.sent,n=0,e.user&&e.user.fetchedAt&&e.user.numRecordingsMonth&&t(new Date(e.user.fetchedAt))==t(new Date)&&(n=e.user.numRecordingsMonth),e.numRecordingsMonth=r+n,o.abrupt("return",e);case 8:case"end":return o.stop()}},N,this)}));return R.signIn=function(e){var r=t.getAuthToken({interactive:!e||"select_account"});return f.trackEvent("signIn","start"),r.then(function(){f.trackEvent("signIn","success")},function(){f.trackEvent("signIn","cancelled")}),r},R.signOut=o.wrap(regeneratorRuntime.mark(function B(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c.debug("userAccount: signOut"),e.next=3,d.all([t.signOut(),D()]);case 3:x();case 4:case"end":return e.stop()}},B,this)})),R.getAccount=o.wrap(regeneratorRuntime.mark(function q(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=F,e.next=3,M();case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}},q,this)})),R.update=function(){return x()},R.postUpdate=o.wrap(regeneratorRuntime.mark(function W(e){var t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.t0=P,r.next=3,g(e);case 3:return r.t1=r.sent,r.next=6,(0,r.t0)(r.t1);case 6:return t=r.sent,r.next=9,p.clearDirtyNumRecordings();case 9:return m(t),w(),r.abrupt("return",F(t));case 12:case"end":return r.stop()}},W,this)})),R.$testClearMemoryCache=function(){T=null},R.install=function(){a("userAccount",R,["install"]),r.$on("event:signInChanged",x),r.$on("connect:appConnected",S),r.$on("connect:userExpiryDateChange",E),r.$on("castifyAuth:notSignedIn",y)},R}]).factory("userAccount",["bgUserAccount",function(e){return e}]),angular.module("castifyExt.statsClient",["w69b.chromeStorage","w69b.spawn"]).factory("statsClient",["$http","castifyConfig","chromeStorage","spawn","$q",function(e,t,r,n,o){function i(){var e=new Date;return e.getUTCFullYear()+"-"+e.getUTCMonth()}function a(e){var t={};return t[i()]=e,r.local.setSingle(d,t)}function c(){return null}var u={},s=t.API_URL+"/stats",l={googleAuth:!0},d="numRecordingsByMonthDirty";u.getDirtyNumRecordings=n.wrap(regeneratorRuntime.mark(function p(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,r.local.getSingle(d,{});case 2:return e=t.sent,t.abrupt("return",e[i()]||0);case 4:case"end":return t.stop()}},p,this)})),u.clearDirtyNumRecordings=function(){return a(0)};var f=n.wrap(regeneratorRuntime.mark(function h(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,u.getDirtyNumRecordings();case 2:return e=t.sent,t.next=5,a(++e);case 5:case"end":return t.stop()}},h,this)}));return u.sendRecordingCreated=function(t){return o.all([f(),e.post(s+"/recording_created",{duration:t},l)])["catch"](c)},u}]),angular.module("w69b.downloadHelper",[]).factory("downloadHelper",function(){var e={};return e.download=function(e,t){var r=angular.element("<a></a>"),n=t.replace(/[\/,\\]/g,"");r.attr("href",e),r.attr("download",n),r[0].dispatchEvent(new MouseEvent("click"))},e}),angular.module("castifyEdit.pnaclVideoEditor",["w69b.pnaclModule","w69b.promiseTool"]).factory("pnaclVideoEditor",["pnaclModule","$q","$log","$rootScope","promiseTool",function(e,t,r,n,o){function i(i,a){function c(){v={state:"inactive",time:0}}function u(){b.unload(),c()}function s(e){v=e,"done"!==e.state&&"cancelled"!==e.state||b.unload()}function l(e){u(),y&&y.reject(e),y=null}function d(e){r.error("pnaclVideoEditorError",e),l(e),S.onError&&S.onError(e)}function f(e,t){b.postMessage({type:e,data:t||{}})}function p(e,r){if(y)throw new Error("there is still a pending operation");return y=t.defer(),e&&f(e,r),y.promise}function h(e){if(!/^\/html5_(temporary|persistent)\//.test(e))throw new Error("invalid filename")}function g(e){l(),S.onCrash&&S.onCrash(e)}function m(){return Number((/Chrome\/(\d+)/.exec(window.navigator.userAgent)||[void 0,0])[1])}var v,b=e(i,a),y=null,w=8e5,x=["start","cancel"],S={};return b.onMessage=function(e){if(e=e.data,x.indexOf(e.type)>=0){if(!y)return;e.data?y.reject(e.data):y.resolve(),y=null}else if("error"==e.type)d(e.data),n.$$phase||n.$digest();else if("state"==e.type)s(e.data),n.$$phase||n.$digest();else if("stack_trace"==e.type)g(e.data);else{var t;e.data&&(t=e.data,t.trim&&(t=t.trim())),r.debug(e.type,t)}},S.onCrash=void 0,b.onCrash=g,S.load=function(){return b.load()},S.getStateObj=function(){return v},S.cancel=function(){return o.withTimeout(function(){return p("cancel")},1e3)["catch"](function(){return null}).then(function(){l()})},S.hasPendingOperation=function(){return!!y},S.start=function(e){return h(e.inFilename),h(e.outFilename),o.withTimeout(function(){return b.load().then(function(){return p("start",{config:JSON.stringify(e),chromeVersion:m()})})},w,function(){return d("start_timeout"),t.reject("start_timeout")})},c(),S}return i}]),angular.module("castifyEdit.localEditJob",["castifyEdit.pnaclVideoEditor","w69b.filesHelper"]).factory("startLocalEditJob",["pnaclVideoEditor","$q","$log","$rootScope",function(e,t,r,n){function o(i){function a(){l=n.$watch(function(){return s.getStateObj().state},function(e){"done"===e?u.resolve():"error"===e&&u.resolve(s.getStateObj().errorReason)})}function c(){return r.debug("startLocalEditJob: starting job",i),s=e(o.NACL_URL),u=t.defer(),s.start(i).then(a,function(e){r.error("failed to start local edit job",e),u.reject("start_error")}),s.onCrash=function(e){r.error("startLocalEditJob crashed",e),u.reject("crash")},s.onError=function(e){r.error("localEditJob error: ",e),u.reject(e)},u.promise["finally"](l),u.promise}var u,s,l=angular.noop,d={};return d.getProgress=function(){var e=s.getStateObj();return e.totalMs&&e.progressMs?e.progressMs/e.totalMs:0},d.cancel=function(){return s.cancel()},d.promise=c(),d}return o}]),angular.module("castifyEdit.remoteEditJob",["castifyEdit.pnaclVideoEditor"]).factory("startRemoteEditJob",["$q","$log","$timeout","$http","castifyConfig",function(e,t,r,n,o){function i(o){function i(){g&&r.cancel(g),r(function(){g=null,d()},c)}function u(){return n.get(a+"/"+h,{googleAuth:!0}).then(function(e){return e.data})}function s(e){p.reject(e)}function l(e){var t;t=e.result.gcsFile?{isExport:!0,saveFileName:e.result.saveFileName,url:a+"/export/"+e.id+"/"+e.result.gcsFile}:e.result,p.resolve(t)}function d(){u().then(function(e){var r=e.state;"completed"===r?l(e):"failed"===r?s(e.result&&e.result.error?e.result.error:"remote_failed"):"cancelled"===r?t.debug("remote edit job was cancelled",h):(m=e.progress,i())},function(e){e.status>=400&&e.status<500?s(e):i()})}function f(){return p=e.defer(),n.post(a,{config:o,version:2},{googleAuth:!0}).then(function(e){var r=e.data;t.debug("startRemoteEditJob: job created",r.id),h=r.id,i()},s),p.promise}var p,h,g,m=0,v={};return v.getProgress=function(){return m},v.cancel=function(){return h?n["delete"](a+"/"+h,{googleAuth:!0}):e.reject()},v.promise=f(),v}var a=o.API_URL+"/edit",c=3e3;return i}]),angular.module("castifyEdit.bgEditJobScheduler",["castifyEdit.startEditJob","castifyEdit.fixWebmJob","castifyExt.bgFiles","castifyExt.simplePortService"]).factory("ScheduledEditJob",["startEditJob","bgFiles","startFixWebmJob","$q",function(e,t,r,n){function o(e){this.config=e,this.state="queued",this.id=i++,this._doneDeferred=n.defer(),this.promise=this._doneDeferred.promise,e.meta&&e.meta.fileId&&t.getFileDescriptor(e.meta.fileId).then(function(e){this.fileDesc=e}.bind(this))}var i=1,a=o.prototype;return a.start=function(){var t=this;t.state="running";var n="fixWebm"===this.config.type?r:e,o=n(t.config);return o=o.then(function(e){return t.editJob=e,e.promise}),o.then(t.onComplete_.bind(t),t.onError_.bind(t)),o.then(this._doneDeferred.resolve.bind(this._doneDeferred),this._doneDeferred.reject.bind(this._doneDeferred)),o},a.getProgress=function(){return"done"===this.state?1:"running"===this.state&&this.editJob?this.editJob.getProgress():0},a.onComplete_=function(e){this.result=e,this.state="done"},a.onError_=function(){this.state="error"},a.cancel=function(){return!(!this.editJob||!this.editJob.cancel)&&(this.editJob.cancel(),this.state="cancelled",!0)},a.toJSON=function(){var e={id:this.id,result:this.result,state:this.state,progress:this.getProgress(),cancelDanger:"fixWebm"===this.config.type};return e.cancelable=!(!this.editJob||!this.editJob.cancel),this.config.meta&&this.config.meta.fileId&&(e.fileId=this.config.meta.fileId),this.fileDesc&&(e.fileTitle=this.fileDesc.title),e},o}]).factory("bgEditJobScheduler",["simplePortService","$rootScope","ScheduledEditJob","$log","chromeRuntime",function(e,t,r,n,o){function i(e){return m.filter(function(t){return t.state===e})}function a(e){return m.find(function(t){return t.id===e})}function c(){return i("running")}function u(){return i("queued")}function s(){if(!(c().length>0)){var e=i("queued");if(e.length){var r=e[0];n.debug("starting scheduled edit",r);var o=r.start();t.$broadcast("editJob:started",r.id),o.then(d.bind(null,r),l.bind(null,r))}}}function l(e,r){n.warn("scheduled edit job failed",e,r),s(),t.$broadcast("editJob:failed",e.id,r)}function d(e,r){n.debug("scheduled edit job completed",e,r),s(),t.$broadcast("editJob:completed",e.id,r)}function f(){function r(){o.postMessage("jobsList",g.getJobs())}function n(){t.$on("editJob:completed",r),t.$on("editJob:started",r),t.$on("editJob:failed",r),t.$on("editJob:cancelled",r),o.install()}var o=e("editor");return o.handlers={addJob:g.addJob,cancel:g.cancel,getJobs:r,clearComplete:g.clearComplete},n(),{postJobs:r}}function p(){(u().length||c().length)&&(n.info("onSuspend() while editing is active, preventing unloading"),o.getBackgroundPage())}var h,g={},m=[];return g.addJob=function(e){n.debug("adding edit job",e);var t=new r(e);return m.push(t),s(),t},g.cancel=function(e){n.debug("canceling edit job",e);var r=a(e);r&&r.cancel()&&t.$broadcast("editJob:cancelled",r.id)},g.getJob=function(e){return a(e)},g.getJobs=function(){return m},g.clearComplete=function(e){m=m.filter(function(t){return"done"!==t.state||e&&t.id!==e}),h&&h.postJobs()},g.install=function(){h=f(),o.onSuspend.addListener(p)},g}]),angular.module("castifyEdit.startEditJob",["castifyEdit.localEditJob","castifyEdit.remoteEditJob","castifyExt.bgFiles","castifyExt.videoPreviewRenderer","castifyExt.fileNameGenerator","w69b.filesHelper","w69b.spawn"]).factory("startEditJob",["startLocalEditJob","startRemoteEditJob","bgFiles","filesHelper","videoPreviewRenderer","$log","fileNameGenerator","$q","spawn",function(e,t,r,n,o,i,a,c,u){function s(s){function g(){return n.getDirByPath(d,{create:!0})}function m(){var t="gif"===s.outFormat?p:f;return g().then(function(){var n=angular.extend({inFilename:l+r.idToLocalFilename(T.id),outFilename:l+t},s);return delete n.meta,e(n)})}function v(){return i.debug("running local post edit steps"),"gif"===s.outFormat?b():y()}function b(){return i.info("gif export complete"),n.getFileEntryByPath(p).then(function(e){return{url:e.toURL(),isExport:!0,saveFileName:T.title+"."+s.outFormat}})}function y(){var e;return a("",".webm").then(function(t){return e=r.localFilenameToId(t),n.moveFileByPath(f,t)["catch"](function(e){return i.error("failed to move edited file to ",t),c.reject(e)})}).then(function(){return i.debug("rendering preview"),o.renderPreview(e)["catch"](function(){return i.info("rendering preview image for edit failed"),null})}).then(function(){return r.registerLocalFile(e)}).then(function(){var t=T.title;return s.meta.copy&&(t+=h),r.rename(e,t),{fileId:e}})}function w(e){return i.debug("running local post edit steps"),c.reject(e)}function x(){n.removeByPath(f),n.removeByPath(p)}function S(){var e=angular.extend({},s,{meta:angular.extend(s.meta,{driveId:T.driveInfo.id})});return t(e)}function E(e){return i.debug("running drive post edit steps for",e),r.refresh(e.id),{fileId:e.id}}function k(e){return e}function R(e){return i.debug("remote edit job completed"),e.isExport?k(e):E(e)}function _(e){return c.reject(e)}function A(e){return u(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(s.meta.copy||"gif"===s.outFormat){t.next=3;break}return t.next=3,r.remove(T.id)["catch"](angular.noop);case 3:return t.abrupt("return",e);case 4:case"end":return t.stop()}},t,this)}))}function C(){return u(regeneratorRuntime.mark(function e(){var t,n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.getFileDescriptor(s.meta.fileId);case 2:if(t=e.sent,T=t,!t.driveInfo){e.next=9;break}n=S(),o=n.promise.then(R,_),e.next=15;break;case 9:return e.next=11,m(t);case 11:n=e.sent,o=n.promise.then(v,w),i=n.cancel.bind(n),n.cancel=function(){return i().then(x)};case 15:return o=o.then(A),n.promise=o,e.abrupt("return",n);case 18:case"end":return e.stop()}},e,this)}))}var T;return C()}e.NACL_URL="manifest_editor.nmf";var l="/html5_persistent/",d="_tmp",f=d+"/edited.webm",p=d+"/exported.gif",h=" - Edited";return s}]),angular.module("castifyEdit.editNotifications",["w69b.chromeNotifications","w69b.promiseTool","castifyEdit.bgEditJobScheduler","castifyExt.ui.openInAppTab","castifyExt.appOptions","w69b.downloadHelper"]).factory("editNotifications",["$rootScope","$log","chromeNotifications","$q","openInAppTab","appOptions","chromeTabs","promiseTool","$interval","bgEditJobScheduler","downloadHelper",function(e,t,r,n,o,i,a,c,u,s,l){function d(e){function t(t,o){d(function(){var i,a=y+e+":"+t,c=!l;return l&&l!==a?(i=r.clear(l),c=!0):i=n.when(),o=angular.extend({type:"basic",priority:0,eventTime:Date.now(),isClickable:!1,title:"Processing Video",iconUrl:"images/icon128.png"},o),l=a,c?i.then(function(){return r.create(a,o)}):i.then(function(){return r.update(a,o)})})}function o(){t("progress",{type:"progress",message:"We are currently processing your video.",progress:Math.floor(100*p.getProgress())})}var a,l=null,d=c.serializer(),f={},p=s.getJob(e);return f.hide=function(){u.cancel(a),d(function(){if(l){var e=r.clear(l);return l=null,e}})},f.start=function(){i.values.notifyEditProgress&&(o(),a=u(o,1e3))},f.complete=function(e,r){i.values.notifyEditProgress&&(u.cancel(a),r.fileId&&t("complete",{type:"basic",title:"Processing Complete",message:"Your video is ready",buttons:[{title:"Show File"}]}),r.isExport?t("export_complete",{type:"basic",title:"Processing Complete",message:"Your export is ready",buttons:[{title:"Save File"}]}):f.hide())},f.failure=function(){u.cancel(a),t("failed",{type:"basic",title:"Failed to process Video",message:"Please contact support if this problem persists"})},f}function f(e){var t=w[e];return t||(t=d(e),w[e]=t),t}function p(e,t){f(t).start()}function h(e,t,r){f(t).failure(r),delete w[t]}function g(e,t,r){f(t).complete(t,r),delete w[t]}function m(e,t){f(t).hide(),delete w[t]}function v(e,t){if(e.startsWith(y)){var n=Number(e.split(":").slice(1,2)[0]),i=s.getJob(n),a=e.split(":").slice(2,3)[0];i&&i.result&&("complete"===a?o("app.html#/files/"+encodeURIComponent(i.result.fileId)):"export_complete"===a&&(l.download(i.result.url,i.result.saveFileName),s.clearComplete(n))),r.clear(e)}}var b={},y="edit:",w={};return b.install=function(){e.$on("editJob:started",p),e.$on("editJob:failed",h),e.$on("editJob:completed",g),e.$on("editJob:cancelled",m),r.onButtonClicked.addListener(v)},b}]),angular.module("castifyEdit.fixWebmJob",["w69b.asyncResponse","w69b.spawn","w69b.filesHelper"]).factory("startFixWebmJob",["asyncResponse","spawn","filesHelper","$q",function(e,t,r,n){function o(){return r.getDirByPath(u,{create:!0})}function i(e){this.config=e,this.progress=0}var a,c="/components/castifyMediawriter/dist/mediawriter.worker.min.js",u="_tmp",s=u+"/edited.webm",l=i.prototype;return l.start=function(){return this.promise=this._doStart(),this.promise},l._doStart=t.wrap(regeneratorRuntime.mark(function d(){var t,i,u,l;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return t=this.config,a=new Worker(c),this._cancelDeferred=n.defer(),d.next=5,o();case 5:return i=e.createSender(function(e){return a.postMessage(e)}),a.addEventListener("message",function(e){var t=e.data;i.handleResult(t)||"progress"===t.type&&(this.progress=t.data)}.bind(this)),i.send("init",{path:s,fsType:"PERSISTENT"}),u=!1,l=i.sendWithResponse("readChromeFile",{path:t.inPath,fsType:"PERSISTENT"}),d.next=12,n.race([this._cancelDeferred.promise.then(function(){return u=!0}),l]);case 12:if(a.terminate(),a=null,this._cancelDeferred=null,u){d.next=20;break}return d.next=18,r.moveFileByPath(s,t.outPath);case 18:return d.next=20,r.removeByPath(t.inPath);case 20:return d.abrupt("return",{fileId:this.config.fileId});case 21:case"end":return d.stop()}},d,this)})),l.cancel=t.wrap(regeneratorRuntime.mark(function f(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a&&this._cancelDeferred){t.next=2;break}return t.abrupt("return",!1);case 2:return a.terminate(),e=this.config,t.next=6,r.removeByPath(s)["catch"](function(){return null});case 6:return t.next=8,r.moveFileByPath(e.inPath,e.outPath);case 8:return this._cancelDeferred.resolve(),t.abrupt("return",!0);case 10:case"end":return t.stop()}},f,this)})),l.getProgress=function(){return this.progress},function(e){var t=new i(e);return t.start(),Promise.resolve(t)}}]),angular.module("w69b.chromeAnalytics",[]).provider("analytics",function(){var e,t;this.setTrackingId=function(t){e=t},this.setApp=function(e,r){t=arguments},this.$get=["$window",function(r){if(!t)throw new Error("make sure to call analyticsProvider.setApp()");if(!r.analytics)throw new Error("chrome-analytics lib not loaded");var n=r.analytics,o=n.getService.apply(n,t),i=o.getTracker(e),a={};return a.tracker=i,a.eventBuilder=function(){return n.EventBuilder.builder()},a.setEnabled=function(e){o.getConfig().addCallback(function(t){t.setTrackingPermitted(e)})},a.send=function(){i.send.apply(i,arguments)},a.trackPageView=function(e){i.sendAppView(e)},a.trackEvent=function(){i.sendEvent.apply(i,arguments)},a.sendNonInteractionEvent=function(e,t,r,o){var i={eventCategory:e,eventAction:t,eventLabel:r,eventValue:o,nonInteraction:!0};a.send(n.HitTypes.EVENT,i)},a.trackTimer=function(e,t,r){var n,o={};return o.start=function(){return n=(new Date).getTime(),o},o.send=function(a,c,u){var s=(new Date).getTime();return i.sendTiming(a||e,c||t,s-n,u||r),o},o.start(),o},a}]}),angular.module("w69b.chromeCapture",["w69b.promiseTool","w69b.webrtc"]).factory("chromeCapture",["promiseTool","webrtc","$q",function(e,t,r){var n={};return n.tabCapture=function(){return chrome.tabCapture?e.wrapChromeError(chrome.tabCapture.capture,chrome.tabCapture).apply(null,arguments):r.reject("tabCapture permission missing")},chrome.desktopCapture&&(n.chooseDesktopMedia=function(){function t(e){chrome.desktopCapture.cancelChooseDesktopMedia(i),o.reject(e||"cancelled")}e.wrapChromeError(chrome.desktopCapture.chooseDesktopMedia,chrome.desktopCapture);var n=Array.prototype.slice.call(arguments,0),o=r.defer();n.push(function(e){chrome.runtime.lastError?o.reject(chrome.runtime.lastError):o.resolve(e)});var i=chrome.desktopCapture.chooseDesktopMedia.apply(chrome.desktopCapture,n);return{promise:o.promise,cancel:t}}),n.desktopCapture=function(e){var r={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:1920,maxHeight:1200}}};return t.getUserMedia(r)},n}]),angular.module("w69b.chromeCommands",["w69b.promiseTool"]).factory("chromeCommands",["promiseTool",function(e){var t={};return t.getAll=e.wrapChromeError(chrome.commands.getAll,chrome.commands),t.onCommand=chrome.commands.onCommand,t}]),angular.module("w69b.chromePersistentLogger",["w69b.chromeStorage","w69b.logging","w69b.structs.CircularBuffer"]).provider("chromePersistentLogger",["$logProvider",function(e){function t(e,t){var n={level:e,args:t,timestamp:(new Date).getTime()};return r?r.add(n):o.push(n),!0}var r,n="logs",o=[],i=!1,a=1e3,c="logs_",u=!1,s=!0;this.setStorageKey=function(e){n=e},this.setMaxNumLogs=function(e){a=e},this.enableAutoLoad=function(e){i=e},this.enableAutoSave=function(e){s=e},this.enableGlobalHandler=function(e){u=e},this.install=function(){this.enableAutoLoad(!0),e.setCustomHook(t)},this.$get=["$window","$q","chromeStorage","CircularBuffer","$log",function(e,l,d,f,p){function h(e){var t=e.args.map(function(e){if(!angular.isObject(e))return e;try{return angular.toJson(e)}catch(t){return e}});return[new Date(e.timestamp).toISOString(),e.level.toUpperCase(),t.join(", ")].join(" ")}function g(e){var t=new f(a);return e.forEach(function(e){t.add(e)}),t}var m={};return m.load=function(){return d.local.getSingle(c+n).then(function(e){e&&e.length&&(r=g(e.concat(m.getEntries())))})},m.save=function(e){return d.local.setSingle(c+(e||n),m.getEntries())},m.clear=function(){r.clear()},m.getEntries=function(){return r.getValues()},m.getLogs=function(){return m.getEntries().map(h)},m.getMergedLogs=function(e){return e=e.map(function(e){return c+e}),d.local.get(e).then(function(e){var t=[];return angular.forEach(e,function(e,r){e&&e.length&&e.forEach(function(e){e.storageKey=r.substr(c.length),t.push(e)})}),t.sort(function(e,t){return e.timestamp-t.timestamp}),t.map(function(e){return"["+e.storageKey+"] "+h(e)})})},m.hookFn=t,r=g(o),o=null,i&&m.load(),u&&(e.onerror=function(e,t,r){p.error("global error",e,t,r)}),s&&e.addEventListener("unload",function(){m.save()}),m}]}]).run(["chromePersistentLogger",angular.noop]),angular.module("w69b.chromeRuntime",["w69b.promiseTool"]).factory("chromeRuntime",["promiseTool",function(e){var t={};return t.sendMessage=e.wrapChromeError(chrome.runtime.sendMessage,chrome.runtime),t.getBackgroundPage=e.wrapChromeError(chrome.runtime.getBackgroundPage,chrome.runtime),t.connect=chrome.runtime.connect.bind(chrome.runtime),t.getManifest=chrome.runtime.getManifest.bind(chrome.runtime),t.id=chrome.runtime.id,chrome.runtime.getPlatformInfo&&(t.getPlatformInfo=e.wrapChromeError(chrome.runtime.getPlatformInfo,chrome.runtime)),t.setUninstallURL=e.wrapChromeError(chrome.runtime.setUninstallURL,chrome.runtime),["onMessage","onMessageExternal","onConnect","onConnectExternal","onInstalled","onSuspend"].forEach(function(e){t[e]={addListener:function(t){chrome.runtime[e].addListener(t)},removeListener:function(t){chrome.runtime[e].removeListener(t)}}}),t}]),angular.module("w69b.chromeStorage",["w69b.promiseTool"]).factory("chromeStorage",["promiseTool",function(e){var t=chrome.storage,r={};return["local","sync","managed"].forEach(function(n){r[n]={},["set","get","remove","clear"].forEach(function(o){r[n][o]=e.wrapChromeError(t[n][o],t[n])}),r[n].setSingle=function(e,t){var o={};return o[e]=t,r[n].set(o)},r[n].getSingle=function(e,t){return r[n].get(e).then(function(r){return r.hasOwnProperty(e)?r[e]:t})}}),r.onChanged=t.onChanged,r}]),angular.module("w69b.chromeTabs",["w69b.promiseTool"]).factory("chromeTabs",["$window","promiseTool","$q",function(e,t,r){if(!e.chrome||!e.chrome.tabs)return null;var n=e.chrome,o={};return o.query=t.wrapChromeError(n.tabs.query,n.tabs),o.getActiveTab=function(){return o.query({active:!0,windowId:n.windows.WINDOW_ID_CURRENT}).then(function(e){return e.length?e[0]:r.reject()})},o.get=t.wrapChromeError(n.tabs.get,n.tabs),o.update=t.wrapChromeError(n.tabs.update,n.tabs),o.remove=t.wrapChromeError(n.tabs.remove,n.tabs),o.create=t.wrapChromeError(n.tabs.create,n.tabs),o.connect=n.tabs.connect.bind(n.tabs),o.setZoomSettings=t.wrapChromeError(n.tabs.setZoomSettings,n.tabs),o.setZoom=t.wrapChromeError(n.tabs.setZoom,n.tabs),o.executeScript=t.wrapChromeError(n.tabs.executeScript,n.tabs),o.insertCSS=t.wrapChromeError(n.tabs.insertCSS,n.tabs),o.sendMessage=t.wrapChromeError(n.tabs.sendMessage,n.tabs),o.onUpdated=n.tabs.onUpdated,o.onActivated=n.tabs.onActivated,o.sendMessageActive=function(e,t){return o.getActiveTab().then(function(r){return o.sendMessage(r.id,e,t)})},o}]).directive("newTab",["chromeTabs",function(e){return{restrict:"A",link:function(t,r,n){r.bind("click",function(t){t.preventDefault(),e.create({url:n.href}).then(function(e){chrome.windows.update(e.windowId,{focused:!0},angular.noop)})})}}}]),angular.module("w69b.chromeWindows",[]).factory("chromeWindows",["promiseTool",function(e){var t={};return t.get=e.wrapChromeError(chrome.windows.get,chrome.windows),t.create=e.wrapChromeError(chrome.windows.create,chrome.windows),t.update=e.wrapChromeError(chrome.windows.update,chrome.windows),t.getCurrent=e.wrapChromeError(chrome.windows.getCurrent,chrome.windows),t.remove=e.wrapChromeError(chrome.windows.remove,chrome.windows),t.onRemoved=chrome.windows.onRemoved,t}]),angular.module("w69b.filesHelper",["w69b.promiseTool"]).factory("filesHelper",["$window","promiseTool","$q",function(e,t,r){function n(e){var t=e.split("/"),r=t.slice(0,-1).join("/"),n=t.slice(-1)[0];return[r,n]}e.requestFileSystem=e.requestFileSystem||e.webkitRequestFileSystem;var o=window.PERSISTENT,i=104857600,a={},c=["readEntries","remove","getFile","getMetadata","moveTo","file","getDirectory","createWriter"];return c.forEach(function(e){a[e]=function(r){var n=[].slice.call(arguments,1);return t.wrapCallbacks(r[e],r).apply(null,n)}}),a.getFileSystem=function(r,n){return angular.isUndefined(r)&&(r=o),n=n||i,t.wrapCallbacks(e.requestFileSystem,e)(r,n)},a.getPersistentQuota=function(){var t=r.defer();return e.navigator.webkitPersistentStorage.queryUsageAndQuota(function(e,r){t.resolve({usage:e,quota:r})},function(e){t.reject(e)}),t.promise},chrome.system&&chrome.system.storage&&(a.getStorageInfo=t.wrapChromeError(chrome.system.storage.getInfo,chrome.system.storage)),a.getDirByPath=function(e,t){function n(e,o){return o.length?a.getDirectory(e,o[0],t||{}).then(function(e){return n(e,o.slice(1))}):r.when(e)}var o=e.split("/");return""===o[0]&&o.splice(0,1),a.getFileSystem().then(function(e){return n(e.root,o,t)})},a.moveFileByPath=function(e,t){var o=n(t),i=o[0],c=o[1];return r.all({file:a.getFileEntryByPath(e),targetDir:a.getDirByPath(i)}).then(function(e){return a.moveTo(e.file,e.targetDir,c)})},a.getFileEntryByPath=function(e,t,r){var o=n(e),i=o[0],c=o[1];return a.getDirByPath(i,r).then(function(e){return a.getFile(e,c,t||{})})},a.getFileByPath=function(e){return a.getFileEntryByPath(e).then(function(e){return a.file(e)})},a.removeByPath=function(e){return a.getFileEntryByPath(e).then(function(e){return a.remove(e)})},a.listByPath=function(e){return a.getDirByPath(e).then(function(e){var t=e.createReader();return a.readEntries(t)})},a.requestPersistentQuota=function(e){return t.wrapCallbacks(navigator.webkitPersistentStorage.requestQuota,navigator.webkitPersistentStorage)(e||i)},a.requestTemporaryQuota=function(e){return t.wrapCallbacks(navigator.webkitTemporaryStorage.requestQuota,navigator.webkitTemporaryStorage)(e||i)},a.writeFile=function(e,t){var n=r.defer();return e.onwriteend=n.resolve.bind(n),e.onerror=n.reject.bind(n),e.write(t),n.promise},a.isSupported=function(){return!!window.requestFileSystem},a}]),angular.module("w69b.googleHttpAuthInterceptor",[]).provider("googleHttpAuthInterceptor",function(){var e=0,t="googleauth";this.enableAuthAutoRetry=function(t){e=t?1:0},this.setAuthProvider=function(e){t=e},this.$get=["$q","$log","$injector",function(r,n,o){function i(){
return d||(d=o.get(t)),d}function a(e){return i().getAuthToken(e)}function c(e){return{Authorization:"Bearer "+e}}function u(){return l||(l=o.get("$http")),l}function s(t){var o=t.status;if(401==o&&t.config.googleAuth&&t.config.authAutoRetry!==!1){n.debug("auth error detected",t);var i=angular.copy(t.config);if(i.authRetryCount?i.authRetryCount++:i.authRetryCount=1,i.authRetryCount<=e)return a({scopes:i.googleAuthScopes,validate:!0}).then(function(){return n.debug("googleAuthHttpInterceptor: auto-retrying with validated token"),u()(i)})}return r.reject(t)}var l,d;return{request:function(e){return e.googleAuth?a({scopes:e.googleAuthScopes}).then(function(t){return e.headers=angular.extend(e.headers||{},c(t)),e},function(e){return n.warn("googleAuthHttpInterceptor: no token, aborting request",e),r.reject("googleAuthFailed")}):e},responseError:s}}]}),angular.module("w69b.uuid",[]).factory("uuid",["$window",function(e){function t(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t}function r(){var r=new Uint16Array(8);return e.crypto.getRandomValues(r),t(r[0])+t(r[1])+"-"+t(r[2])+"-4"+t(r[3]).substring(1)+"-y"+t(r[4]).substring(1)+"-"+t(r[5])+t(r[6])+t(r[7])}return r}]),angular.module("w69b.uritool",[]).factory("uritool",function(){function e(e){return decodeURIComponent(e.replace(t," "))}var t=/\+/g,r={};return r.parseQuery=function(t,r){"?"==t[0]&&(t=t.substring(1));for(var n,o=/([^&=]+)=?([^&]*)/g,i={};n=o.exec(t);){var a=e(n[1]),c=e(n[2]);r&&i.hasOwnProperty(a)?i[a].push(c):i[a]=r?[c]:c}return i},r.parseUrl=function(e){var t=document.createElement("a");return t.href=e,{protocol:t.protocol.replace(":",""),host:t.hostname,port:t.port,query:t.search,hash:t.hash,path:t.pathname}},r.encodeQuery=function(e){var t=[];return angular.forEach(e,function(e,r){angular.isArray(e)?angular.forEach(e,function(e){t.push(encodeURIComponent(r)+(e===!0?"":"="+encodeURIComponent(e)))}):t.push(encodeURIComponent(r)+(e===!0?"":"="+encodeURIComponent(e)))}),t.length?t.join("&"):""},r}),angular.module("w69b.googleUploader",["w69b.ngProgressHttp"]).factory("googleUploader",["$progressHttp","$http","$q","$timeout","$log",function(e,t,r,n,o){function i(e,t){var o=e.headers("Retry-After");if(o&&f)o=Math.min(l,1e3*Number(o));else{if(!t)return r.when(e);o=t}return n(angular.noop,o).then(function(){return e})}function a(e){return e.data}function c(n,o){function c(e){return!g&&l&&308===e.status?s():d&&!g&&l&&(e.status<=0||e.status>=500&&e.status<=599||e.config&&e.config.authAutoRetry===!1&&401===e.status)?i(e,2e3).then(s):r.reject(e)}function u(t){if(308==t.status){var i,a=t.headers("Range");i=a?Number(a.match(/bytes=0-(\d+)/)[1])+1:0;var c=Math.min(n.size,h),u=Math.min(i+c,n.size)-1,s="bytes "+i+"-"+u+"/"+n.size,d=angular.extend({},o,{url:l,method:"PUT",progressEvents:"upload",transformRequest:null,data:n.slice(i,u+1),googleAuth:!0,authAutoRetry:!1,timeout:p});return d.headers=angular.extend({},d.headers,{"Content-Type":n.type,"Content-Range":s}),e(d).then(null,null,function(e){return e=e.event,{loaded:e.loaded+i,total:n.size}})}return 200==t.status?t:r.reject(t)}function s(){var e=angular.extend({},o,{timeout:p,googleAuth:!0});return e.headers=angular.extend({},e.headers,{"Content-Range":"bytes */"+n.size}),t.put(l,"",e).then(i,i).then(u)["catch"](c)}var l=null,f=r.defer(),p=f.promise,g=!1,m={};return m.start=function(e,i,u){u=angular.extend({},o,u),angular.extend(u.headers||{},{"X-Upload-Content-Length":n.size,"X-Upload-Content-Type":"video/*"}),u.googleAuth=!0,u.timeout=p;var d=r.defer();return t.post(e,i,u).then(function(e){return l=e.headers("Location"),d.notify({uploadUrl:l}),s()})["catch"](c).then(d.resolve.bind(d),d.reject.bind(d),d.notify.bind(d)),m.promise=d.promise.then(a),m.promise},m.resume=function(e){return l=e,m.promise=s().then(a),m.promise},m.cancel=function(){g=!0,f.resolve()},m}var u="https://www.googleapis.com/upload/youtube/v3/videos",s="https://www.googleapis.com/upload/drive/v2/files?uploadType=resumable",l=6e4,d=!0,f=!0,p=1073741824,h=1*p,g={};return g.setAutoResumeEnabled=function(e){d=e},g.setRespectRetryAfterHeader=function(e){f=e},g.setMaxChunkSize=function(e){h=e},g.resumeUpload=function(e,t,r){var n=c(e,r);return n.resume(t),n},g.youtubeUpload=function(e,t,r){t=t||{},t.privacy||(t.privacy="public");var n={snippet:{title:t.title||e.name,description:t.description||""},status:{privacyStatus:t.privacy}},o={params:{part:Object.keys(n).join(","),uploadType:"resumable"}};return g.upload(u,e,n,r,o)},g.driveUpload=function(e,t,r){return g.upload(s,e,t,r)},g.upload=function(e,t,r,n,o){var i=c(t,n);return i.start(e,r,o),i},g}]),angular.module("w69b.logging",[]).provider("$log",function(){var e=!0,t=this,r=!1;this.debugEnabled=function(t){return angular.isDefined(t)?(e=t,this):e},this.setCustomHook=function(e){r=e},this.$get=["$window",function(n){function o(e){return e instanceof Error&&(e.stack?e=e.message&&e.stack.indexOf(e.message)===-1?"Error: "+e.message+"\n"+e.stack:e.stack:e.sourceURL&&(e=e.message+"\n"+e.sourceURL+":"+e.line)),e}function i(e){var t=n.console||{},i=t[e]||t.log||angular.noop,a=!1;try{a=!!i.apply}catch(c){}return a?function(){var n=[];if(angular.forEach(arguments,function(e){n.push(o(e))}),r&&r(e,n))return i.apply(t,n)}:function(t,n){r&&r(e,[t,n])&&i(t,null===n?"":n)}}return{log:i("log"),info:i("info"),warn:i("warn"),error:i("error"),debug:function(){var r=i("debug");return function(){e&&r.apply(t,arguments)}}()}}]}),angular.module("w69b.ngProgressHttp",[]).service("$progressHttp",["$http","$q",function(e,t){function r(r){r.headers=r.headers||{},r.method=r.method||"POST";var n,o=t.defer();r.headers.__setXHR__=function a(){return function(e){return e?(n=e,r.progressEvents&&"download"!==r.progressEvents||(n.addEventListener("progress",function(e){o.notify({type:"download",event:e})},!1),n.addEventListener("load",function(e){e.lengthComputable&&o.notify({type:"download",event:e})},!1)),void(r.progressEvents&&"upload"!==r.progressEvents||(n.upload.addEventListener("progress",function(e){o.notify({type:"upload",event:e})},!1),n.upload.addEventListener("load",function(e){e.lengthComputable&&o.notify({type:"upload",event:e})},!1)))):a()}},e(r).then(o.resolve.bind(o),o.reject.bind(o),o.notify.bind(o));var i=o.promise;return i.abort=function(){return n&&n.abort(),i},i}return r}]).config(function(){window.XMLHttpRequest=function(e){return function(){var t=new e;return t.setRequestHeader=function(e){return function(r,n){"__setXHR__"===r?n(t):e.apply(t,arguments)}}(t.setRequestHeader),t}}(window.XMLHttpRequest)}),angular.module("w69b.pnaclModule",[]).factory("pnaclModule",["$q","$log","$timeout",function(e,t,r){function n(n,i,a){function c(){g.addEventListener("crash",s,!0),g.addEventListener("message",l,!0)}function u(){g.removeEventListener("message",l,!0),g.removeEventListener("crash",s,!0)}function s(){t.error("pnacl module crashed",v.lastError),m.onCrash&&m.onCrash(v.lastError)}function l(e){m.onMessage&&m.onMessage(e)}var d=i?"pnacl":"nacl",f=["<embed ","width=0 height=0 ",'src="'+n+'" ','ps_tty_prefix="ps:" ps_stdout="/dev/tty" ps_stderr="/dev/tty" type="application/x-'+d+'" />'].join("");a||(a=document.body);var p,h,g=document.createElement("div"),m={isLoaded:!1};m.onMessage=void 0,m.onCrash=void 0;var v;return m.load=function(){function t(){g.removeEventListener("load",n,!0),g.removeEventListener("error",i,!0)}function n(){t(),u.resolve()}function i(){t(),u.reject(v.lastError)}if(p)return p;var u=e.defer();g.addEventListener("load",n,!0),g.addEventListener("error",i,!0),c(),h=r(function(){u.reject("load_timeout")},o),g.innerHTML=f,v=g.children[0],a.appendChild(g),g.focus(),p=u.promise,p["finally"](function(){r.cancel(h),h=null});var s=p;return p["catch"](function(){m.unload()}),s},m.unload=function(){m.isLoaded=!1,u(),g.innerHTML="",a.removeChild(g),v=null,p=null},m.getElement=function(){return v},m.postMessage=function(e){if(!v)throw new Error("not loaded");v.postMessage(e)},m}var o=8e3;return n}]),angular.module("w69b.pnaclVideoEncoder",["w69b.pnaclModule"]).factory("pnaclVideoEncoder",["pnaclModule","$q","$log","$rootScope","$timeout",function(e,t,r,n,o){function i(i,a){function c(){m={state:"inactive",time:0}}function u(){b.unload(),c()}function s(e){m=e}function l(e){u(),y&&y.reject(e),y=null}function d(e){r.error("pnaclVideoEncoderError",e),l(e),S.onError&&S.onError(e)}function f(e){l(),S.onCrash&&S.onCrash(e)}function p(){return Number((/Chrome\/(\d+)/.exec(window.navigator.userAgent)||[void 0,0])[1])}function h(e,t){b.postMessage({type:e,data:t||{}})}function g(e,r){if(y)throw new Error("there is still a pending operation");return y=t.defer(),e&&h(e,r),y.promise}var m,v,b=e(i,a),y=null,w=8e3,x=["start","stop","pause","resume","replaceTracks"],S={};return b.onMessage=function(e){if(e=e.data,x.indexOf(e.type)>=0){if(!y)return;e.data?y.reject(e.data):y.resolve(),y=null}else if("error"==e.type)d(e.data),n.$$phase||n.$digest();else if("state"==e.type)s(e.data),n.$$phase||n.$digest();else if("stack_trace"==e.type)f(e.data);else{var t;e.data&&(t=e.data,t.trim&&(t=t.trim())),r.debug(e.type,t)}},S.onCrash=void 0,b.onCrash=f,S.stop=function(){return g("stop").then(function(){u()})},S.load=function(){return b.load()["catch"](function(e){return r.warn("original pnacl.load error: ",e),t.reject("nacl_load")})},S.getState=function(){return m.state},S.getStateObj=function(){return m},S.getFPS=function(){return m.fps},S.getCurrentTime=function(){return m.time},S.replaceTracks=function(e){return g("replaceTracks",e)},S.pause=function(){return g("pause")},S.resume=function(){return g("resume")},S.hasPendingOperation=function(){return!!y},S.start=function(e,t){if(!e)throw new Error("invalid filename");e="/html5_persistent/"+e;var r=g();return v=o(function(){d("start_timeout")},w),b.load().then(function(){var n=angular.extend({},t,{filename:e,chromeVersion:p()});return h("start",n),r})["finally"](function(){o.cancel(v),v=null})},c(),S}return i}]),angular.module("w69b.promiseTool",[]).factory("promiseTool",["$q","$timeout",function(e,t){var r={};return r.wrapChromeError=function(t,r){return function(){var n=Array.prototype.slice.call(arguments,0),o=e.defer();return n.push(function(e){chrome.runtime.lastError?o.reject(chrome.runtime.lastError):o.resolve(e)}),t.apply(r,n),o.promise}},r.wrapCallbacks=function(t,r){return function(){var n=Array.prototype.slice.call(arguments,0),o=e.defer();return n.push(o.resolve.bind(o)),n.push(o.reject.bind(o)),t.apply(r,n),o.promise}},r.serializer=function(){var t=null,r=function(r){var n=e.defer();return(t||e.when())["finally"](function(){var e=r.call();n.resolve(e)}),t=n.promise,t["finally"](function(){t=null}),n.promise};return r.wrap=function(e){return function(){return r(e.bind.apply(e,[this].concat(Array.prototype.slice.call(arguments))))}},r},r.withTimeout=function(r,n,o){o||(o=angular.noop);var i=e.defer(),a=t(function(){var e=o();angular.isDefined(e)?i.resolve(e):i.reject("timeout"),i=null},n),c=r(),u=i.promise;return c["finally"](function(){t.cancel(a),a=null}),c.then(function(){i&&i.resolve.apply(i,arguments)},function(){i&&i.reject.apply(i,arguments)}),u},r}]),angular.module("w69b.streamedVideo",[]).factory("streamedVideo",["$q",function(e){return function(){function t(){a.onEnded&&a.onEnded()}var r,n,o,i=document.createElement("video"),a={onEnded:null};return a.stop=function(){n&&(i.pause(),i.src="",window.URL.revokeObjectURL(r),n.removeEventListener("ended",t),n.stop(),n=null,o=!1)},a.load=function(c){if(n)throw new Error;n=c;var u=e.defer();return c.addEventListener("ended",t),r=window.URL.createObjectURL(c),i.addEventListener("canplay",function s(){i.removeEventListener("canplay",s),i.play(),0===i.videoHeight||0===i.videoWidth?(a.stop(),u.reject("loading video failed")):(o=!0,u.resolve())}),i.addEventListener("error",function l(){i.removeEventListener("error",l),a.stop(),u.reject(i.error)}),i.src=r,i.volume=0,u.promise},a.isLoaded=function(){return o},a.getVideoElement=function(){return i},a}}]),angular.module("w69b.structs.CircularBuffer",[]).factory("CircularBuffer",function(){var e=function(e){this.maxSize_=e||100,this.buff_=[]},t=e.prototype;return t.nextPtr_=0,t.add=function(e){this.buff_[this.nextPtr_]=e,this.nextPtr_=(this.nextPtr_+1)%this.maxSize_},t.get=function(e){return e=this.normalizeIndex_(e),this.buff_[e]},t.set=function(e,t){e=this.normalizeIndex_(e),this.buff_[e]=t},t.getCount=function(){return this.buff_.length},t.isEmpty=function(){return 0===this.buff_.length},t.clear=function(){this.buff_.length=0,this.nextPtr_=0},t.getValues=function(){return this.getNewestValues(this.getCount())},t.getNewestValues=function(e){for(var t=this.getCount(),r=this.getCount()-e,n=[],o=r;o<t;o++)n.push(this.get(o));return n},t.getKeys=function(){for(var e=[],t=this.getCount(),r=0;r<t;r++)e[r]=r;return e},t.containsKey=function(e){return e<this.getCount()},t.containsValue=function(e){for(var t=this.getCount(),r=0;r<t;r++)if(this.get(r)==e)return!0;return!1},t.getLast=function(){return 0===this.getCount()?null:this.get(this.getCount()-1)},t.normalizeIndex_=function(e){if(e>=this.buff_.length)throw Error("Out of bounds exception");return this.buff_.length<this.maxSize_?e:(this.nextPtr_+Number(e))%this.maxSize_},e}),angular.module("w69b.spawn",[]).factory("spawn",["$q",function(e){function t(t,r){function n(e,t){var r;try{r=e(t)}catch(n){return o(n)}return r.done?i(r.value):i(r.value).then(c,u)}var o=r?Promise.reject.bind(Promise):e.reject.bind(e),i=r?Promise.resolve.bind(Promise):e.when.bind(e),a=t(),c=n.bind(null,a.next.bind(a)),u=n.bind(null,a["throw"].bind(a));return c()}return t.wrap=function(e){return function(){var r=arguments;return t(e.bind.apply(e,[this].concat(_toConsumableArray(r))))}},t}]),angular.module("w69b.throttle",[]).factory("throttle",["$timeout",function(e){function t(t,r,n){var o,i,a;n=n!==!1;var c=function(){return a=angular.copy(arguments,[]),i=function(){return o=null,i=null,t.apply(null,a)},n?(o&&e.cancel(o),o=e(i,r)):o||(o=e(i,r)),o};return c.flush=function(){o&&(e.cancel(o),i())},c}return t}]),angular.module("w69b.webrtc",["w69b.promiseTool","w69b.spawn"]).factory("webrtc",["promiseTool","$window","$q","spawn",function(e,t,r,n){function o(e){return e.some(function(e){return!!e.label})}var i={},a=t.navigator;return i.getUserMedia=e.wrapCallbacks(a.getUserMedia||a.webkitGetUserMedia||a.mozGetUserMedia||a.msGetUserMedia,a),a.mediaDevices&&a.mediaDevices.enumerateDevices?i.getSources=function(){return r.when(a.mediaDevices.enumerateDevices()).then(function(e){return e.filter(function(e){return e.kind.endsWith("input")}).map(function(e){var t={id:e.deviceId,label:e.label};return t.kind=e.kind.substring(0,e.kind.length-5),t})})}:i.getSources=e.wrapCallbacks(MediaStreamTrack.getSources,MediaStreamTrack),i.getSourcesByKind=function(e){return i.getSources().then(function(t){return t.filter(function(t){return t.kind===e})})},i.getVideoSources=function(){return i.getSourcesByKind("video")},i.getAudioSources=function(){return i.getSourcesByKind("audio")},i.hasCamera=function(){return i.getVideoSources().then(function(e){return e.length>0})},i.hasMicrophone=function(){return i.getAudioSources().then(function(e){return e.length>0})},i.hasVideoAccess=function(){return i.getVideoSources().then(o)},i.hasAudioAccess=function(){return i.getAudioSources().then(o)},i.getCameraAndMicPermission=n.wrap(regeneratorRuntime.mark(function c(){var e,t,r,n;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,i.hasCamera();case 2:return e=o.sent,t=!1,r=!1,o.prev=5,o.next=8,i.getUserMedia({audio:!0,video:e});case 8:n=o.sent,r=!!n.getVideoTracks().length,t=!!n.getAudioTracks().length,n.getTracks().forEach(function(e){e.stop()}),o.next=16;break;case 14:o.prev=14,o.t0=o["catch"](5);case 16:return o.abrupt("return",{video:r,audio:t});case 17:case"end":return o.stop()}},c,this,[[5,14]])})),i}]),angular.module("w69b.clipboard",[]).factory("clipboard",["$document",function(e){var t={};return t.copy=function(t){var r=angular.element("<textarea></textarea>");r.text(t),e.find("body").append(r),r[0].select(),e[0].execCommand("copy"),r.remove()},t}]),angular.module("w69b.googledrive",[]).factory("googledrive",["$q","googleauth","$location","$interval","$http",function(e,t,r,n,o){function i(e){return e.data}function a(e,t){return o.get(l+e,{googleAuth:!0,params:t}).then(i)}function c(e,t){return o.post(l+e,t,{googleAuth:!0}).then(i)}function u(e,t){return o({method:"PATCH",url:l+e,data:t,googleAuth:!0}).then(i)}var s=!1,l="https://www.googleapis.com/drive/v2/",d={};return d.isLoaded=function(){return s},d.loadLibs=function(){if(s)return e.when(null);var r=t.loadClient().then(function(){return e.all([t.gapiLoad("picker")])});return r.then(function(){s=!0})},d.getFile=function(e){return a("files/"+e)},d.listFiles=function(e){return a("files/",e).then(function(e){return e.items})},d.postFile=function(e){return c("files",e)},d.patchFile=function(e,t){return u("files/"+e,t)},d.trashFile=function(e){return c("files/"+e+"/trash")},d.getAbout=function(){return a("about")},d.showShareSettings=function(r){return t.gapiLoad("drive-share").then(function(){var o=new gapi.drive.share.ShareClient(t.getAppId());o.setItemIds([r]),o.showSettingsDialog();var i=e.defer(),a=n(function(){for(var e=!1,t=document.activeElement;t!==document.documentElement;){if(t.classList.contains("dcs-ad-dcs-c")){e=!0;break}t=t.parentNode}e||(n.cancel(a),i.resolve())},300);return i.promise})},d.listPermissions=function(e){return a("files/"+e+"/permissions").then(function(e){return e.items})},d.insertPermission=function(e,t){return o.post(l+"files/"+e+"/permissions",t,{googleAuth:!0}).then(i)},d.patchPermission=function(e,t,r){return u("files/"+e+"/permissions/"+t,r)},d.removePermission=function(e,t){return o["delete"](l+"files/"+e+"/permissions/"+t,{googleAuth:!0}).then(i)},d.getContextAction=function(){var e=r.search().state,t=null;if(angular.isString(e))try{t=JSON.parse(e)}catch(n){}if(t){var o=t.ids||[],i=t.exportIds||[];return{action:t.action,ids:o.concat(i),parentId:t.parentId,userId:t.userId}}return null},d}]),angular.module("w69b.chromeVersionOrder",[]).factory("chromeVersionOrder",function(){var e=[];return e.isLess=function(e,t){function r(e){return e.split(".").map(function(e){return Number(e)})}for(var n=r(e),o=r(t),i=0;i<Math.max(n.length,o.length);++i){if((n[i]||0)<(o[i]||0))return!0;if((n[i]||0)>(o[i]||0))return!1}return!1},e.isEqual=function(t,r){return!e.isLess(t,r)&&!e.isLess(r,t)},e.isLessOrEqual=function(t,r){return e.isLess(t,r)||e.isEqual(t,r)},e}),angular.module("w69b.chromeAlarms",["w69b.promiseTool"]).factory("chromeAlarms",["promiseTool",function(e){var t={};return t.create=chrome.alarms.create.bind(chrome.alarms),["get","getAll","clear","clearAll"].forEach(function(r){t[r]=e.wrapChromeError(chrome.alarms[r],chrome.alarms)}),t.onAlarm=chrome.alarms.onAlarm,t}]),angular.module("w69b.chromeNotifications",["w69b.promiseTool"]).factory("chromeNotifications",["promiseTool",function(e){function t(e){var t=c[e];t&&t.onClicked&&t.onClicked()}function r(e,t){var r=c[e];r&&r.onButtonClicked&&r.onButtonClicked(t)}function n(e,t){var r=c[e];r&&(r.onClosed&&r.onClosed(t),delete c[e],Object.keys(c).length||i())}function o(){a.onClicked.addListener(t),a.onButtonClicked.addListener(r),a.onClosed.addListener(n)}function i(){a.onClicked.removeListener(t),a.onButtonClicked.removeListener(r),a.onClosed.removeListener(n)}var a={},c={};return a.simple={},a.simple.defaultOptions={},a.simple.create=function(t,r){var n=e.serializer(),i={};return t=angular.extend({},a.simple.defaultOptions,t),n(function(){return a.create(r||"",t).then(function(e){i.id=e,Object.keys(c).length||o(),c[e]=i})}),i.clear=function(){n(function(){return a.clear(i.id)})},i.update=function(e){n(function(){return a.update(i.id,e)})},i.onClicked=angular.noop,i.onButtonClicked=angular.noop,i.onClosed=angular.noop,i},["clear","create","update","getAll","getPermissionLevel"].forEach(function(t){a[t]=e.wrapChromeError(chrome.notifications[t],chrome.notifications)}),["onClosed","onClicked","onButtonClicked","onPermissionLevelChanged","onShowSettings"].forEach(function(e){a[e]=chrome.notifications[e]}),a}]),angular.module("w69b.asyncResponse",[]).factory("asyncResponse",["$q",function(e){var t={};return t.createSender=function(t){var r={},n=0,o={};return r.sendWithResponse=function(r,i){var a=++n,c=e.defer();return o[a]=c,t({type:r,data:i,msgId:a}),c.promise},r.send=function(e,r){t({type:e,data:r})},r.handleResult=function(e){if(e&&"result"===e.type){var t=o[e.msgId];return delete o[e.msgId],e.hasOwnProperty("error")||e.isError?t.reject(e.error):t.resolve(e.data),!0}return!1},r},t.createRespond=function(t){return function(r,n){e.when(r).then(function(e){t({type:"result",msgId:n.msgId,data:e})},function(e){t({type:"result",msgId:n.msgId,error:e,isError:!0})})}},t}]),angular.module("w69b.ui.bytesFilter",[]).filter("bytes",["$injector",function(e){function t(t,n){return r||(r=e.get("$filter")("number")),r(t,n)}var r;return function(e,r){if(!angular.isNumber(e))return"-";if(angular.isUndefined(r)&&(r=1),e<=0)return"0 B";var n=["B","KB","MB","GB","TB","PB"],o=Math.floor(Math.log(e)/Math.log(1024));return t(e/Math.pow(1024,Math.floor(o)),r)+" "+n[o]}}]),angular.module("w69b.chromePermissions",["w69b.promiseTool"]).factory("chromePermissions",["promiseTool",function(e){var t=window.chrome&&window.chrome.permissions,r={};return t?(r.contains=e.wrapChromeError(t.contains,t),r.request=e.wrapChromeError(t.request,t),r.remove=e.wrapChromeError(t.remove,t),r.getAll=e.wrapChromeError(t.getAll,t),r):r}]),angular.module("w69b.chromeSystem",["w69b.promiseTool"]).factory("chromeSystem",["promiseTool",function(e){var t=window.chrome&&window.chrome.system,r={};return t?(t.cpu&&(r.cpu={getInfo:e.wrapChromeError(t.cpu.getInfo,t.cpu)}),t.memory&&(r.memory={getInfo:e.wrapChromeError(t.memory.getInfo,t.memory)}),r):r}]),angular.module("castifyExt.bgApp",["w69b.es6","castifyExt.commonConfig","castifyExt.bgRecord","castifyExt.bgUpload","w69b.chromePersistentLogger","castifyExt.recordingHooks","castifyExt.updateMigrationService","castifyExt.diskSpaceWatcher","castifyExt.licenseEnforcer","castifyExt.bgMessages","castifyExt.driveFileWatcher","castifyExt.bgFiles","castifyExt.bgSyncManager","castifyExt.syncNotifications","castifyExt.authConfig","castifyEdit.bgEditJobScheduler","castifyEdit.editNotifications","w69b.chromeNotifications","castifyExt.connect.bgConnectService","castifyExt.bgSyncDownloader","castifyExt.bgCastifyAuth","castifyExt.bgUserAccount"]).config(["analyticsProvider","chromePersistentLoggerProvider","chromeVideoRecorderProvider","bgCastifyAuthProvider","deployConfigProvider",function(e,t,r,n,o){r.setEncoderUrl("manifest_encoder.nmf",!1),t.setStorageKey("background"),t.enableGlobalHandler(!0),t.enableAutoSave(!1),t.install(),n.setClientId(o.clientId),n.setScopes(o.scopes),n.setRedirectUri(o.redirectUri)}]).run(["bgRecordService","bgUploadService","analytics","$log","bgMessages","$q","recordingHooks","updateMigrationService","diskSpaceWatcher","licenseEnforcer","driveFileWatcher","bgFiles","googleUploader","chromePersistentLogger","chromeRuntime","bgSyncManager","syncNotifications","onlineState","bgEditJobScheduler","editNotifications","chromeNotifications","bgConnectService","bgSyncDownloader","bgCastifyAuth","bgUserAccount",function(e,t,r,n,o,i,a,c,u,s,l,d,f,p,h,g,m,v,b,y,w,x,S,E,k){w.simple.defaultOptions={type:"basic",priority:2,iconUrl:"images/icon128.png"},f.setAutoResumeEnabled(!1),f.setRespectRetryAfterHeader(!1),a.install(),E.install(),i.all([g.install(),e.install(),t.install(),c.install(),u.install(),s.install(),o.install(),l.install(),d.install(),m.install(),b.install(),y.install(),x.install(),S.install(),k.install()])["finally"](function(){o.initializationCompleted()}),v.check(),h.onSuspend.addListener(function(){"inactive"===e.getRecorderState().state&&p.save()}),h.setUninstallURL("https://api.screencastify.com/api/on_uninstall")}]),e()}();